<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBUA512 – Interactive Slides</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overflow: hidden;
        }

        /* Slide container */
        .slides {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .slide {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: #fff;
            padding: 60px 80px;
            overflow: auto;
        }
        .slide.active { display: flex; flex-direction: column; }
        .slide.lead {
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
        }
        .slide.lead h1 { font-size: 3em; margin-bottom: 0.3em; }
        .slide.lead p { font-size: 1.3em; color: #aaa; }

        .slide h1 { font-size: 2.2em; color: #333; margin-bottom: 0.5em; border-bottom: 3px solid #0984e3; padding-bottom: 0.3em; }
        .slide h2 { font-size: 1.6em; color: #444; margin: 0.5em 0; }
        .slide p, .slide li { font-size: 1.3em; line-height: 1.6; color: #555; }
        .slide ul { margin-left: 1.5em; margin-top: 0.5em; }
        .slide li { margin: 0.4em 0; }
        .slide code { background: #f1f2f6; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        .nav button {
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .nav button:hover { background: rgba(0,0,0,0.8); }
        .nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .page-num {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #888;
            font-size: 14px;
            z-index: 100;
        }

        /* Smart Plot Widget */
        .smart-plot {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
            max-height: calc(100vh - 200px);
        }
        .sp-header {
            background: #2d3436;
            color: #fff;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .sp-header .title { font-size: 12px; color: #b2bec3; }
        .sp-btn {
            background: #0984e3;
            border: none;
            color: #fff;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .sp-btn:hover:not(:disabled) { background: #0773c7; }
        .sp-btn:disabled { background: #636e72; cursor: not-allowed; }
        .sp-content {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        .sp-editor {
            width: 100%;
            height: 100%;
            min-height: 500px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
        }
        .sp-editor:focus { outline: none; background: #1a1a1a; }
        .sp-editor.hidden { display: none; }
        .sp-output {
            display: none;
            background: #fafafa;
            height: 100%;
            min-height: 500px;
            padding: 20px;
            overflow: auto;
        }
        .sp-output.active { display: flex; justify-content: center; align-items: center; }
        .sp-output.active.text-output { display: block; }
        .sp-output canvas { max-width: 100%; max-height: 100%; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sp-output pre {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 15px;
            overflow: auto;
            font-family: "SF Mono", Monaco, "Courier New", monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap !important;
            word-wrap: break-word;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: left;
            box-sizing: border-box;
        }
        pre.r-text-output {
            display: block !important;
            width: 100% !important;
            height: auto !important;
            min-height: 100% !important;
            margin: 0 !important;
            padding: 20px !important;
            overflow: auto !important;
            font-family: "SF Mono", Monaco, "Courier New", monospace !important;
            font-size: 13px !important;
            line-height: 1.6 !important;
            white-space: pre !important;
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-radius: 8px !important;
            text-align: left !important;
            box-sizing: border-box !important;
        }
        .sp-status {
            background: #dfe6e9;
            padding: 6px 12px;
            font-size: 11px;
            color: #636e72;
            flex-shrink: 0;
        }
        .sp-status.loading { color: #e17055; }
        .sp-status.error { color: #d63031; }
        .sp-status.success { color: #00b894; }
        .loader {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="slides">
        <!-- Slide 1: Title -->
        <div class="slide lead active">
            <h1>MBUA512 – Databases and Analytics</h1>
            <p>Week 9: Correlation & Regression</p>
            <p style="margin-top: 1em; font-size: 1em;">Markus Luczak-Roesch &amp; Bogdan State</p>
        </div>

        <!-- Slide 2: Multivariate Analysis Interstitial -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="multivariate_analysis_3d_background.svg" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
                <h1 style="font-size: 5em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.5); margin: 0; font-weight: 300; letter-spacing: 0.05em;">Multivariate Analysis</h1>
            </div>
        </div>

        <!-- Slide: Multivariate Analysis Explanation -->
        <div class="slide" style="padding: 60px 80px;">
            <h1 style="font-size: 3em;">Multivariate Analysis</h1>
            <ul style="font-size: 2em; line-height: 1.6;">
                <li>Two or more measurements for each element ("high dimensional space")</li>
                <li>Shifting from averages, levels, variances to <strong>degree of relationships</strong></li>
                <li>Key concepts: <code>correlation</code> and <code>covariance</code></li>
            </ul>
        </div>

        <!-- Slide: Correlation Animation (Datasaurus - Full Screen) -->
        <div class="slide" id="correlationSlide" style="padding: 0; background: #fff; overflow: hidden;">
            <canvas id="correlationCanvas" style="display: block;"></canvas>
        </div>

        <!-- Slide: Correlation Basics -->
        <div class="slide" style="padding: 60px 80px;">
            <h1 style="font-size: 3em;">Correlation Basics</h1>
            <p style="font-size: 2em;">When we want to predict:</p>
            <ul style="font-size: 2em; line-height: 1.6;">
                <li>How long someone will live</li>
                <li>Whether the stock market will go up or down</li>
                <li>Whether a surgery will prolong a cancer patient's life</li>
                <li>Whether a person will make a productive employee</li>
                <li>Whether a marriage will survive or end in divorce</li>
            </ul>
        </div>

        <!-- Slide 3: Formulate a Clear Question -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300;">1. Formulate a Clear Question</h1>
        </div>

        <!-- Slide 4: Spurious Correlation Example -->
        <div class="slide" style="padding: 15px; background: #fff; justify-content: center; align-items: center;">
            <img src="spurious_correlation.svg" style="max-width: 98%; max-height: 92%; object-fit: contain;">
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">Source: <a href="https://tylervigen.com/spurious-correlations" style="color: #3498db;">Tyler Vigen, Spurious Correlations</a></p>
        </div>

        <!-- Slide 5: Interstitial with low poly background -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="low_poly_scene.svg" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
        </div>

        <!-- Slide 6: Confusing Question => Confusing Answer -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3em; color: #fff; font-weight: 300; margin: 0;">Confusing Question</h1>
            <p style="font-size: 4em; color: #f39c12; margin: 30px 0;">⇓</p>
            <h1 style="font-size: 3em; color: #fff; font-weight: 300; margin: 0;">Confusing Answer</h1>
        </div>

        <!-- Slide 7: Identify Two Variables Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300;">2. Identify Two Variables to Answer Your Question</h1>
        </div>

        <!-- Slide 8: Fun During vs Fun After -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <div style="display: flex; width: 100%; height: 100%;">
                <!-- Beach scene - Fun During -->
                <div style="flex: 1; position: relative; overflow: hidden;">
                    <img src="remapstudio-JWn5aBvSNSU-unsplash.svg" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
                        <h1 style="font-size: 4em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.8), 0 0 60px rgba(0,0,0,0.5); margin: 0; font-weight: 400;">Fun During</h1>
                    </div>
                </div>
                <!-- Mountain scene - Fun After -->
                <div style="flex: 1; position: relative; overflow: hidden;">
                    <img src="public-domain-vectors-weoy0jlwQcU-unsplash.svg" style="width: 100%; height: 100%; object-fit: cover;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
                        <h1 style="font-size: 4em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.8), 0 0 60px rgba(0,0,0,0.5); margin: 0; font-weight: 400;">Fun After</h1>
                    </div>
                </div>
            </div>
            <div style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; z-index: 20; font-size: 0.75em; color: rgba(255,255,255,0.7);">
                Illustrations by <a href="https://unsplash.com/@remapstudio?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" style="color: rgba(255,255,255,0.9);">remapstudio</a> and <a href="https://unsplash.com/@publicdomainvectors?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" style="color: rgba(255,255,255,0.9);">Public domain vectors</a> on <a href="https://unsplash.com" style="color: rgba(255,255,255,0.9);">Unsplash</a>
            </div>
        </div>

        <!-- Slide 9: Random Sample Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3.2em; color: #fff; font-weight: 300;">3. Get Information from a <em style="color: #f39c12;">Random Sample</em> of People</h1>
        </div>

        <!-- Slide 10: Are We Having Fun Yet GIF -->
        <div class="slide" style="padding: 0; background: #000; justify-content: center; align-items: center;">
            <img src="https://media1.tenor.com/m/0UJa-x2w3jsAAAAC/arewehavingfunyet.gif" alt="Are we having fun yet?" style="width: 100%; height: 100%; object-fit: cover;">
        </div>

        <!-- Slide 12: Sample Data Table -->
        <div class="slide" style="background: #fff; justify-content: center; align-items: center; padding: 40px;">
            <h2 style="margin-bottom: 30px; color: #333; font-weight: 400;">Sample of Collected Data</h2>
            <table style="border-collapse: collapse; font-size: 1.1em; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff;">
                        <th style="padding: 16px 24px; text-align: left;">Person</th>
                        <th style="padding: 16px 24px; text-align: left;">Activity Type</th>
                        <th style="padding: 16px 24px; text-align: center;">Fun During</th>
                        <th style="padding: 16px 24px; text-align: center;">Fun After</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #f8f9fa;"><td style="padding: 12px 24px;">Reese</td><td style="padding: 12px 24px;">Cleaning the house</td><td style="padding: 12px 24px; text-align: center;">3.6</td><td style="padding: 12px 24px; text-align: center;">5.1</td></tr>
                    <tr style="background: #fff;"><td style="padding: 12px 24px;">Morgan</td><td style="padding: 12px 24px;">Home renovation project</td><td style="padding: 12px 24px; text-align: center;">4.6</td><td style="padding: 12px 24px; text-align: center;">4.8</td></tr>
                    <tr style="background: #f8f9fa;"><td style="padding: 12px 24px;">Lane</td><td style="padding: 12px 24px;">Marathon running</td><td style="padding: 12px 24px; text-align: center;">3.0</td><td style="padding: 12px 24px; text-align: center;">6.5</td></tr>
                    <tr style="background: #fff;"><td style="padding: 12px 24px;">Alex</td><td style="padding: 12px 24px;">Moving apartments</td><td style="padding: 12px 24px; text-align: center;">3.0</td><td style="padding: 12px 24px; text-align: center;">6.5</td></tr>
                    <tr style="background: #f8f9fa;"><td style="padding: 12px 24px;">Riley</td><td style="padding: 12px 24px;">Overnight backpacking</td><td style="padding: 12px 24px; text-align: center;">3.6</td><td style="padding: 12px 24px; text-align: center;">5.6</td></tr>
                    <tr style="background: #fff;"><td style="padding: 12px 24px;">Charlie</td><td style="padding: 12px 24px;">Cooking class</td><td style="padding: 12px 24px; text-align: center;">6.6</td><td style="padding: 12px 24px; text-align: center;">7.0</td></tr>
                    <tr style="background: #f8f9fa;"><td style="padding: 12px 24px;">Quinn</td><td style="padding: 12px 24px;">Concert</td><td style="padding: 12px 24px; text-align: center;">8.4</td><td style="padding: 12px 24px; text-align: center;">8.2</td></tr>
                    <tr style="background: #fff;"><td style="padding: 12px 24px;">Kit</td><td style="padding: 12px 24px;">Waiting in line</td><td style="padding: 12px 24px; text-align: center;">4.7</td><td style="padding: 12px 24px; text-align: center;">3.6</td></tr>
                    <tr style="background: #f8f9fa;"><td style="padding: 12px 24px;">Devon</td><td style="padding: 12px 24px;">Road trip with music</td><td style="padding: 12px 24px; text-align: center;">7.4</td><td style="padding: 12px 24px; text-align: center;">6.8</td></tr>
                    <tr style="background: #fff;"><td style="padding: 12px 24px;">Quinn</td><td style="padding: 12px 24px;">Picnic in the park</td><td style="padding: 12px 24px; text-align: center;">9.4</td><td style="padding: 12px 24px; text-align: center;">10.0</td></tr>
                </tbody>
            </table>
            <p style="margin-top: 20px; color: #888; font-size: 0.9em;">Showing 10 of 100 observations</p>
        </div>

        <!-- Slide 12: Graph Responses Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3.2em; color: #fff; font-weight: 300;">4. Graph Responses Using <em style="color: #f39c12;">Scatterplot</em></h1>
        </div>

        <!-- Slide 13: Type 1 vs Type 2 Fun - Interactive R Plot -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot2" style="margin-top: 0; max-height: calc(100vh - 20px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn2" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor2"># Type 1 vs Type 2 Fun Dataset (synthetic data)
# Data preloaded: ActivityType, FunDuring, FunAfter

# Top 4 activities by frequency
top4 <- c("Cleaning the house", "Marathon running",
          "Waiting in line", "Road trip with music")

# Assign colors: top 4 get distinct colors, rest are gray
colors <- ifelse(ActivityType == top4[1], "#e74c3c",
          ifelse(ActivityType == top4[2], "#3498db",
          ifelse(ActivityType == top4[3], "#9b59b6",
          ifelse(ActivityType == top4[4], "#2ecc71", "#cccccc"))))

# Plot
par(mar = c(5, 5, 4, 2))
plot(FunDuring, FunAfter,
     pch = 19, cex = 1.8,
     col = colors,
     xlab = "Fun During Activity (1-10)",
     ylab = "Fun After Activity (1-10)",
     main = "Type 1 vs Type 2 Fun",
     cex.lab = 1.4, cex.main = 1.6, cex.axis = 1.2,
     xlim = c(1, 10), ylim = c(1, 10))

# Add diagonal reference line (equal fun during & after)
abline(a = 0, b = 1, lty = 2, col = "gray50")

# Legend
legend("topleft",
       legend = c(top4, "Other activities"),
       col = c("#e74c3c", "#3498db", "#9b59b6", "#2ecc71", "#cccccc"),
       pch = 19, pt.cex = 1.5,
       cex = 1.1, bty = "n")</textarea>
                    <div class="sp-output" id="output2"></div>
                </div>
                <div class="sp-status" id="status2">Waiting for WebR...</div>
            </div>
        </div>

        <!-- Slide 14: Types of Relationships Interstitial -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="anna-magenta-4rYe04Kb9t0-unsplash.svg" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
                <h1 style="font-size: 5em; color: #1a1a2e; text-shadow: 0 2px 20px rgba(255,255,255,0.5); margin: 0; font-weight: 300; letter-spacing: 0.05em;">Types of Relationships</h1>
            </div>
            <div style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; z-index: 20; font-size: 0.75em; color: rgba(50,50,50,0.7);">
                Illustration by <a href="https://unsplash.com/@annamagenta82?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" style="color: rgba(50,50,50,0.9);">Anna Magenta</a> on <a href="https://unsplash.com/illustrations/two-hands-making-a-pinky-promise-4rYe04Kb9t0?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" style="color: rgba(50,50,50,0.9);">Unsplash</a>
            </div>
        </div>

        <!-- Slide 15: Positive Relationship Interstitial -->
        <div class="slide lead" style="background: url('ricardo-gomez-angel-7RuhOrZO-1g-unsplash.jpg') center/cover no-repeat; position: relative;">
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4);"></div>
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300; position: relative; z-index: 1;">Positive (Direct) Relationship</h1>
            <p style="position: absolute; bottom: 10px; right: 15px; font-size: 0.7em; color: rgba(255,255,255,0.6); z-index: 1;">Photo by <a href="https://unsplash.com/@rgaleriacom" style="color: rgba(255,255,255,0.6);">Ricardo Gomez Angel</a> on Unsplash</p>
        </div>

        <!-- Slide 16: Fire Incidents - Firefighters vs Property Damage -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot3" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn3" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor3" style="font-size: 18px;"># Fire Incidents - Firefighters vs Property Damage
# Data preloaded: structures_burned, firefighters, property_damage

par(mar = c(5, 6, 4, 2))
plot(firefighters, property_damage / 1e6,
     pch = 19, cex = 1.2, col = "#e74c3c88",
     xlab = "Number of Firefighters",
     ylab = "Property Damage ($ millions)",
     main = "Firefighters vs Property Damage",
     cex.lab = 1.4, cex.main = 1.6, cex.axis = 1.2)

# Add trend line
abline(lm(property_damage / 1e6 ~ firefighters),
       col = "#c0392b", lwd = 2)

# Add correlation
r <- cor(firefighters, property_damage)
text(80, 1, paste("r =", round(r, 3)),
     cex = 1.5, col = "#c0392b")</textarea>
                    <div class="sp-output" id="output3"></div>
                </div>
                <div class="sp-status" id="status3">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Note: This is synthetic data for educational purposes</p>
        </div>

        <!-- Slide 17: Fire Incidents - Structures Burned vs Firefighters -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot4" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn4" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor4" style="font-size: 18px;"># Fire Incidents - Structures Burned vs Firefighters
# Data preloaded: structures_burned, firefighters, property_damage

par(mar = c(5, 5, 4, 2))
plot(structures_burned, firefighters,
     pch = 19, cex = 1.2, col = "#3498db88",
     xlab = "Structures Burned",
     ylab = "Number of Firefighters",
     main = "Structures Burned vs Firefighters",
     cex.lab = 1.4, cex.main = 1.6, cex.axis = 1.2)

# Add trend line
abline(lm(firefighters ~ structures_burned),
       col = "#2980b9", lwd = 2)

# Add correlation
r <- cor(structures_burned, firefighters)
text(12, 20, paste("r =", round(r, 3)),
     cex = 1.5, col = "#2980b9")</textarea>
                    <div class="sp-output" id="output4"></div>
                </div>
                <div class="sp-status" id="status4">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Note: This is synthetic data for educational purposes</p>
        </div>

        <!-- Slide 18: Fire Incidents - Property Damage vs Structures Burned -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot5" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn5" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor5" style="font-size: 18px;"># Fire Incidents - Property Damage vs Structures Burned
# Data preloaded: structures_burned, firefighters, property_damage

par(mar = c(5, 6, 4, 2))
plot(structures_burned, property_damage / 1e6,
     pch = 19, cex = 1.2, col = "#9b59b688",
     xlab = "Structures Burned",
     ylab = "Property Damage ($ millions)",
     main = "Property Damage vs Structures Burned",
     cex.lab = 1.4, cex.main = 1.6, cex.axis = 1.2)

# Add trend line
abline(lm(property_damage / 1e6 ~ structures_burned),
       col = "#8e44ad", lwd = 2)

# Add correlation
r <- cor(structures_burned, property_damage)
text(12, 1, paste("r =", round(r, 3)),
     cex = 1.5, col = "#8e44ad")</textarea>
                    <div class="sp-output" id="output5"></div>
                </div>
                <div class="sp-status" id="status5">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Note: This is synthetic data for educational purposes</p>
        </div>

        <!-- Slide 19: Negative Relationship Interstitial -->
        <div class="slide lead" style="background: url('ehimetalor-akhere-unuabona-4RpjFdG0fp0-unsplash.jpg') center/cover no-repeat; position: relative;">
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4);"></div>
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300; position: relative; z-index: 1;">Negative (Inverse) Relationship</h1>
            <p style="position: absolute; bottom: 10px; right: 15px; font-size: 0.7em; color: rgba(255,255,255,0.6); z-index: 1;">Photo by <a href="https://unsplash.com/@mettyunuabona" style="color: rgba(255,255,255,0.6);">Ehimetalor Akhere Unuabona</a> on Unsplash</p>
        </div>

        <!-- Slide 20: Marathon Opinion - Time vs Opinion -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot6" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn6" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor6"># Marathon Opinion - Meters Run vs Opinion (Regular Scale)
# Data preloaded: meters_run, opinion
# Meters: 100m to 42,195m (full marathon)
# Opinion: 0 (Never again) to 9 (Best thing ever)

par(mar = c(5, 5, 4, 2))
plot(meters_run, opinion,
     pch = 19, cex = 1.2, col = "#c0392b88",
     xlab = "Meters Run During Marathon",
     ylab = "Opinion of Running (0-9)",
     main = "Opinion During Marathon",
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1,
     ylim = c(0, 9))

# Add trend line
fit <- lm(opinion ~ meters_run)
abline(fit, col = "#c0392b", lwd = 2)

# Add correlation
r <- cor(meters_run, opinion)
text(max(meters_run) * 0.7, 8, paste("r =", round(r, 3)),
     cex = 1.4, col = "#c0392b")</textarea>
                    <div class="sp-output" id="output6"></div>
                </div>
                <div class="sp-status" id="status6">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Note: This is synthetic data for educational purposes</p>
        </div>

        <!-- Slide 21: Marathon Opinion - Log Scale -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot7" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn7" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor7" style="font-size: 18px;"># Marathon Opinion - Meters Run vs Opinion (Log Scale)
# Data preloaded: meters_run, opinion
# Meters: 100m to 42,195m (full marathon)
# Opinion: 0 (Never again) to 9 (Best thing ever)

par(mar = c(5, 5, 4, 2))
plot(meters_run, opinion,
     pch = 19, cex = 1.2, col = "#c0392b88",
     log = "x",  # Log scale for meters axis
     xlab = "Meters Run During Marathon (log scale)",
     ylab = "Opinion of Running (0-9)",
     main = "Opinion During Marathon (Log Scale)",
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1,
     xaxt = "n", ylim = c(0, 9))

# Custom x-axis labels
axis(1, at = c(100, 500, 1000, 5000, 10000, 42195),
     labels = c("100m", "500m", "1km", "5km", "10km", "42km"),
     cex.axis = 1.1)

# Add trend line (on log scale)
fit <- lm(opinion ~ log10(meters_run))
x_seq <- 10^seq(2, 4.63, length.out = 100)
lines(x_seq, predict(fit, newdata = data.frame(meters_run = x_seq)),
      col = "#c0392b", lwd = 2)

# Add correlation (log scale)
r <- cor(log10(meters_run), opinion)
text(20000, 8, paste("r =", round(r, 3)), cex = 1.4, col = "#c0392b")</textarea>
                    <div class="sp-output" id="output7"></div>
                </div>
                <div class="sp-status" id="status7">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Note: This is synthetic data for educational purposes</p>
        </div>

        <!-- Slide 22: No Relationship Interstitial -->
        <div class="slide lead" style="background: url('rahul-chowdhury-Q7Zggf_AtQk-unsplash.jpg') center/cover no-repeat; position: relative;">
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4);"></div>
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300; position: relative; z-index: 1;">No (Weak) Relationship</h1>
            <p style="position: absolute; bottom: 10px; right: 15px; font-size: 0.7em; color: rgba(255,255,255,0.6); z-index: 1;">Photo by <a href="https://unsplash.com/@rahulchowdhury" style="color: rgba(255,255,255,0.6);">Rahul Chowdhury</a> on Unsplash</p>
        </div>

        <!-- Slide 23: Beer Price vs Overall Evaluation -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot8" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn8" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor8" style="font-size: 18px;"># Beer Price vs Overall Evaluation
# Data preloaded: avg_price, overall
# 229 Belgian beers with price and tasting data

par(mar = c(5, 5, 4, 2))
plot(avg_price, overall,
     pch = 19, cex = 1.2, col = "#7f8c8d88",
     xlab = "Average Price (EUR)",
     ylab = "Overall Evaluation (standardized)",
     main = "Beer Price vs Expert Evaluation",
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1)

# Add trend line
fit <- lm(overall ~ avg_price)
abline(fit, col = "#7f8c8d", lwd = 2)

# Add correlation
r <- cor(avg_price, overall)
text(50, 1, paste("r =", round(r, 3)), cex = 1.4, col = "#7f8c8d")</textarea>
                    <div class="sp-output" id="output8"></div>
                </div>
                <div class="sp-status" id="status8">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Data: Verstrepen et al. (2024) <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10966102/#Sec11" target="_blank" style="color: #888;">PMC10966102</a></p>
        </div>

        <!-- Slide 24: Beer - Identifying Influential Points -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot9" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn9" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor9"># Identifying Influential Points (DFBETA)
# Data preloaded: avg_price, overall

# Fit regression and calculate DFBETA
fit <- lm(overall ~ avg_price)
dfb <- dfbeta(fit)[, 2]  # DFBETA for slope

# Find 25 most influential points (highest |dfbeta|)
influential <- order(abs(dfb), decreasing = TRUE)[1:25]

par(mar = c(5, 5, 4, 2))
plot(avg_price, overall,
     pch = 19, cex = 1.2, col = "#7f8c8d88",
     xlab = "Average Price (EUR)",
     ylab = "Overall Evaluation (standardized)",
     main = "Identifying 25 Most Influential Points",
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1)

# Highlight the 25 most influential points
points(avg_price[influential], overall[influential],
       pch = 19, cex = 1.5, col = "#e74c3c")

# Add trend line
abline(fit, col = "#7f8c8d", lwd = 2)

# Add correlation
r <- cor(avg_price, overall)
text(50, 1, paste("r =", round(r, 3)), cex = 1.4, col = "#7f8c8d")

# Legend
legend("bottomright", "25 highest |DFBETA|",
       pch = 19, col = "#e74c3c", cex = 1.1)</textarea>
                    <div class="sp-output" id="output9"></div>
                </div>
                <div class="sp-status" id="status9">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">DFBETA measures how much removing each point changes the regression slope</p>
        </div>

        <!-- Slide 25: Beer - After Removing Influential Points -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" id="smartPlot10" style="margin-top: 0; max-height: calc(100vh - 60px);">
                <div class="sp-header">
                    <span class="title">R Code (base graphics) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn10" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor10" style="font-size: 18px;"># After Removing 25 Influential Points
# Data preloaded: avg_price, overall

# Fit regression and calculate DFBETA
fit <- lm(overall ~ avg_price)
dfb <- dfbeta(fit)[, 2]  # DFBETA for slope

# Find 25 most influential points (highest |dfbeta|)
influential <- order(abs(dfb), decreasing = TRUE)[1:25]

# Remove influential points
price_clean <- avg_price[-influential]
overall_clean <- overall[-influential]

par(mar = c(5, 5, 4, 2))
plot(price_clean, overall_clean,
     pch = 19, cex = 1.2, col = "#27ae6088",
     xlab = "Average Price (EUR)",
     ylab = "Overall Evaluation (standardized)",
     main = "After Removing 25 Influential Points",
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1)

# Add trend line
fit_clean <- lm(overall_clean ~ price_clean)
abline(fit_clean, col = "#27ae60", lwd = 2)

# Add correlation
r_clean <- cor(price_clean, overall_clean)
text(35, 0.8, paste("r =", round(r_clean, 3)), cex = 1.4, col = "#27ae60")

# Show comparison
r_orig <- cor(avg_price, overall)
text(35, 0.5, paste("(was", round(r_orig, 3), "with all data)"),
     cex = 1.1, col = "#7f8c8d")</textarea>
                    <div class="sp-output" id="output10"></div>
                </div>
                <div class="sp-status" id="status10">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Removing influential points changes r from ~0.13 to ~0.02</p>
        </div>

        <!-- Slide: Hotel Fun vs Price by Humidity (2-panel) -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" style="margin-top: 0; max-height: calc(100vh - 20px);">
                <div class="sp-header">
                    <span class="title">R Code – Hotel Fun by Humidity Level</span>
                    <button class="sp-btn" id="runBtn11" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor11"># Hotel Data: Fun vs Price, Split by Humidity
# Data preloaded: hotel_cost, fun_reported, humidity

# Split by humidity threshold
low_humid <- humidity < 60
high_humid <- humidity >= 60

# Set up 2-panel layout
par(mfrow = c(1, 2), mar = c(5, 5, 4, 2))

# Left panel: Low humidity (high variance)
plot(hotel_cost[low_humid], fun_reported[low_humid],
     pch = 19, cex = 1.2, col = "#3498db88",
     xlab = "Hotel Cost (USD/night)",
     ylab = "Fun Reported (1-10)",
     main = "Low Humidity (<60%)",
     xlim = c(50, 500), ylim = c(1, 10),
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1)
r_low <- cor(hotel_cost[low_humid], fun_reported[low_humid])
text(400, 2, paste("r =", round(r_low, 3)), cex = 1.4, col = "#2980b9")
text(400, 1.3, paste("n =", sum(low_humid)), cex = 1.1, col = "#7f8c8d")

# Right panel: High humidity (low variance)
plot(hotel_cost[high_humid], fun_reported[high_humid],
     pch = 19, cex = 1.2, col = "#e74c3c88",
     xlab = "Hotel Cost (USD/night)",
     ylab = "Fun Reported (1-10)",
     main = "High Humidity (≥60%)",
     xlim = c(50, 500), ylim = c(1, 10),
     cex.lab = 1.3, cex.main = 1.5, cex.axis = 1.1)
r_high <- cor(hotel_cost[high_humid], fun_reported[high_humid])
text(400, 2, paste("r =", round(r_high, 3)), cex = 1.4, col = "#c0392b")
text(400, 1.3, paste("n =", sum(high_humid)), cex = 1.1, col = "#7f8c8d")</textarea>
                    <div class="sp-output" id="output11"></div>
                </div>
                <div class="sp-status" id="status11">Waiting for WebR...</div>
            </div>
            <p style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.8em; color: #888;">Same slope, different variance: high noise weakens correlation even when the true relationship is identical</p>
        </div>

        <!-- Slide: What is the correlation coefficient? -->
        <div class="slide" style="padding: 60px 80px; background: #fff;">
            <h1 style="font-size: 2.8em; color: #1a1a2e; font-weight: 400; margin-bottom: 50px;">What is the correlation coefficient <em style="font-style: normal; color: #e74c3c;">ρ</em>?</h1>
            <ul style="font-size: 1.8em; color: #333; line-height: 2;">
                <li>Does a relationship exist?</li>
                <li>If so, is it positive or negative?</li>
                <li>Is it strong or weak?</li>
            </ul>
            <div style="margin-top: 60px; background: #f8f9fa; padding: 30px 40px; border-radius: 12px; display: inline-block;">
                <code style="font-size: 1.6em; color: #2c3e50; background: none;">cor(v1, v2)</code>
            </div>
        </div>

        <!-- Slide: Correlation coefficient formula -->
        <div class="slide" style="padding: 50px 80px; background: #fff;">
            <h1 style="font-size: 2.8em; color: #1a1a2e; font-weight: 400; margin-bottom: 40px;">What is the correlation coefficient <em style="font-style: normal; color: #e74c3c;">ρ</em>?</h1>
            <ul style="font-size: 1.6em; color: #333; line-height: 1.8; margin-bottom: 40px;">
                <li>A single summary number</li>
                <li>Gives you an idea about how closely one variable is related to another</li>
            </ul>

            <!-- Compact formula -->
            <div style="background: #f8f9fa; padding: 25px 40px; border-radius: 12px; text-align: center; margin-bottom: 30px;">
                <span style="font-size: 1.8em; color: #2c3e50;">
                    ρ<sub>XY</sub> =
                    <span style="display: inline-block; text-align: center; vertical-align: middle;">
                        <span style="border-bottom: 2px solid #2c3e50; padding: 0 10px;">Cov(X, Y)</span><br>
                        <span style="padding: 0 10px; font-size: 1.1em;">√</span><span style="text-decoration: overline; padding: 0 5px;">Var(X) × Var(Y)</span>
                    </span>
                </span>
            </div>

            <!-- Expanded formula -->
            <div style="background: #fff3e0; padding: 25px 40px; border-radius: 12px; text-align: center;">
                <span style="font-size: 1.5em; color: #e65100;">
                    ρ =
                    <span style="display: inline-block; text-align: center; vertical-align: middle;">
                        <span style="border-bottom: 2px solid #e65100; padding: 0 15px;">Σ (x<sub>i</sub> − <span style="text-decoration: overline;">x</span>)(y<sub>i</sub> − <span style="text-decoration: overline;">y</span>)</span><br>
                        <span style="padding: 0 15px; font-size: 1.1em;">√</span><span style="text-decoration: overline; padding: 0 5px;">Σ(x<sub>i</sub> − <span style="text-decoration: overline;">x</span>)² × Σ(y<sub>i</sub> − <span style="text-decoration: overline;">y</span>)²</span>
                    </span>
                </span>
            </div>

            <!-- Plain English explanation -->
            <div style="margin-top: 25px; font-size: 1.1em; color: #666; line-height: 1.6;">
                <p style="margin: 8px 0;"><strong>Top:</strong> For each point, multiply (how far x is from its average) × (how far y is from its average), then sum them all</p>
                <p style="margin: 8px 0;"><strong>Bottom:</strong> Square root of (sum of squared x-deviations) × (sum of squared y-deviations)</p>
            </div>
        </div>

        <!-- Slide: Interactive correlation explorer -->
        <div class="slide" style="padding: 30px 50px; background: #fff;">
            <h1 style="font-size: 2.4em; color: #1a1a2e; font-weight: 400; margin-bottom: 20px; text-align: center;">What is the correlation coefficient <em style="font-style: normal; color: #e74c3c;">ρ</em>?</h1>

            <div style="display: flex; align-items: stretch; height: calc(100% - 80px); gap: 30px;">
                <!-- Left: Scatterplot -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <canvas id="rhoCanvas" width="400" height="400" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                    <p id="rhoDisplay" style="margin-top: 15px; font-size: 1.4em; color: #e74c3c; font-weight: 500;">ρ = 0.00</p>
                </div>

                <!-- Center: Vertical slider -->
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0;">
                    <span style="font-size: 1.1em; color: #27ae60; font-weight: 500; margin-bottom: 10px;">+1.0</span>
                    <input type="range" id="rhoSlider" min="-100" max="100" value="0"
                           style="writing-mode: vertical-lr; direction: rtl; height: 350px; width: 40px; cursor: pointer;">
                    <span style="font-size: 1.1em; color: #e74c3c; font-weight: 500; margin-top: 10px;">−1.0</span>
                </div>

                <!-- Right: Explanations -->
                <div style="flex: 1.3; display: flex; flex-direction: column; justify-content: space-between; padding: 10px 0; font-size: 1.15em;">
                    <!-- Top: +1 -->
                    <div style="background: #e8f5e9; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #27ae60;">
                        <strong style="color: #27ae60;">If ρ = +1.0:</strong><br>
                        Perfect <em>positive</em> relationship between the two variables<br>
                        <span style="color: #666;">(Allows best predictions)</span>
                    </div>

                    <!-- Upper area: positive -->
                    <div style="background: #f1f8e9; padding: 12px 20px; border-radius: 8px; color: #558b2f;">
                        ↑ The bigger the number, the stronger the relationship<br>
                        <span style="color: #888;">(Bigger numbers mean better prediction)</span>
                    </div>

                    <!-- Middle: 0 -->
                    <div style="background: #fff3e0; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #ff9800;">
                        <strong style="color: #ff9800;">If ρ = 0.0:</strong><br>
                        No relationship between the two variables<br>
                        <span style="color: #666;">(Allows no prediction)</span>
                    </div>

                    <!-- Lower area: negative -->
                    <div style="background: #fce4ec; padding: 12px 20px; border-radius: 8px; color: #c62828;">
                        ↓ The bigger the number <em>in absolute value</em>, the stronger the relationship<br>
                        <span style="color: #888;">(Bigger absolute numbers mean better prediction)</span>
                    </div>

                    <!-- Bottom: -1 -->
                    <div style="background: #ffebee; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #e74c3c;">
                        <strong style="color: #e74c3c;">If ρ = −1.0:</strong><br>
                        Perfect <em>negative</em> relationship between the two variables<br>
                        <span style="color: #666;">(Allows best predictions)</span>
                    </div>
                </div>
            </div>
        </div>

        <script>
        (function() {
            const canvas = document.getElementById('rhoCanvas');
            const ctx = canvas.getContext('2d');
            const slider = document.getElementById('rhoSlider');
            const display = document.getElementById('rhoDisplay');

            // Box-Muller transform for normal random numbers
            function randn() {
                let u = 0, v = 0;
                while (u === 0) u = Math.random();
                while (v === 0) v = Math.random();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            // Generate correlated points with given rho
            function generatePoints(rho, n = 100) {
                const points = [];
                for (let i = 0; i < n; i++) {
                    const x = randn();
                    const z = randn();
                    const y = rho * x + Math.sqrt(1 - rho * rho) * z;
                    points.push({ x, y });
                }
                return points;
            }

            // Draw scatterplot
            function drawPlot(rho) {
                const points = generatePoints(rho);
                const width = canvas.width;
                const height = canvas.height;
                const padding = 40;

                // Clear canvas
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, width, height);

                // Draw axes
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, height / 2);
                ctx.lineTo(width - padding, height / 2);
                ctx.moveTo(width / 2, padding);
                ctx.lineTo(width / 2, height - padding);
                ctx.stroke();

                // Scale points to fit canvas (assuming range roughly -3 to 3)
                const scale = (width - 2 * padding) / 6;
                const cx = width / 2;
                const cy = height / 2;

                // Determine color based on rho
                let color;
                if (rho > 0.1) {
                    color = `rgba(39, 174, 96, ${0.5 + Math.abs(rho) * 0.3})`;
                } else if (rho < -0.1) {
                    color = `rgba(231, 76, 60, ${0.5 + Math.abs(rho) * 0.3})`;
                } else {
                    color = 'rgba(255, 152, 0, 0.6)';
                }

                // Draw points
                ctx.fillStyle = color;
                for (const p of points) {
                    const px = cx + p.x * scale;
                    const py = cy - p.y * scale;
                    ctx.beginPath();
                    ctx.arc(px, py, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // Draw axis labels
                ctx.fillStyle = '#999';
                ctx.font = '14px system-ui, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('X', width - 20, height / 2 + 20);
                ctx.fillText('Y', width / 2 + 15, 25);
            }

            // Update display and redraw
            function update() {
                const rho = slider.value / 100;
                display.textContent = `ρ = ${rho.toFixed(2)}`;

                // Update display color
                if (rho > 0.1) {
                    display.style.color = '#27ae60';
                } else if (rho < -0.1) {
                    display.style.color = '#e74c3c';
                } else {
                    display.style.color = '#ff9800';
                }

                drawPlot(rho);
            }

            slider.addEventListener('input', update);

            // Initial draw
            update();
        })();
        </script>

        <!-- Slide: Correlation is not a percent -->
        <div class="slide" style="padding: 60px 80px; background: #fff;">
            <h1 style="font-size: 2.8em; color: #1a1a2e; font-weight: 400; margin-bottom: 50px;">What is the correlation coefficient <em style="font-style: normal; color: #e74c3c;">ρ</em>?</h1>

            <!-- Not a percent -->
            <div style="background: #fff3e0; padding: 25px 35px; border-radius: 12px; margin-bottom: 40px; border-left: 5px solid #ff9800;">
                <p style="font-size: 1.8em; color: #2c3e50; margin: 0 0 15px 0;">
                    ρ = 0.90 <strong style="color: #e74c3c;">≠</strong> 90%
                </p>
                <p style="font-size: 1.4em; color: #e65100; margin: 0; font-weight: 500;">
                    The correlation coefficient is a <em>ratio</em>, not a percent.
                </p>
            </div>

            <!-- R-squared -->
            <div style="background: #e3f2fd; padding: 25px 35px; border-radius: 12px; border-left: 5px solid #2196f3;">
                <p style="font-size: 1.8em; color: #1565c0; margin: 0 0 20px 0; font-weight: 500;">
                    R² — Coefficient of Determination
                </p>
                <ul style="font-size: 1.4em; color: #333; line-height: 1.8; margin: 0; padding-left: 25px;">
                    <li>The coefficient of determination tells you how much variation in one variable is related to changes in the other variable.</li>
                    <li style="margin-top: 15px;">How accurate will predictions about one variable made by knowledge about the other variable be?</li>
                </ul>
            </div>
        </div>

        <!-- Slide: Interactive R-squared Venn diagram -->
        <div class="slide" style="padding: 30px 60px; background: #fff;">
            <h1 style="font-size: 2.6em; color: #1a1a2e; font-weight: 400; margin-bottom: 20px; text-align: center;">What is the coefficient of determination <em style="font-style: normal; color: #2196f3;">R²</em>?</h1>

            <div style="display: flex; flex-direction: column; align-items: center; height: calc(100% - 100px);">
                <!-- Venn diagram canvas -->
                <canvas id="vennCanvas" width="700" height="300" style="margin-bottom: 20px;"></canvas>

                <!-- Slider -->
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
                    <span style="font-size: 1.2em; color: #666;">R² = 0</span>
                    <input type="range" id="r2Slider" min="0" max="100" value="0"
                           style="width: 400px; height: 25px; cursor: pointer;">
                    <span style="font-size: 1.2em; color: #666;">R² = 1</span>
                </div>

                <!-- R² display -->
                <p id="r2Display" style="font-size: 2em; color: #2196f3; font-weight: 500; margin: 10px 0;">R² = 0.00</p>

                <!-- Explanation -->
                <div id="r2Explanation" style="background: #f5f5f5; padding: 25px 40px; border-radius: 12px; max-width: 800px; text-align: center; font-size: 1.3em; color: #333; line-height: 1.6;">
                    There is <strong>no overlap</strong> between the two variables (No relationship)
                </div>
            </div>
        </div>

        <script>
        (function() {
            const canvas = document.getElementById('vennCanvas');
            const ctx = canvas.getContext('2d');
            const slider = document.getElementById('r2Slider');
            const display = document.getElementById('r2Display');
            const explanation = document.getElementById('r2Explanation');

            const width = canvas.width;
            const height = canvas.height;
            const radius = 100;
            const centerY = height / 2;

            function drawVenn(r2) {
                ctx.clearRect(0, 0, width, height);

                // Calculate distance between centers based on R²
                // At R²=0, distance = 2*radius (no overlap)
                // At R²=1, distance = 0 (complete overlap)
                const maxDist = 2 * radius;
                const distance = maxDist * (1 - r2);

                const cx1 = width / 2 - distance / 2;
                const cx2 = width / 2 + distance / 2;

                // Draw overlap area first (darker)
                if (r2 > 0 && r2 < 1) {
                    ctx.globalCompositeOperation = 'source-over';

                    // Left circle
                    ctx.beginPath();
                    ctx.arc(cx1, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(52, 152, 219, 0.4)';
                    ctx.fill();

                    // Right circle
                    ctx.beginPath();
                    ctx.arc(cx2, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.4)';
                    ctx.fill();

                    // Intersection (draw both with multiply-like effect)
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(cx1, centerY, radius, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.beginPath();
                    ctx.arc(cx2, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(142, 68, 173, 0.6)';
                    ctx.fill();
                    ctx.restore();
                } else if (r2 >= 1) {
                    // Complete overlap
                    ctx.beginPath();
                    ctx.arc(width / 2, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(142, 68, 173, 0.7)';
                    ctx.fill();
                } else {
                    // No overlap
                    ctx.beginPath();
                    ctx.arc(cx1, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(52, 152, 219, 0.5)';
                    ctx.fill();

                    ctx.beginPath();
                    ctx.arc(cx2, centerY, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.5)';
                    ctx.fill();
                }

                // Draw circle outlines
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = '#2980b9';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(cx1, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();

                ctx.strokeStyle = '#c0392b';
                ctx.beginPath();
                ctx.arc(cx2, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();

                // Labels
                ctx.font = 'bold 18px system-ui, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#2980b9';
                ctx.fillText('Variable X', cx1, centerY + radius + 25);
                ctx.fillStyle = '#c0392b';
                ctx.fillText('Variable Y', cx2, centerY + radius + 25);
            }

            function updateExplanation(r2) {
                let text, bgColor;

                if (r2 === 0) {
                    text = 'There is <strong>no overlap</strong> between the two variables (No relationship)';
                    bgColor = '#ffebee';
                } else if (r2 < 0.3) {
                    text = `There is <strong>little overlap</strong> between the two variables (Weak relationship)<br><span style="color: #666; font-size: 0.9em;">Overlap / Total area = R²</span>`;
                    bgColor = '#fff3e0';
                } else if (r2 < 0.5) {
                    text = `There is <strong>some overlap</strong> between the two variables (Moderate relationship)<br><span style="color: #666; font-size: 0.9em;">Overlap / Total area = R²</span>`;
                    bgColor = '#fff8e1';
                } else if (r2 < 0.8) {
                    text = `There is <strong>a lot of overlap</strong> between the two variables (Strong relationship)<br><span style="color: #666; font-size: 0.9em;">Overlap / Total area = R²</span>`;
                    bgColor = '#e8f5e9';
                } else if (r2 < 1) {
                    text = `There is <strong>substantial overlap</strong> between the two variables (Very strong relationship)<br><span style="color: #666; font-size: 0.9em;">Overlap / Total area = R²</span>`;
                    bgColor = '#e3f2fd';
                } else {
                    text = 'There is a <strong>deterministic relationship</strong> between the two variables.<br>Complete overlap — one variable perfectly predicts the other.';
                    bgColor = '#e1bee7';
                }

                explanation.innerHTML = text;
                explanation.style.background = bgColor;
            }

            function update() {
                const r2 = slider.value / 100;
                display.textContent = `R² = ${r2.toFixed(2)}`;
                drawVenn(r2);
                updateExplanation(r2);
            }

            slider.addEventListener('input', update);

            // Initial draw
            update();
        })();
        </script>

        <!-- Slide: Interpreting Correlation Coefficients Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300;">Interpreting Correlation Coefficients</h1>
        </div>

        <!-- Slide: Large vs Small Correlation Coefficients -->
        <div class="slide" style="padding: 80px; background: #fff; justify-content: center;">
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; gap: 40px; align-items: stretch;">
                    <!-- Large coefficients -->
                    <div style="flex: 1; background: #e8f5e9; padding: 40px; border-radius: 16px; border-left: 6px solid #27ae60;">
                        <h2 style="color: #27ae60; font-size: 1.8em; margin: 0 0 20px 0;">Large Coefficients</h2>
                        <p style="font-size: 1.5em; color: #333; margin: 0; line-height: 1.6;">
                            Closer to <strong style="color: #27ae60;">±1.00</strong><br>
                            <span style="font-size: 0.9em; color: #666;">→ Stronger relationships</span>
                        </p>
                    </div>
                    <!-- Small coefficients -->
                    <div style="flex: 1; background: #fff3e0; padding: 40px; border-radius: 16px; border-left: 6px solid #ff9800;">
                        <h2 style="color: #ff9800; font-size: 1.8em; margin: 0 0 20px 0;">Small Coefficients</h2>
                        <p style="font-size: 1.5em; color: #333; margin: 0; line-height: 1.6;">
                            Close to <strong style="color: #ff9800;">0.00</strong><br>
                            <span style="font-size: 0.9em; color: #666;">→ Weaker relationships</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide: Zero vs Perfect Correlation -->
        <div class="slide" style="padding: 80px; background: #fff; justify-content: center;">
            <div style="max-width: 900px; margin: 0 auto; text-align: center;">
                <div style="display: flex; justify-content: center; align-items: center; gap: 60px;">
                    <!-- Zero -->
                    <div style="text-align: center;">
                        <div style="font-size: 4em; color: #ff9800; font-weight: 300;">ρ = 0.00</div>
                        <p style="font-size: 1.6em; color: #666; margin-top: 20px;">No relationship</p>
                    </div>
                    <!-- Divider -->
                    <div style="font-size: 3em; color: #ccc;">↔</div>
                    <!-- Perfect -->
                    <div style="text-align: center;">
                        <div style="font-size: 4em; color: #27ae60; font-weight: 300;">ρ = ±1.00</div>
                        <p style="font-size: 1.6em; color: #666; margin-top: 20px;">Perfect relationship</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide: Single Summary Number -->
        <div class="slide" style="padding: 80px; background: #fff; justify-content: center;">
            <div style="max-width: 950px; margin: 0 auto;">
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 50px 60px; border-radius: 20px; color: #1a1a2e; border: 2px solid #1976d2;">
                    <h2 style="font-size: 2em; margin: 0 0 30px 0; font-weight: 400; color: #1565c0;">The Correlation Coefficient...</h2>
                    <p style="font-size: 1.6em; line-height: 1.7; margin: 0; color: #333;">
                        ...provides you with a <strong style="color: #1565c0;">single summary number</strong> telling you the average amount that a person's score on one variable is related to another variable.
                    </p>
                </div>
            </div>
        </div>

        <!-- Slide: ρ is not percent, R² is -->
        <div class="slide" style="padding: 60px 80px; background: #fff; justify-content: center;">
            <div style="max-width: 1000px; margin: 0 auto;">
                <!-- ρ is NOT percent -->
                <div style="background: #ffebee; padding: 35px 45px; border-radius: 16px; margin-bottom: 30px; border-left: 6px solid #e74c3c;">
                    <p style="font-size: 1.5em; color: #333; margin: 0; line-height: 1.6;">
                        The <strong style="color: #e74c3c;">Correlation Coefficient (ρ)</strong> is <em>not</em> a measure of the percent of one variable that is accounted for by the other variable.
                    </p>
                </div>
                <!-- R² IS percent -->
                <div style="background: #e3f2fd; padding: 35px 45px; border-radius: 16px; border-left: 6px solid #2196f3;">
                    <p style="font-size: 1.5em; color: #333; margin: 0; line-height: 1.6;">
                        <strong style="color: #2196f3;">R²</strong> (the Coefficient of Determination) <em>is</em> a measure of the percent of variation in one variable that is accounted for by the other variable.
                    </p>
                </div>
            </div>
        </div>

        <!-- Slide: Large R² means better predictions -->
        <div class="slide" style="padding: 80px; background: #fff; justify-content: center;">
            <div style="max-width: 950px; margin: 0 auto;">
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 50px 60px; border-radius: 20px; color: #fff;">
                    <h2 style="font-size: 2.2em; margin: 0 0 30px 0; font-weight: 400;">Large R² values...</h2>
                    <p style="font-size: 1.5em; line-height: 1.7; margin: 0;">
                        ...mean <strong>more shared variation</strong>, which means <strong>more accurate predictions</strong> are possible about one variable based on nothing more than knowledge of the other variable.
                    </p>
                </div>
            </div>
        </div>

        <!-- Slide: When to use correlations? Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 3.5em; color: #fff; font-weight: 300;">When to use correlations?</h1>
        </div>

        <!-- Slide: Interval or Ratio Scale -->
        <div class="slide" style="padding: 30px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">When to use correlations?</h1>
            <p style="font-size: 1.3em; color: #333; margin-bottom: 15px;">
                Your data on <strong>both variables</strong> is measured on either an <strong style="color: #2196f3;">Interval Scale</strong> or a <strong style="color: #27ae60;">Ratio Scale</strong>.
            </p>
            <div style="display: flex; gap: 40px; align-items: stretch; flex: 1;">
                <!-- Left: Plot with axis questions -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <canvas id="scaleQuizCanvas" width="500" height="420" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                </div>
                <!-- Right: Scale explanations -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 25px; justify-content: center;">
                    <!-- Interval Scale -->
                    <div style="background: #fff3e0; padding: 30px 35px; border-radius: 16px; border-left: 6px solid #ff9800;">
                        <h2 style="font-size: 1.6em; color: #ff9800; margin: 0 0 15px 0;">Interval Scale</h2>
                        <p style="font-size: 1.3em; color: #333; margin: 0; line-height: 1.6;">
                            <strong>Equal intervals</strong> between points, but <strong style="color: #e74c3c;">no</strong> true zero point.
                        </p>
                        <p style="font-size: 1.1em; color: #666; margin-top: 15px; font-style: italic;">
                            Example: Temperature in Celsius — 0°C doesn't mean "no temperature."
                        </p>
                    </div>
                    <!-- Ratio Scale -->
                    <div style="background: #e8f5e9; padding: 30px 35px; border-radius: 16px; border-left: 6px solid #27ae60;">
                        <h2 style="font-size: 1.6em; color: #27ae60; margin: 0 0 15px 0;">Ratio Scale</h2>
                        <p style="font-size: 1.3em; color: #333; margin: 0; line-height: 1.6;">
                            <strong>Equal intervals</strong> <em>and</em> a <strong style="color: #27ae60;">true zero</strong> point.
                        </p>
                        <p style="font-size: 1.1em; color: #666; margin-top: 15px; font-style: italic;">
                            Example: Height, weight — zero means "none," 20kg is twice 10kg.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <script>
        (function() {
            const canvas = document.getElementById('scaleQuizCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Marathon data (subset for visualization)
            const data = [
                {x: 6736, y: 2.2}, {x: 564, y: 6.2}, {x: 35841, y: 1.0}, {x: 1302, y: 5.8},
                {x: 18562, y: 3.5}, {x: 4521, y: 4.1}, {x: 812, y: 7.3}, {x: 28934, y: 2.8},
                {x: 2156, y: 5.5}, {x: 41203, y: 0.8}, {x: 9823, y: 3.2}, {x: 342, y: 8.1},
                {x: 15234, y: 3.8}, {x: 5678, y: 4.5}, {x: 22456, y: 2.1}, {x: 3421, y: 5.2},
                {x: 38912, y: 1.5}, {x: 7823, y: 3.9}, {x: 1567, y: 6.8}, {x: 31245, y: 1.8},
                {x: 11234, y: 3.1}, {x: 4123, y: 4.8}, {x: 25678, y: 2.5}, {x: 2345, y: 6.1},
                {x: 16789, y: 3.4}, {x: 8912, y: 4.2}, {x: 456, y: 7.8}, {x: 19234, y: 2.9}
            ];

            const padding = { top: 40, right: 30, bottom: 70, left: 70 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            // Clear
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, width, height);

            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, height - padding.bottom);
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.stroke();

            // Scale data
            const xMin = 0, xMax = 45000;
            const yMin = 0, yMax = 9;

            function scaleX(x) { return padding.left + (x - xMin) / (xMax - xMin) * plotWidth; }
            function scaleY(y) { return height - padding.bottom - (y - yMin) / (yMax - yMin) * plotHeight; }

            // Draw points
            ctx.fillStyle = 'rgba(192, 57, 43, 0.6)';
            data.forEach(p => {
                ctx.beginPath();
                ctx.arc(scaleX(p.x), scaleY(p.y), 8, 0, 2 * Math.PI);
                ctx.fill();
            });

            // Title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 18px system-ui, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Opinion During Marathon', width / 2, 25);

            // X-axis label with question
            ctx.font = '14px system-ui, sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('Meters Run', width / 2, height - 40);
            ctx.font = 'bold 18px system-ui, sans-serif';
            ctx.fillStyle = '#9c27b0';
            ctx.fillText('Interval or Ratio?', width / 2, height - 15);

            // Y-axis label with question
            ctx.save();
            ctx.translate(28, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = '14px system-ui, sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('Opinion of Running (0-9)', 0, 0);
            ctx.font = 'bold 18px system-ui, sans-serif';
            ctx.fillStyle = '#9c27b0';
            ctx.fillText('Interval or Ratio?', 0, 22);
            ctx.restore();

            // Add some tick marks
            ctx.fillStyle = '#999';
            ctx.font = '12px system-ui, sans-serif';
            ctx.textAlign = 'center';
            [0, 15000, 30000, 45000].forEach(v => {
                const x = scaleX(v);
                ctx.beginPath();
                ctx.moveTo(x, height - padding.bottom);
                ctx.lineTo(x, height - padding.bottom + 5);
                ctx.stroke();
                ctx.fillText(v >= 1000 ? (v/1000) + 'k' : v, x, height - padding.bottom + 18);
            });

            ctx.textAlign = 'right';
            [0, 3, 6, 9].forEach(v => {
                const y = scaleY(v);
                ctx.beginPath();
                ctx.moveTo(padding.left - 5, y);
                ctx.lineTo(padding.left, y);
                ctx.stroke();
                ctx.fillText(v, padding.left - 10, y + 4);
            });
        })();
        </script>

        <!-- Slide: Normal Distribution -->
        <div class="slide" style="padding: 30px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">When to use correlations?</h1>
            <div style="display: flex; gap: 40px; align-items: stretch; flex: 1;">
                <!-- Left: 3D Bivariate normal -->
                <div style="flex: 1.2; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <canvas id="bivariateNormal3D" width="580" height="500" style="border: 1px solid #ddd; border-radius: 8px; background: linear-gradient(180deg, #1a1a2e 0%, #2d3436 100%); cursor: grab;"></canvas>
                    <p style="font-size: 0.9em; color: #888; margin-top: 8px;">🖱️ Drag to pan/tilt · Scroll to zoom</p>
                </div>
                <!-- Right: Explanation -->
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                    <div style="background: #f3e5f5; padding: 30px 35px; border-radius: 16px; border-left: 6px solid #9c27b0;">
                        <p style="font-size: 1.4em; color: #333; margin: 0; line-height: 1.7;">
                            The traits you are measuring are <strong style="color: #9c27b0;">normally distributed</strong> in the population.
                        </p>
                        <p style="font-size: 1.15em; color: #555; margin-top: 20px; line-height: 1.6;">
                            Even though the data in your sample may not be normally distributed (if you plot them in a histogram they do not form a bell-shaped curve), you are pretty sure that if you could collect data from the <em>entire population</em>, the results would be normally distributed.
                        </p>
                    </div>
                    <p style="font-size: 1em; color: #666; margin-top: 20px; font-style: italic; text-align: center;">
                        The 3D surface shows probability density.<br>Red points show fire incident sample data.
                    </p>
                </div>
            </div>
        </div>

        <script>
        (function() {
            const canvas = document.getElementById('bivariateNormal3D');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Camera parameters (map-like view)
            let pitch = 0.55;  // Tilt angle (0 = top-down, 1.5 = side view)
            let panX = 0;      // Pan offset X
            let panY = 0;      // Pan offset Y
            let zoom = 140;    // Zoom level

            let isDragging = false;
            let lastX, lastY;

            // Fire incident data (normalized to -2 to 2 range for display)
            const fireData = [
                {x: 1.9, y: 16}, {x: 9.5, y: 85}, {x: 4.5, y: 40}, {x: 3.2, y: 23},
                {x: 1.0, y: 5}, {x: 1.0, y: 10}, {x: 0.7, y: 5}, {x: 6.5, y: 61},
                {x: 3.3, y: 31}, {x: 4.2, y: 31}, {x: 0.6, y: 5}, {x: 11.0, y: 94},
                {x: 5.9, y: 46}, {x: 1.2, y: 15}, {x: 1.1, y: 5}, {x: 1.1, y: 5},
                {x: 1.6, y: 12}, {x: 2.7, y: 22}, {x: 2.2, y: 15}, {x: 1.5, y: 15}
            ].map(p => ({
                x: (p.x - 3.5) / 2.5,
                y: (p.y - 28) / 20,
                origX: p.x,
                origY: p.y
            }));

            const rho = 0.85;

            function bivariateNormalPDF(x, y) {
                const z = x * x - 2 * rho * x * y + y * y;
                return Math.exp(-z / (2 * (1 - rho * rho)));
            }

            function project(x, y, z) {
                // Apply pan
                const xPanned = x - panX;
                const yPanned = y - panY;

                // Isometric-like projection with adjustable pitch
                // Looking from above and slightly to the side (like a map)
                const cosPitch = Math.cos(pitch);
                const sinPitch = Math.sin(pitch);

                // Project to screen (map-like: Y goes up-screen, X goes right)
                const screenX = xPanned * 0.866 - yPanned * 0.866;  // 30-degree isometric
                const screenY = (xPanned * 0.5 + yPanned * 0.5) * cosPitch - z * sinPitch * 2;
                const depth = (xPanned * 0.5 + yPanned * 0.5) * sinPitch + z * cosPitch;

                return {
                    x: width / 2 + screenX * zoom,
                    y: height / 2 + screenY * zoom,
                    z: depth
                };
            }

            function draw() {
                // Clear with gradient background (sky-like)
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.5, '#B0E0E6');
                gradient.addColorStop(1, '#E0F6FF');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);

                const gridSize = 50;
                const range = 2.5;
                const step = (range * 2) / gridSize;

                // Collect all surface quads for depth sorting
                const quads = [];

                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        const x1 = -range + i * step;
                        const y1 = -range + j * step;
                        const x2 = x1 + step;
                        const y2 = y1 + step;

                        const z1 = bivariateNormalPDF(x1, y1) * 1.2;
                        const z2 = bivariateNormalPDF(x2, y1) * 1.2;
                        const z3 = bivariateNormalPDF(x2, y2) * 1.2;
                        const z4 = bivariateNormalPDF(x1, y2) * 1.2;

                        const p1 = project(x1, y1, z1);
                        const p2 = project(x2, y1, z2);
                        const p3 = project(x2, y2, z3);
                        const p4 = project(x1, y2, z4);

                        const avgZ = (p1.z + p2.z + p3.z + p4.z) / 4;
                        const avgHeight = (z1 + z2 + z3 + z4) / 4;

                        quads.push({ p1, p2, p3, p4, avgZ, avgHeight });
                    }
                }

                // Sort by depth (back to front)
                quads.sort((a, b) => a.avgZ - b.avgZ);

                // Draw quads
                quads.forEach(q => {
                    ctx.beginPath();
                    ctx.moveTo(q.p1.x, q.p1.y);
                    ctx.lineTo(q.p2.x, q.p2.y);
                    ctx.lineTo(q.p3.x, q.p3.y);
                    ctx.lineTo(q.p4.x, q.p4.y);
                    ctx.closePath();

                    // Terrain-like coloring (green base, brown/white peaks)
                    const h = q.avgHeight;
                    let r, g, b;
                    if (h < 0.3) {
                        // Low: green grass
                        r = 76 + h * 100;
                        g = 140 + h * 80;
                        b = 60 + h * 40;
                    } else if (h < 0.7) {
                        // Mid: brownish
                        const t = (h - 0.3) / 0.4;
                        r = 106 + t * 80;
                        g = 164 - t * 40;
                        b = 72 + t * 30;
                    } else {
                        // High: snow-capped
                        const t = (h - 0.7) / 0.3;
                        r = 186 + t * 69;
                        g = 124 + t * 131;
                        b = 102 + t * 153;
                    }

                    // Add shading based on depth
                    const shade = 0.7 + 0.3 * (1 - q.avgZ / 3);
                    ctx.fillStyle = `rgb(${Math.round(r * shade)}, ${Math.round(g * shade)}, ${Math.round(b * shade)})`;
                    ctx.fill();

                    // Very subtle edges
                    ctx.strokeStyle = `rgba(0, 0, 0, 0.1)`;
                    ctx.lineWidth = 0.2;
                    ctx.stroke();
                });

                // Draw data points
                const points3D = fireData.map(p => {
                    const z = bivariateNormalPDF(p.x, p.y) * 1.2 + 0.08;
                    return { ...project(p.x, p.y, z), origX: p.origX, origY: p.origY };
                });

                // Sort points by depth
                points3D.sort((a, b) => a.z - b.z);

                points3D.forEach(p => {
                    // Pin shadow
                    ctx.beginPath();
                    ctx.ellipse(p.x + 2, p.y + 2, 5, 3, 0, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    ctx.fill();

                    // Pin
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 7, 0, 2 * Math.PI);
                    ctx.fillStyle = '#e74c3c';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Pin highlight
                    ctx.beginPath();
                    ctx.arc(p.x - 2, p.y - 2, 2, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(255,255,255,0.5)';
                    ctx.fill();
                });

                // Draw base grid lines for reference
                ctx.strokeStyle = 'rgba(0,0,0,0.15)';
                ctx.lineWidth = 1;
                for (let i = -2; i <= 2; i++) {
                    // Lines along X
                    const startX = project(-range, i, 0);
                    const endX = project(range, i, 0);
                    ctx.beginPath();
                    ctx.moveTo(startX.x, startX.y);
                    ctx.lineTo(endX.x, endX.y);
                    ctx.stroke();

                    // Lines along Y
                    const startY = project(i, -range, 0);
                    const endY = project(i, range, 0);
                    ctx.beginPath();
                    ctx.moveTo(startY.x, startY.y);
                    ctx.lineTo(endY.x, endY.y);
                    ctx.stroke();
                }

                // Axis labels at edges
                ctx.font = 'bold 14px system-ui, sans-serif';
                const xLabelPos = project(2.8, -2.5, 0);
                ctx.fillStyle = '#2c3e50';
                ctx.fillText('Structures Burned →', xLabelPos.x - 60, xLabelPos.y + 5);

                const yLabelPos = project(-2.8, 2.5, 0);
                ctx.fillText('← Firefighters', yLabelPos.x - 20, yLabelPos.y + 5);

                // Title
                ctx.font = 'bold 18px system-ui, sans-serif';
                ctx.fillStyle = '#2c3e50';
                ctx.textAlign = 'center';
                ctx.fillText('Bivariate Normal Distribution', width / 2, 30);

                // Subtitle
                ctx.font = '13px system-ui, sans-serif';
                ctx.fillStyle = '#666';
                ctx.fillText('Population from which fire incident data could be drawn', width / 2, 50);
            }

            // Mouse interaction - pan and tilt
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - lastX;
                const dy = e.clientY - lastY;

                // Horizontal drag = pan
                panX -= dx * 0.008;
                panY -= dx * 0.008;

                // Vertical drag = tilt
                pitch += dy * 0.008;
                pitch = Math.max(0.2, Math.min(1.2, pitch));

                lastX = e.clientX;
                lastY = e.clientY;
                draw();
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
                canvas.style.cursor = 'grab';
            });

            // Scroll to zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                zoom -= e.deltaY * 0.1;
                zoom = Math.max(80, Math.min(200, zoom));
                draw();
            });

            draw();
        })();
        </script>

        <!-- Slide: Linear Relationship -->
        <div class="slide" style="padding: 40px 60px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 20px;">When to use correlations?</h1>
            <div style="background: #e3f2fd; padding: 20px 30px; border-radius: 12px; border-left: 5px solid #2196f3; margin-bottom: 25px;">
                <p style="font-size: 1.3em; color: #333; margin: 0; line-height: 1.5;">
                    The relationship, if there is any, between the two variables is best characterized by a <strong style="color: #2196f3;">straight line</strong>.
                    If curvilinear, Pearson's ρ is not appropriate.
                </p>
            </div>
            <div style="display: flex; gap: 30px; justify-content: center; align-items: flex-start;">
                <div style="text-align: center;">
                    <canvas id="marathonLinearCanvas" width="420" height="320" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                    <p style="font-size: 1em; color: #666; margin-top: 8px;">Meters run vs Opinion (linear scale)</p>
                </div>
                <div style="text-align: center;">
                    <canvas id="marathonLogCanvas" width="420" height="320" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                    <p style="font-size: 1em; color: #666; margin-top: 8px;">Log₁₀(Meters run) vs Opinion</p>
                </div>
            </div>
            <h2 style="text-align: center; font-size: 2.2em; color: #1a1a2e; margin-top: 30px; font-weight: 500;">Should you use ρ?</h2>
        </div>
        <script>
        (function() {
            // Marathon data
            const marathonData = [
                [6736.2, 2.2], [563.9, 6.2], [394.0, 6.7], [2801.2, 4.8], [7740.9, 3.1],
                [1290.5, 6.7], [37563.1, 0.9], [6278.5, 3.4], [1830.5, 4.9], [1070.1, 5.4],
                [796.0, 6.1], [8202.5, 3.5], [1417.0, 6.2], [143.4, 7.0], [1109.1, 5.2],
                [8658.3, 2.8], [301.4, 7.8], [288.8, 7.0], [2485.8, 3.3], [2489.9, 4.7],
                [4628.8, 3.8], [16981.7, 2.4], [7977.8, 2.4], [4018.8, 5.2], [7881.4, 3.0],
                [704.5, 6.0], [890.8, 5.2], [397.4, 6.2], [590.3, 5.5], [4534.0, 3.6],
                [174.5, 7.2], [1375.9, 6.8], [1352.5, 4.0], [1977.2, 4.1], [1311.9, 5.1],
                [660.3, 6.7], [1316.1, 5.1], [22150.3, 2.4], [30106.9, 0.9], [2077.1, 4.9],
                [4345.5, 5.1], [201.2, 7.0], [680.7, 6.5], [1227.5, 5.6], [18805.6, 0.6],
                [454.5, 6.2]
            ];

            const meters = marathonData.map(d => d[0]);
            const opinion = marathonData.map(d => d[1]);
            const logMeters = meters.map(m => Math.log10(m));

            // Calculate correlations
            function correlation(x, y) {
                const n = x.length;
                const meanX = x.reduce((a, b) => a + b, 0) / n;
                const meanY = y.reduce((a, b) => a + b, 0) / n;
                let num = 0, denX = 0, denY = 0;
                for (let i = 0; i < n; i++) {
                    num += (x[i] - meanX) * (y[i] - meanY);
                    denX += (x[i] - meanX) ** 2;
                    denY += (y[i] - meanY) ** 2;
                }
                return num / Math.sqrt(denX * denY);
            }

            const rLinear = correlation(meters, opinion);
            const rLog = correlation(logMeters, opinion);

            function drawPlot(canvasId, xData, yData, xLabel, isLog, r) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const w = canvas.width, h = canvas.height;
                const margin = { top: 30, right: 30, bottom: 50, left: 55 };
                const plotW = w - margin.left - margin.right;
                const plotH = h - margin.top - margin.bottom;

                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, w, h);

                const xMin = Math.min(...xData) * 0.95;
                const xMax = Math.max(...xData) * 1.05;
                const yMin = 0;
                const yMax = 10;

                function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
                function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

                // Grid
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                for (let y = 0; y <= 10; y += 2) {
                    ctx.beginPath();
                    ctx.moveTo(margin.left, toCanvasY(y));
                    ctx.lineTo(w - margin.right, toCanvasY(y));
                    ctx.stroke();
                }

                // Axes
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, h - margin.bottom);
                ctx.lineTo(w - margin.right, h - margin.bottom);
                ctx.stroke();

                // Y-axis labels
                ctx.fillStyle = '#333';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                for (let y = 0; y <= 10; y += 2) {
                    ctx.fillText(y.toString(), margin.left - 8, toCanvasY(y) + 4);
                }

                // X-axis labels
                ctx.textAlign = 'center';
                if (isLog) {
                    for (let exp = 2; exp <= 4.5; exp += 0.5) {
                        const x = exp;
                        if (x >= xMin && x <= xMax) {
                            ctx.fillText(exp.toFixed(1), toCanvasX(x), h - margin.bottom + 18);
                        }
                    }
                } else {
                    for (let x = 0; x <= 40000; x += 10000) {
                        if (x >= xMin && x <= xMax) {
                            ctx.fillText((x / 1000) + 'k', toCanvasX(x), h - margin.bottom + 18);
                        }
                    }
                }

                // Axis titles
                ctx.font = '13px sans-serif';
                ctx.fillStyle = '#555';
                ctx.fillText(xLabel, margin.left + plotW / 2, h - 8);
                ctx.save();
                ctx.translate(15, margin.top + plotH / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Opinion of Running', 0, 0);
                ctx.restore();

                // Points
                ctx.fillStyle = isLog ? '#2e7d32' : '#c62828';
                for (let i = 0; i < xData.length; i++) {
                    ctx.beginPath();
                    ctx.arc(toCanvasX(xData[i]), toCanvasY(yData[i]), 5, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Linear regression line
                const n = xData.length;
                const meanX = xData.reduce((a, b) => a + b, 0) / n;
                const meanY = yData.reduce((a, b) => a + b, 0) / n;
                let num = 0, den = 0;
                for (let i = 0; i < n; i++) {
                    num += (xData[i] - meanX) * (yData[i] - meanY);
                    den += (xData[i] - meanX) ** 2;
                }
                const slope = num / den;
                const intercept = meanY - slope * meanX;

                ctx.strokeStyle = isLog ? 'rgba(46, 125, 50, 0.7)' : 'rgba(198, 40, 40, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash(isLog ? [] : [8, 4]);
                ctx.beginPath();
                ctx.moveTo(toCanvasX(xMin), toCanvasY(intercept + slope * xMin));
                ctx.lineTo(toCanvasX(xMax), toCanvasY(intercept + slope * xMax));
                ctx.stroke();
                ctx.setLineDash([]);

                // Correlation label
                ctx.font = 'bold 14px sans-serif';
                ctx.fillStyle = isLog ? '#2e7d32' : '#c62828';
                ctx.textAlign = 'left';
                ctx.fillText('ρ = ' + r.toFixed(3), margin.left + 10, margin.top + 20);
            }

            // Draw both plots
            drawPlot('marathonLinearCanvas', meters, opinion, 'Meters Run', false, rLinear);
            drawPlot('marathonLogCanvas', logMeters, opinion, 'Log₁₀(Meters Run)', true, rLog);
        })();
        </script>

        <!-- Slide: Homoscedasticity -->
        <div class="slide" style="padding: 30px 60px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">When to use correlations?</h1>
            <div style="display: flex; gap: 30px; align-items: flex-start;">
                <div style="background: #fce4ec; padding: 20px 25px; border-radius: 12px; border-left: 5px solid #e91e63; flex: 1;">
                    <h2 style="font-size: 1.5em; color: #e91e63; margin: 0 0 10px 0;">Homoscedasticity</h2>
                    <p style="font-size: 1.15em; color: #333; margin: 0; line-height: 1.5;">
                        Scores on the Y variable are <strong>normally distributed</strong> across each value of X.
                        The spread (variance) of Y should be roughly the same at all levels of X.
                    </p>
                </div>
                <div style="background: #fff3e0; padding: 20px 25px; border-radius: 12px; border-left: 5px solid #ff9800; flex: 1;">
                    <p style="font-size: 1.1em; color: #555; margin: 0; line-height: 1.5;">
                        <strong style="color: #e65100;">Example:</strong> Income variance is high for those with less education (some dropouts become wealthy), but changes at higher education levels.
                    </p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <canvas id="homoscedasticityCanvas" width="900" height="400" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                <p style="font-size: 1em; color: #e91e63; margin-top: 6px; font-weight: 500;">⚠️ Heteroscedastic — Variance changes with X</p>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('homoscedasticityCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Generate schooling vs income data
            let seed = 42;
            function seededRandom() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            }
            function gaussianRandom() {
                let u = 0, v = 0;
                while (u === 0) u = seededRandom();
                while (v === 0) v = seededRandom();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            const data = [];

            // Distribution of schooling years
            const n = 150;
            for (let i = 0; i < n; i++) {
                let schooling;
                const r = seededRandom();
                if (r < 0.03) {
                    schooling = 4 + seededRandom() * 4;
                } else if (r < 0.15) {
                    schooling = 8 + seededRandom() * 4;
                } else if (r < 0.45) {
                    schooling = 12 + seededRandom() * 2;
                } else if (r < 0.75) {
                    schooling = 14 + seededRandom() * 2;
                } else {
                    schooling = 16 + seededRandom() * 3;
                }

                const baseIncome = 20 + (schooling - 4) * 8;
                const varianceFactor = Math.max(5, 50 - schooling * 2.5);
                let income = baseIncome + gaussianRandom() * varianceFactor;
                income = Math.max(15, income);
                data.push({ schooling, income });
            }

            // College dropouts - mixed outcomes (some rich, some poor)
            const dropouts = [
                // Wealthy dropouts
                { schooling: 12 + seededRandom() * 2, income: 180 + seededRandom() * 70 },
                { schooling: 13 + seededRandom() * 1.5, income: 160 + seededRandom() * 60 },
                { schooling: 10 + seededRandom() * 2, income: 140 + seededRandom() * 50 },
                { schooling: 14 + seededRandom() * 1, income: 200 + seededRandom() * 80 },
                { schooling: 11 + seededRandom() * 2, income: 170 + seededRandom() * 40 },
                // Struggling dropouts
                { schooling: 10 + seededRandom() * 2, income: 22 + seededRandom() * 10 },
                { schooling: 11 + seededRandom() * 2, income: 18 + seededRandom() * 12 },
                { schooling: 12 + seededRandom() * 1, income: 25 + seededRandom() * 8 },
                { schooling: 9 + seededRandom() * 2, income: 20 + seededRandom() * 10 },
                { schooling: 13 + seededRandom() * 1, income: 28 + seededRandom() * 12 },
            ];
            data.push(...dropouts);

            // Doctors and lawyers - mixed outcomes
            const medLaw = [
                // Well-paid specialists, partners
                { schooling: 19 + seededRandom() * 1.5, income: 180 + seededRandom() * 60 },
                { schooling: 20 + seededRandom() * 1, income: 220 + seededRandom() * 50 },
                { schooling: 20 + seededRandom() * 1.5, income: 250 + seededRandom() * 40 },
                { schooling: 19 + seededRandom() * 2, income: 200 + seededRandom() * 50 },
                // Residents, public defenders, rural doctors
                { schooling: 19 + seededRandom() * 1, income: 55 + seededRandom() * 20 },
                { schooling: 20 + seededRandom() * 1, income: 65 + seededRandom() * 25 },
                { schooling: 19.5 + seededRandom() * 1, income: 70 + seededRandom() * 20 },
                { schooling: 20 + seededRandom() * 1.5, income: 80 + seededRandom() * 30 },
            ];
            data.push(...medLaw);

            // Academics - mixed outcomes
            const academics = [
                // Postdocs and adjuncts
                { schooling: 22 + seededRandom() * 2, income: 55 + seededRandom() * 20 },
                { schooling: 23 + seededRandom() * 2, income: 50 + seededRandom() * 15 },
                { schooling: 22 + seededRandom() * 1, income: 48 + seededRandom() * 15 },
                { schooling: 24 + seededRandom() * 1, income: 60 + seededRandom() * 15 },
                // Tenured professors, senior researchers
                { schooling: 23 + seededRandom() * 2, income: 110 + seededRandom() * 30 },
                { schooling: 24 + seededRandom() * 1, income: 130 + seededRandom() * 40 },
                { schooling: 25 + seededRandom() * 1, income: 95 + seededRandom() * 25 },
                { schooling: 22 + seededRandom() * 1.5, income: 120 + seededRandom() * 35 },
            ];
            data.push(...academics);

            const schooling = data.map(d => d.schooling);
            const income = data.map(d => d.income);

            const xMin = 2, xMax = 26;
            const yMin = 0, yMax = 300;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            // Background
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let y = 0; y <= 300; y += 50) {
                ctx.beginPath();
                ctx.moveTo(margin.left, toCanvasY(y));
                ctx.lineTo(w - margin.right, toCanvasY(y));
                ctx.stroke();
            }
            for (let x = 4; x <= 24; x += 4) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(x), margin.top);
                ctx.lineTo(toCanvasX(x), h - margin.bottom);
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, h - margin.bottom);
            ctx.lineTo(w - margin.right, h - margin.bottom);
            ctx.stroke();

            // Y-axis labels
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            for (let y = 0; y <= 300; y += 50) {
                ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
            }

            // X-axis labels
            ctx.textAlign = 'center';
            for (let x = 4; x <= 24; x += 4) {
                ctx.fillText(x.toString(), toCanvasX(x), h - margin.bottom + 18);
            }

            // Axis titles
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#555';
            ctx.fillText('Years of Schooling', margin.left + plotW / 2, h - 8);
            ctx.save();
            ctx.translate(18, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Annual Income', 0, 0);
            ctx.restore();

            // Calculate and draw variance band
            // Group data by schooling bins and calculate local variance
            const binWidth = 3;
            const bins = [];
            for (let x = 4; x <= 24; x += 1) {
                const binData = data.filter(d => d.schooling >= x - binWidth/2 && d.schooling < x + binWidth/2);
                if (binData.length > 2) {
                    const incomes = binData.map(d => d.income);
                    const mean = incomes.reduce((a, b) => a + b, 0) / incomes.length;
                    const variance = incomes.reduce((a, b) => a + (b - mean) ** 2, 0) / incomes.length;
                    const std = Math.sqrt(variance);
                    bins.push({ x, mean, std, n: binData.length });
                }
            }

            // Draw variance band (±1.5 std from local mean)
            if (bins.length > 2) {
                ctx.fillStyle = 'rgba(233, 30, 99, 0.12)';
                ctx.beginPath();
                // Upper edge
                ctx.moveTo(toCanvasX(bins[0].x), toCanvasY(bins[0].mean + bins[0].std * 1.5));
                for (let i = 1; i < bins.length; i++) {
                    ctx.lineTo(toCanvasX(bins[i].x), toCanvasY(bins[i].mean + bins[i].std * 1.5));
                }
                // Lower edge (reverse)
                for (let i = bins.length - 1; i >= 0; i--) {
                    ctx.lineTo(toCanvasX(bins[i].x), toCanvasY(Math.max(0, bins[i].mean - bins[i].std * 1.5)));
                }
                ctx.closePath();
                ctx.fill();

                // Draw band edges
                ctx.strokeStyle = 'rgba(233, 30, 99, 0.3)';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(toCanvasX(bins[0].x), toCanvasY(bins[0].mean + bins[0].std * 1.5));
                for (let i = 1; i < bins.length; i++) {
                    ctx.lineTo(toCanvasX(bins[i].x), toCanvasY(bins[i].mean + bins[i].std * 1.5));
                }
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(toCanvasX(bins[0].x), toCanvasY(Math.max(0, bins[0].mean - bins[0].std * 1.5)));
                for (let i = 1; i < bins.length; i++) {
                    ctx.lineTo(toCanvasX(bins[i].x), toCanvasY(Math.max(0, bins[i].mean - bins[i].std * 1.5)));
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Labels for regions
            ctx.font = 'italic 11px sans-serif';
            ctx.fillStyle = '#888';
            ctx.textAlign = 'center';
            ctx.fillText('dropouts', toCanvasX(11), toCanvasY(240));
            ctx.fillStyle = '#ff9800';
            ctx.fillText('medicine / law', toCanvasX(20), toCanvasY(270));
            ctx.fillStyle = '#2196f3';
            ctx.fillText('academics', toCanvasX(24), toCanvasY(95));

            // Points - regular data
            ctx.fillStyle = '#e91e63';
            for (let i = 0; i < n; i++) {
                ctx.beginPath();
                ctx.arc(toCanvasX(data[i].schooling), toCanvasY(data[i].income), 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Points - dropouts (green)
            ctx.fillStyle = '#4caf50';
            for (let i = n; i < n + dropouts.length; i++) {
                ctx.beginPath();
                ctx.arc(toCanvasX(data[i].schooling), toCanvasY(data[i].income), 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Points - medicine/law (orange)
            ctx.fillStyle = '#ff9800';
            for (let i = n + dropouts.length; i < n + dropouts.length + medLaw.length; i++) {
                ctx.beginPath();
                ctx.arc(toCanvasX(data[i].schooling), toCanvasY(data[i].income), 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Points - academics (blue)
            ctx.fillStyle = '#2196f3';
            for (let i = n + dropouts.length + medLaw.length; i < data.length; i++) {
                ctx.beginPath();
                ctx.arc(toCanvasX(data[i].schooling), toCanvasY(data[i].income), 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Regression line
            const n2 = schooling.length;
            const meanX = schooling.reduce((a, b) => a + b, 0) / n2;
            const meanY = income.reduce((a, b) => a + b, 0) / n2;
            let num = 0, den = 0;
            for (let i = 0; i < n2; i++) {
                num += (schooling[i] - meanX) * (income[i] - meanY);
                den += (schooling[i] - meanX) ** 2;
            }
            const slope = num / den;
            const intercept = meanY - slope * meanX;

            ctx.strokeStyle = 'rgba(233, 30, 99, 0.7)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(toCanvasX(xMin), toCanvasY(intercept + slope * xMin));
            ctx.lineTo(toCanvasX(xMax), toCanvasY(intercept + slope * xMax));
            ctx.stroke();
        })();
        </script>

        <!-- Slide: Correlation Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 4em; color: #fff; font-weight: 300;">5. Correlation</h1>
        </div>

        <!-- Slide 6: Correlation Coefficient -->
        <div class="slide">
            <h1>What is the correlation coefficient ρ?</h1>
            <ul>
                <li>A <strong>single summary number</strong></li>
                <li>Tells you how closely one variable is related to another</li>
                <li>Range: <code>-1</code> to <code>+1</code>
                    <ul>
                        <li><strong>ρ = +1</strong>: Perfect positive correlation</li>
                        <li><strong>ρ = -1</strong>: Perfect negative correlation</li>
                        <li><strong>ρ = 0</strong>: No correlation</li>
                    </ul>
                </li>
            </ul>
        </div>

        <!-- Slide 7: Regression Analysis Interstitial -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="regression_analysis_background.svg" style="position: absolute; width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
                <h1 style="font-size: 5em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.5); margin: 0; font-weight: 300; letter-spacing: 0.05em;">Regression Analysis</h1>
            </div>
        </div>

        <!-- Slide: Regression Quotes -->
        <div class="slide" style="padding: 50px 80px; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);">
            <div style="max-width: 950px; margin: 0 auto;">
                <blockquote style="font-size: 1.4em; color: #2c3e50; line-height: 1.5; font-style: italic; border-left: 5px solid #3498db; padding-left: 30px; margin: 0 0 20px 0;">
                    "Linear regression is a method that summarizes how the average values of a numerical outcome variable vary over subpopulations defined by linear functions of predictors."
                </blockquote>
                <p style="font-size: 1.1em; color: #7f8c8d; margin-bottom: 35px; text-align: right;">
                    — Gelman & Hill (2007)
                </p>
                <blockquote style="font-size: 1.4em; color: #2c3e50; line-height: 1.5; font-style: italic; border-left: 5px solid #e74c3c; padding-left: 30px; margin: 0;">
                    "Offers a concise summary of the mean of the response variable as a function of the explanatory variable through two parameters: the slope and the intercept of the line."
                </blockquote>
                <p style="font-size: 1.1em; color: #7f8c8d; margin-top: 20px; text-align: right;">
                    — Ramsey & Schafer (2002)
                </p>
                <div style="margin-top: 40px; padding-top: 25px; border-top: 1px solid #ccc;">
                    <p style="font-size: 0.85em; color: #666; line-height: 1.8; margin: 0;">
                        Gelman, A., & Hill, J. (2007). <em>Data analysis using regression and multilevel/hierarchical models</em>. Cambridge University Press.
                    </p>
                    <p style="font-size: 0.85em; color: #666; line-height: 1.8; margin: 10px 0 0 0;">
                        Ramsey, F. L., & Schafer, D. W. (2002). <em>The statistical sleuth: A course in methods of data analysis</em> (2nd ed.). Duxbury Press.
                    </p>
                </div>
            </div>
        </div>

        <!-- Slide: Use Regression For - Description -->
        <div class="slide" style="padding: 30px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">Use Regression For: <span style="color: #2e7d32;">Description</span></h1>
            <div style="background: #e8f5e9; padding: 15px 25px; border-radius: 12px; border-left: 5px solid #4caf50; margin-bottom: 20px; display: inline-block;">
                <p style="font-size: 1.2em; color: #333; margin: 0; line-height: 1.5;">
                    To see on average how much groups differ on a certain outcome variable.
                </p>
            </div>
            <div style="text-align: center;">
                <canvas id="descriptionCanvas" width="850" height="480" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            // Shared data generation for regression slides
            window.regressionData = window.regressionData || (function() {
                let seed = 123;
                function seededRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                function gaussianRandom() {
                    let u = 0, v = 0;
                    while (u === 0) u = seededRandom();
                    while (v === 0) v = seededRandom();
                    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }

                // Same intercept (100), different slopes
                const intercept = 100;
                const slope1 = 4.0;  // Steeper slope (Group A)
                const slope2 = 1.5;  // Gentler slope (Group B)

                // Group 1: Steeper slope
                const group1 = [];
                for (let i = 0; i < 30; i++) {
                    const x = 20 + seededRandom() * 100;
                    const y = intercept + x * slope1 + gaussianRandom() * 35;
                    group1.push({ x, y });
                }

                // Group 2: Gentler slope
                const group2 = [];
                for (let i = 0; i < 30; i++) {
                    const x = 20 + seededRandom() * 100;
                    const y = intercept + x * slope2 + gaussianRandom() * 35;
                    group2.push({ x, y });
                }

                const allData = [...group1, ...group2];

                // Calculate regression for combined data
                function calcRegression(data) {
                    const n = data.length;
                    const meanX = data.reduce((a, d) => a + d.x, 0) / n;
                    const meanY = data.reduce((a, d) => a + d.y, 0) / n;
                    let num = 0, den = 0;
                    for (const d of data) {
                        num += (d.x - meanX) * (d.y - meanY);
                        den += (d.x - meanX) ** 2;
                    }
                    const slope = num / den;
                    const intercept = meanY - slope * meanX;
                    return { slope, intercept };
                }

                const regAll = calcRegression(allData);

                return {
                    group1, group2, allData,
                    intercept, slope1, slope2,
                    regAll,
                    xMin: 10, xMax: 130,
                    yMin: 50, yMax: 550
                };
            })();

            const data = window.regressionData;

            // Description canvas - two groups with different colors
            const descCanvas = document.getElementById('descriptionCanvas');
            if (descCanvas) {
                const ctx = descCanvas.getContext('2d');
                const w = descCanvas.width, h = descCanvas.height;
                const margin = { top: 30, right: 40, bottom: 60, left: 70 };
                const plotW = w - margin.left - margin.right;
                const plotH = h - margin.top - margin.bottom;

                function toCanvasX(x) { return margin.left + (x - data.xMin) / (data.xMax - data.xMin) * plotW; }
                function toCanvasY(y) { return margin.top + (1 - (y - data.yMin) / (data.yMax - data.yMin)) * plotH; }

                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                for (let y = 100; y <= 500; y += 100) {
                    ctx.beginPath();
                    ctx.moveTo(margin.left, toCanvasY(y));
                    ctx.lineTo(w - margin.right, toCanvasY(y));
                    ctx.stroke();
                }

                // Axes
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, h - margin.bottom);
                ctx.lineTo(w - margin.right, h - margin.bottom);
                ctx.stroke();

                // Axis labels
                ctx.fillStyle = '#555';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('sq.m.', margin.left + plotW / 2, h - 15);
                ctx.save();
                ctx.translate(22, margin.top + plotH / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('price', 0, 0);
                ctx.restore();

                // Draw regression lines
                ctx.lineWidth = 4;

                // Group 1 line (teal) - steeper
                ctx.strokeStyle = '#009688';
                ctx.beginPath();
                ctx.moveTo(toCanvasX(data.xMin), toCanvasY(data.intercept + data.slope1 * data.xMin));
                ctx.lineTo(toCanvasX(data.xMax), toCanvasY(data.intercept + data.slope1 * data.xMax));
                ctx.stroke();

                // Group 2 line (orange) - gentler
                ctx.strokeStyle = '#ff7043';
                ctx.beginPath();
                ctx.moveTo(toCanvasX(data.xMin), toCanvasY(data.intercept + data.slope2 * data.xMin));
                ctx.lineTo(toCanvasX(data.xMax), toCanvasY(data.intercept + data.slope2 * data.xMax));
                ctx.stroke();

                // Draw points - Group 1 (teal)
                ctx.fillStyle = '#009688aa';
                for (const d of data.group1) {
                    ctx.beginPath();
                    ctx.arc(toCanvasX(d.x), toCanvasY(d.y), 6, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Draw points - Group 2 (orange)
                ctx.fillStyle = '#ff7043aa';
                for (const d of data.group2) {
                    ctx.beginPath();
                    ctx.arc(toCanvasX(d.x), toCanvasY(d.y), 6, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Labels
                ctx.font = 'bold 16px sans-serif';
                ctx.fillStyle = '#009688';
                ctx.textAlign = 'left';
                ctx.fillText('Group A', toCanvasX(100), toCanvasY(data.intercept + data.slope1 * 100) - 15);
                ctx.fillStyle = '#ff7043';
                ctx.fillText('Group B', toCanvasX(100), toCanvasY(data.intercept + data.slope2 * 100) + 25);

                // Show same intercept
                ctx.fillStyle = '#333';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('Same intercept', toCanvasX(data.xMin) + 10, toCanvasY(data.intercept) - 10);
                ctx.beginPath();
                ctx.arc(toCanvasX(data.xMin), toCanvasY(data.intercept), 8, 0, Math.PI * 2);
                ctx.fillStyle = '#333';
                ctx.fill();
            }
        })();
        </script>

        <!-- Slide: Use Regression For - Prediction -->
        <div class="slide" style="padding: 30px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">Use Regression For: <span style="color: #1976d2;">Prediction</span></h1>
            <div style="background: #e3f2fd; padding: 15px 25px; border-radius: 12px; border-left: 5px solid #2196f3; margin-bottom: 20px; display: inline-block;">
                <p style="font-size: 1.2em; color: #333; margin: 0; line-height: 1.5;">
                    To predict, on average, expected change in the outcome with change in the predictors.
                </p>
            </div>
            <div style="text-align: center;">
                <canvas id="predictionCanvas" width="850" height="480" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            const data = window.regressionData;
            if (!data) return;

            const predCanvas = document.getElementById('predictionCanvas');
            if (predCanvas) {
                const ctx = predCanvas.getContext('2d');
                const w = predCanvas.width, h = predCanvas.height;
                const margin = { top: 30, right: 40, bottom: 60, left: 70 };
                const plotW = w - margin.left - margin.right;
                const plotH = h - margin.top - margin.bottom;

                function toCanvasX(x) { return margin.left + (x - data.xMin) / (data.xMax - data.xMin) * plotW; }
                function toCanvasY(y) { return margin.top + (1 - (y - data.yMin) / (data.yMax - data.yMin)) * plotH; }

                // Fixed X for the prediction dot
                const predX = 85;
                const predYBase = data.regAll.intercept + data.regAll.slope * predX;
                let animTime = 0;

                function draw() {
                    ctx.fillStyle = '#fafafa';
                    ctx.fillRect(0, 0, w, h);

                    // Grid
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    for (let y = 100; y <= 500; y += 100) {
                        ctx.beginPath();
                        ctx.moveTo(margin.left, toCanvasY(y));
                        ctx.lineTo(w - margin.right, toCanvasY(y));
                        ctx.stroke();
                    }

                    // Axes
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(margin.left, margin.top);
                    ctx.lineTo(margin.left, h - margin.bottom);
                    ctx.lineTo(w - margin.right, h - margin.bottom);
                    ctx.stroke();

                    // Axis labels
                    ctx.fillStyle = '#555';
                    ctx.font = '16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('sq.m.', margin.left + plotW / 2, h - 15);
                    ctx.save();
                    ctx.translate(22, margin.top + plotH / 2);
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText('price', 0, 0);
                    ctx.restore();

                    // Draw all points in grey
                    ctx.fillStyle = '#bbb';
                    for (const d of data.allData) {
                        ctx.beginPath();
                        ctx.arc(toCanvasX(d.x), toCanvasY(d.y), 5, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // Draw overall regression line
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(toCanvasX(data.xMin), toCanvasY(data.regAll.intercept + data.regAll.slope * data.xMin));
                    ctx.lineTo(toCanvasX(data.xMax), toCanvasY(data.regAll.intercept + data.regAll.slope * data.xMax));
                    ctx.stroke();

                    // Animated prediction dot
                    animTime += 0.025;
                    const predY = predYBase + Math.sin(animTime) * 50 + Math.sin(animTime * 0.7) * 25;

                    // Vertical dashed line from x-axis to dot
                    ctx.strokeStyle = '#e53935';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([6, 6]);
                    ctx.beginPath();
                    ctx.moveTo(toCanvasX(predX), toCanvasY(data.yMin));
                    ctx.lineTo(toCanvasX(predX), toCanvasY(predY));
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Red prediction dot
                    ctx.fillStyle = '#e53935';
                    ctx.beginPath();
                    ctx.arc(toCanvasX(predX), toCanvasY(predY), 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#b71c1c';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Question marks
                    ctx.font = 'bold 22px sans-serif';
                    ctx.fillStyle = '#e53935';
                    ctx.textAlign = 'center';
                    const qY = toCanvasY(predY) - 25;
                    ctx.fillText('?', toCanvasX(predX) - 20, qY);
                    ctx.fillText('?', toCanvasX(predX) + 20, qY);
                    ctx.font = 'bold 28px sans-serif';
                    ctx.fillText('?', toCanvasX(predX), qY - 22);

                    requestAnimationFrame(draw);
                }

                draw();
            }
        })();
        </script>

        <!-- Slide: Example 1 - Child Height -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="https://images.unsplash.com/photo-1609220136736-443140cffec6?w=1600&fit=crop"
                 style="position: absolute; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.5);"
                 alt="Father carrying daughter">
            <div style="position: absolute; top: 0; left: 0; right: 0; padding: 30px 50px; z-index: 10;">
                <p style="font-size: 1.2em; color: rgba(255,255,255,0.7); margin: 0; text-transform: uppercase; letter-spacing: 0.1em;">Examples</p>
            </div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; max-width: 80%;">
                <h1 style="font-size: 2.8em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.7); margin: 0; font-weight: 400; line-height: 1.4;">
                    Predicting average height of a child from their parents' height
                </h1>
            </div>
            <p style="position: absolute; bottom: 15px; right: 20px; font-size: 0.75em; color: rgba(255,255,255,0.6); z-index: 10; margin: 0;">
                Photo by <a href="https://unsplash.com/@nate_dumlao" style="color: rgba(255,255,255,0.8);">Nathan Dumlao</a> on <a href="https://unsplash.com" style="color: rgba(255,255,255,0.8);">Unsplash</a>
            </p>
        </div>

        <!-- Slide: Example 2 - Crop Yield -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=1600&fit=crop"
                 style="position: absolute; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.5);"
                 alt="Golden wheat field">
            <div style="position: absolute; top: 0; left: 0; right: 0; padding: 30px 50px; z-index: 10;">
                <p style="font-size: 1.2em; color: rgba(255,255,255,0.7); margin: 0; text-transform: uppercase; letter-spacing: 0.1em;">Examples</p>
            </div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; max-width: 80%;">
                <h1 style="font-size: 2.8em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.7); margin: 0; font-weight: 400; line-height: 1.4;">
                    Looking at the average amount of yield of crop for given rainfall and temperature
                </h1>
            </div>
            <p style="position: absolute; bottom: 15px; right: 20px; font-size: 0.75em; color: rgba(255,255,255,0.6); z-index: 10; margin: 0;">
                Photo by <a href="https://unsplash.com/@anikinearthwalker" style="color: rgba(255,255,255,0.8);">Annika Persson</a> on <a href="https://unsplash.com" style="color: rgba(255,255,255,0.8);">Unsplash</a>
            </p>
        </div>

        <!-- Slide: Example 3 - Income -->
        <div class="slide" style="padding: 0; position: relative; overflow: hidden;">
            <img src="https://images.unsplash.com/photo-1541339907198-e08756dedf3f?w=1600&fit=crop"
                 style="position: absolute; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.5);"
                 alt="Graduation caps thrown in air">
            <div style="position: absolute; top: 0; left: 0; right: 0; padding: 30px 50px; z-index: 10;">
                <p style="font-size: 1.2em; color: rgba(255,255,255,0.7); margin: 0; text-transform: uppercase; letter-spacing: 0.1em;">Examples</p>
            </div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; max-width: 85%;">
                <h1 style="font-size: 2.5em; color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.7); margin: 0; font-weight: 400; line-height: 1.4;">
                    Describing average income of a person, stratified by education, income of the parents, and other socio-economic information
                </h1>
            </div>
            <p style="position: absolute; bottom: 15px; right: 20px; font-size: 0.75em; color: rgba(255,255,255,0.6); z-index: 10; margin: 0;">
                Photo by <a href="https://unsplash.com/@juanmramosjr" style="color: rgba(255,255,255,0.8);">Juan Ramos</a> on <a href="https://unsplash.com" style="color: rgba(255,255,255,0.8);">Unsplash</a>
            </p>
        </div>

        <!-- Slide: Regression Basics Interstitial -->
        <div class="slide lead" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 4em; color: #fff; font-weight: 300;">Regression Basics</h1>
        </div>

        <!-- Slide: Formula / Variables -->
        <div class="slide" style="padding: 60px 80px; background: #fff;">
            <h1 style="font-size: 2.4em; color: #1a1a2e; font-weight: 400; margin-bottom: 50px;">Variables in Regression</h1>
            <div style="display: flex; gap: 50px; align-items: flex-start;">
                <div style="flex: 1; background: #e3f2fd; padding: 30px 35px; border-radius: 16px; border-left: 6px solid #2196f3;">
                    <p style="font-size: 2em; color: #1976d2; margin: 0 0 15px 0; font-family: 'Times New Roman', serif; font-style: italic;">
                        Y = <span style="font-size: 0.85em;">response variable</span>
                    </p>
                    <p style="font-size: 1.2em; color: #555; margin: 0; line-height: 1.6;">
                        (continuous)
                    </p>
                    <p style="font-size: 1.1em; color: #666; margin-top: 20px; padding-top: 15px; border-top: 1px solid #90caf9;">
                        Also known as <strong>Dependent Variable</strong>
                    </p>
                </div>
                <div style="flex: 1; background: #fff3e0; padding: 30px 35px; border-radius: 16px; border-left: 6px solid #ff9800;">
                    <p style="font-size: 2em; color: #e65100; margin: 0 0 15px 0; font-family: 'Times New Roman', serif; font-style: italic;">
                        X<sub>1</sub>, X<sub>2</sub>, ... X<sub>n</sub>
                    </p>
                    <p style="font-size: 1.2em; color: #555; margin: 0; line-height: 1.6;">
                        predictor / explanatory variables
                    </p>
                    <p style="font-size: 1.1em; color: #666; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ffcc80;">
                        (continuous, discrete, or categorical)
                    </p>
                </div>
            </div>
        </div>

        <!-- Slide: Simple Regression -->
        <div class="slide" style="padding: 30px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 5px;">Simple Regression</h1>
            <p style="font-size: 1.3em; color: #666; margin-bottom: 20px;">One explanatory variable</p>
            <div style="text-align: center;">
                <canvas id="simpleRegressionCanvas" width="900" height="480" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('simpleRegressionCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 30, right: 40, bottom: 60, left: 80 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Generate data: sq.m. vs price
            let seed = 456;
            function seededRandom() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            }
            function gaussianRandom() {
                let u = 0, v = 0;
                while (u === 0) u = seededRandom();
                while (v === 0) v = seededRandom();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            const data = [];
            for (let i = 0; i < 60; i++) {
                const sqm = 30 + seededRandom() * 150;
                const price = 50 + sqm * 3.2 + gaussianRandom() * 50;
                data.push({ sqm, price });
            }

            const xMin = 20, xMax = 190;
            const yMin = 0, yMax = 700;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            // Background
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let y = 100; y <= 600; y += 100) {
                ctx.beginPath();
                ctx.moveTo(margin.left, toCanvasY(y));
                ctx.lineTo(w - margin.right, toCanvasY(y));
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, h - margin.bottom);
            ctx.lineTo(w - margin.right, h - margin.bottom);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#333';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'right';
            for (let y = 0; y <= 600; y += 100) {
                ctx.fillText('$' + y + 'k', margin.left - 10, toCanvasY(y) + 5);
            }
            ctx.textAlign = 'center';
            for (let x = 50; x <= 180; x += 50) {
                ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 20);
            }

            // Axis titles
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#555';
            ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 12);
            ctx.save();
            ctx.translate(25, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Price ($k)', 0, 0);
            ctx.restore();

            // Points
            ctx.fillStyle = '#3498dbaa';
            for (const d of data) {
                ctx.beginPath();
                ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Regression line
            const n = data.length;
            const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
            const meanY = data.reduce((a, d) => a + d.price, 0) / n;
            let num = 0, den = 0;
            for (const d of data) {
                num += (d.sqm - meanX) * (d.price - meanY);
                den += (d.sqm - meanX) ** 2;
            }
            const slope = num / den;
            const intercept = meanY - slope * meanX;

            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(toCanvasX(xMin), toCanvasY(intercept + slope * xMin));
            ctx.lineTo(toCanvasX(xMax), toCanvasY(intercept + slope * xMax));
            ctx.stroke();

            // Formula
            ctx.font = 'italic 18px serif';
            ctx.fillStyle = '#c0392b';
            ctx.textAlign = 'left';
            ctx.fillText('Price = β₀ + β₁ × sq.m.', margin.left + 20, margin.top + 30);
        })();
        </script>

        <!-- Slide: Multiple Regression -->
        <div class="slide" style="padding: 25px 40px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 5px;">Multivariate / Multiple Regression</h1>
            <p style="font-size: 1.2em; color: #666; margin-bottom: 10px;">More than one explanatory variable</p>
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <div style="flex: 1; text-align: center;">
                    <canvas id="multipleRegressionCanvas" width="750" height="500" style="border: 1px solid #ddd; border-radius: 8px; background: linear-gradient(180deg, #1a1a2e 0%, #2d3748 100%);"></canvas>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 10px;">
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                        <p style="font-size: 0.85em; color: #666; margin: 0 0 8px 0; font-weight: 600;">Rotate</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
                            <div></div>
                            <button id="mr3d-rotUp" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">↑</button>
                            <div></div>
                            <button id="mr3d-rotLeft" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">←</button>
                            <button id="mr3d-rotReset" style="padding: 8px; font-size: 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">⟲</button>
                            <button id="mr3d-rotRight" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">→</button>
                            <div></div>
                            <button id="mr3d-rotDown" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">↓</button>
                            <div></div>
                        </div>
                    </div>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                        <p style="font-size: 0.85em; color: #666; margin: 0 0 8px 0; font-weight: 600;">Zoom</p>
                        <div style="display: flex; gap: 4px;">
                            <button id="mr3d-zoomIn" style="flex: 1; padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">+</button>
                            <button id="mr3d-zoomOut" style="flex: 1; padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">−</button>
                        </div>
                    </div>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                        <p style="font-size: 0.85em; color: #666; margin: 0 0 8px 0; font-weight: 600;">Pan</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
                            <div></div>
                            <button id="mr3d-panUp" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">↑</button>
                            <div></div>
                            <button id="mr3d-panLeft" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">←</button>
                            <div></div>
                            <button id="mr3d-panRight" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">→</button>
                            <div></div>
                            <button id="mr3d-panDown" style="padding: 8px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff;">↓</button>
                            <div></div>
                        </div>
                    </div>
                    <div style="background: #fff3e0; padding: 10px; border-radius: 8px; margin-top: 5px;">
                        <p style="font-size: 0.75em; color: #666; margin: 0; font-weight: 600;">Rooms:</p>
                        <div id="mr3d-legend" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('multipleRegressionCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;

            // Generate 3D data: sq.m., rooms, price
            let seed = 789;
            function seededRandom() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            }
            function gaussianRandom() {
                let u = 0, v = 0;
                while (u === 0) u = seededRandom();
                while (v === 0) v = seededRandom();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            const data3d = [];
            for (let i = 0; i < 80; i++) {
                const sqm = 30 + seededRandom() * 150;
                const rooms = Math.max(1, Math.min(6, Math.round(sqm / 35 + gaussianRandom() * 0.8)));
                const price = 30 + sqm * 2.5 + rooms * 40 + gaussianRandom() * 40;
                data3d.push({ sqm, rooms, price });
            }

            // View parameters
            let rotX = 0.45;
            let rotY = -0.7;
            let zoom = 1.0;
            let panX = 0;
            let panY = 0;

            const defaultRotX = 0.45, defaultRotY = -0.7, defaultZoom = 1.0, defaultPanX = 0, defaultPanY = 0;

            // Data ranges
            const sqmMin = 20, sqmMax = 190;
            const roomsMin = 0, roomsMax = 7;
            const priceMin = 0, priceMax = 600;

            const roomColors = ['#3498db', '#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#9b59b6'];

            // Build legend
            const legendDiv = document.getElementById('mr3d-legend');
            if (legendDiv) {
                for (let r = 1; r <= 6; r++) {
                    const item = document.createElement('div');
                    item.style.cssText = 'display: flex; align-items: center; gap: 3px;';
                    item.innerHTML = `<span style="width: 12px; height: 12px; border-radius: 50%; background: ${roomColors[r-1]};"></span><span style="font-size: 0.75em;">${r}</span>`;
                    legendDiv.appendChild(item);
                }
            }

            function project3D(sqm, rooms, price) {
                // Normalize to centered coordinates
                const x = ((sqm - sqmMin) / (sqmMax - sqmMin) - 0.5) * 180;
                const y = ((rooms - roomsMin) / (roomsMax - roomsMin) - 0.5) * 140;
                const z = ((price - priceMin) / (priceMax - priceMin) - 0.5) * 180;

                // Rotate around Y axis (horizontal rotation)
                const x1 = x * Math.cos(rotY) - y * Math.sin(rotY);
                const y1 = x * Math.sin(rotY) + y * Math.cos(rotY);
                const z1 = z;

                // Rotate around X axis (tilt)
                const y2 = y1 * Math.cos(rotX) - z1 * Math.sin(rotX);
                const z2 = y1 * Math.sin(rotX) + z1 * Math.cos(rotX);

                // Perspective projection
                const perspective = 600;
                const scale = perspective / (perspective + y2) * zoom * 2.0;

                return {
                    x: w / 2 + panX + x1 * scale,
                    y: h / 2 + panY - z2 * scale,
                    scale: scale,
                    depth: y2
                };
            }

            function draw() {
                // Dark background
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, w, h);

                // Draw base grid
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                for (let s = 40; s <= 180; s += 20) {
                    const p1 = project3D(s, roomsMin, priceMin);
                    const p2 = project3D(s, roomsMax, priceMin);
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
                for (let r = 1; r <= 6; r++) {
                    const p1 = project3D(sqmMin, r, priceMin);
                    const p2 = project3D(sqmMax, r, priceMin);
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }

                // Draw axes
                const origin = project3D(sqmMin, roomsMin, priceMin);
                const xEnd = project3D(sqmMax, roomsMin, priceMin);
                const yEnd = project3D(sqmMin, roomsMax, priceMin);
                const zEnd = project3D(sqmMin, roomsMin, priceMax);

                ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.lineWidth = 2;

                ctx.beginPath();
                ctx.moveTo(origin.x, origin.y);
                ctx.lineTo(xEnd.x, xEnd.y);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(origin.x, origin.y);
                ctx.lineTo(yEnd.x, yEnd.y);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(origin.x, origin.y);
                ctx.lineTo(zEnd.x, zEnd.y);
                ctx.stroke();

                // Axis labels
                ctx.font = '14px sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.textAlign = 'center';
                ctx.fillText('sq.m.', xEnd.x, xEnd.y + 18);
                ctx.fillText('rooms', yEnd.x, yEnd.y + 18);
                ctx.fillText('price ($k)', zEnd.x - 40, zEnd.y);

                // Draw regression plane
                ctx.fillStyle = 'rgba(231, 76, 60, 0.2)';
                ctx.strokeStyle = 'rgba(231, 76, 60, 0.4)';
                ctx.lineWidth = 1;

                // Plane grid lines
                for (let r = 1; r <= 6; r++) {
                    const p1 = project3D(sqmMin + 10, r, 30 + (sqmMin + 10) * 2.5 + r * 40);
                    const p2 = project3D(sqmMax - 10, r, 30 + (sqmMax - 10) * 2.5 + r * 40);
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
                for (let s = 40; s <= 180; s += 30) {
                    const p1 = project3D(s, 1, 30 + s * 2.5 + 1 * 40);
                    const p2 = project3D(s, 6, 30 + s * 2.5 + 6 * 40);
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }

                // Plane surface
                const corners = [
                    project3D(sqmMin + 10, 1, 30 + (sqmMin + 10) * 2.5 + 1 * 40),
                    project3D(sqmMax - 10, 1, 30 + (sqmMax - 10) * 2.5 + 1 * 40),
                    project3D(sqmMax - 10, 6, 30 + (sqmMax - 10) * 2.5 + 6 * 40),
                    project3D(sqmMin + 10, 6, 30 + (sqmMin + 10) * 2.5 + 6 * 40)
                ];
                ctx.beginPath();
                ctx.moveTo(corners[0].x, corners[0].y);
                for (let i = 1; i < corners.length; i++) {
                    ctx.lineTo(corners[i].x, corners[i].y);
                }
                ctx.closePath();
                ctx.fill();

                // Sort and draw points
                const sortedData = [...data3d].map(d => ({
                    ...d,
                    proj: project3D(d.sqm, d.rooms, d.price)
                })).sort((a, b) => a.proj.depth - b.proj.depth);

                for (const d of sortedData) {
                    const colorIdx = Math.min(5, Math.max(0, d.rooms - 1));
                    const size = Math.max(4, 7 * d.proj.scale / zoom / 2);

                    // Glow effect
                    ctx.beginPath();
                    ctx.arc(d.proj.x, d.proj.y, size + 3, 0, Math.PI * 2);
                    ctx.fillStyle = roomColors[colorIdx] + '33';
                    ctx.fill();

                    // Point
                    ctx.beginPath();
                    ctx.arc(d.proj.x, d.proj.y, size, 0, Math.PI * 2);
                    ctx.fillStyle = roomColors[colorIdx];
                    ctx.fill();
                }

                // Formula
                ctx.font = 'italic 16px serif';
                ctx.fillStyle = '#e74c3c';
                ctx.textAlign = 'left';
                ctx.fillText('Price = β₀ + β₁ × sq.m. + β₂ × rooms', 20, 28);
            }

            draw();

            // Button handlers
            const step = 0.15;
            const panStep = 20;
            const zoomStep = 0.15;

            document.getElementById('mr3d-rotUp')?.addEventListener('click', () => { rotX -= step; draw(); });
            document.getElementById('mr3d-rotDown')?.addEventListener('click', () => { rotX += step; draw(); });
            document.getElementById('mr3d-rotLeft')?.addEventListener('click', () => { rotY -= step; draw(); });
            document.getElementById('mr3d-rotRight')?.addEventListener('click', () => { rotY += step; draw(); });
            document.getElementById('mr3d-rotReset')?.addEventListener('click', () => {
                rotX = defaultRotX; rotY = defaultRotY; zoom = defaultZoom; panX = defaultPanX; panY = defaultPanY; draw();
            });
            document.getElementById('mr3d-zoomIn')?.addEventListener('click', () => { zoom *= (1 + zoomStep); draw(); });
            document.getElementById('mr3d-zoomOut')?.addEventListener('click', () => { zoom *= (1 - zoomStep); draw(); });
            document.getElementById('mr3d-panUp')?.addEventListener('click', () => { panY -= panStep; draw(); });
            document.getElementById('mr3d-panDown')?.addEventListener('click', () => { panY += panStep; draw(); });
            document.getElementById('mr3d-panLeft')?.addEventListener('click', () => { panX -= panStep; draw(); });
            document.getElementById('mr3d-panRight')?.addEventListener('click', () => { panX += panStep; draw(); });
        })();
        </script>

        <!-- Slide: Regression Example (Pima Diabetes) -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" style="margin-top: 0; max-height: calc(100vh - 20px);">
                <div class="sp-header">
                    <span class="title">Regression Example – Pima Indians Diabetes Dataset</span>
                    <button class="sp-btn" id="runBtn12" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor12"># Pima Indians Diabetes Dataset
# Source: UCI ML Repository / Kaggle

# Load data from GitHub (original has no headers)
pima <- read.csv(
  "https://raw.githubusercontent.com/jbrownlee/Datasets/master/pima-indians-diabetes.data.csv",
  header = FALSE,
  col.names = c("npreg", "glucose", "bp", "triceps", "insulin", "bmi", "diabetes", "age", "class")
)

# Replace zeros with NA (missing values)
pima$glucose[pima$glucose == 0] <- NA
pima$bp[pima$bp == 0] <- NA
pima$triceps[pima$triceps == 0] <- NA
pima$insulin[pima$insulin == 0] <- NA
pima$bmi[pima$bmi == 0] <- NA

# Convert outcome to factor
pima$class <- factor(pima$class, labels = c("neg", "pos"))

# Summary statistics
summary(pima)

# Visualizations
par(mfrow = c(2, 2), mar = c(4, 4, 2, 1))
hist(pima$bp, main = "Blood Pressure Distribution",
     xlab = "Diastolic BP (mm Hg)", col = "#3498db88")
plot(triceps ~ bmi, pima, pch = 19, col = "#e74c3c88",
     main = "Triceps vs BMI", xlab = "BMI", ylab = "Triceps (mm)")
plot(diabetes ~ age, pima, pch = 19, col = "#2ecc7188",
     main = "Diabetes Pedigree vs Age", xlab = "Age", ylab = "Diabetes Pedigree")
boxplot(diabetes ~ class, pima, col = c("#3498db88", "#e74c3c88"),
        main = "Diabetes Pedigree by Outcome", xlab = "Diabetes Test", ylab = "Diabetes Pedigree")</textarea>
                    <div class="sp-output" id="output12"></div>
                </div>
                <div class="sp-status" id="status12">Waiting for WebR...</div>
            </div>
        </div>

        <!-- Slide: Linear Regression Formula -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Linear Regression</h1>
            <p style="font-size: 1.1em; color: #555; margin-bottom: 12px;">The regression of variable Y on variable X is given by:</p>
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.6em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    y<sub>i</sub> = β<sub>0</sub> + β<sub>1</sub> · x<sub>i</sub> + ε<sub>i</sub>, &nbsp;&nbsp; <span style="font-size: 0.9em; font-style: italic;">i = 1, ..., N</span>
                </p>
            </div>
            <div style="display: flex; gap: 30px; margin-bottom: 15px;">
                <div style="flex: 1; background: #e3f2fd; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #2196f3;">
                    <p style="font-size: 1.25em; color: #1976d2; margin: 0 0 8px 0; font-weight: 600;">β<sub>0</sub> (intercept)</p>
                    <p style="font-size: 1.1em; color: #444; margin: 0;">Point where the line intercepts the Y axis (when X = 0)</p>
                </div>
                <div style="flex: 1; background: #fff3e0; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #ff9800;">
                    <p style="font-size: 1.25em; color: #e65100; margin: 0 0 8px 0; font-weight: 600;">β<sub>1</sub> (slope)</p>
                    <p style="font-size: 1.1em; color: #444; margin: 0;">Increase in Y per unit change in X</p>
                </div>
            </div>
            <div style="text-align: center;">
                <canvas id="linearRegressionFormulaCanvas" width="850" height="380" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('linearRegressionFormulaCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Generate data: sq.m. vs price - store globally for reuse
            let seed = 456;
            function seededRandom() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            }
            function gaussianRandom() {
                let u = 0, v = 0;
                while (u === 0) u = seededRandom();
                while (v === 0) v = seededRandom();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            const data = [];
            for (let i = 0; i < 50; i++) {
                const sqm = 30 + seededRandom() * 140;
                const price = 80 + sqm * 3.0 + gaussianRandom() * 45;
                data.push({ sqm, price });
            }

            // Store for next slide
            window.regressionExampleData = data;

            const xMin = 0, xMax = 180;
            const yMin = 0, yMax = 650;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            // Calculate regression
            const n = data.length;
            const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
            const meanY = data.reduce((a, d) => a + d.price, 0) / n;
            let num = 0, den = 0;
            for (const d of data) {
                num += (d.sqm - meanX) * (d.price - meanY);
                den += (d.sqm - meanX) ** 2;
            }
            const beta1 = num / den;
            const beta0 = meanY - beta1 * meanX;

            window.regressionBeta0 = beta0;
            window.regressionBeta1 = beta1;

            // Background
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let y = 100; y <= 600; y += 100) {
                ctx.beginPath();
                ctx.moveTo(margin.left, toCanvasY(y));
                ctx.lineTo(w - margin.right, toCanvasY(y));
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, h - margin.bottom);
            ctx.lineTo(w - margin.right, h - margin.bottom);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#333';
            ctx.font = '13px sans-serif';
            ctx.textAlign = 'right';
            for (let y = 0; y <= 600; y += 100) {
                ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
            }
            ctx.textAlign = 'center';
            for (let x = 0; x <= 180; x += 30) {
                ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 18);
            }

            // Axis titles
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#555';
            ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 8);
            ctx.save();
            ctx.translate(18, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Price ($k)', 0, 0);
            ctx.restore();

            // Points
            ctx.fillStyle = '#3498db99';
            for (const d of data) {
                ctx.beginPath();
                ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Regression line
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(toCanvasX(xMin), toCanvasY(beta0 + beta1 * xMin));
            ctx.lineTo(toCanvasX(xMax), toCanvasY(beta0 + beta1 * xMax));
            ctx.stroke();

            // Show β₀ (intercept) - where line crosses y-axis
            ctx.fillStyle = '#2196f3';
            ctx.beginPath();
            ctx.arc(toCanvasX(0), toCanvasY(beta0), 9, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#1565c0';
            ctx.lineWidth = 2;
            ctx.stroke();

            // β₀ label
            ctx.font = 'bold 15px sans-serif';
            ctx.fillStyle = '#1976d2';
            ctx.textAlign = 'left';
            ctx.fillText('β₀ = ' + Math.round(beta0) + 'k', toCanvasX(5), toCanvasY(beta0) - 18);

            // Show β₁ (slope) - rise over run
            const x1 = 110, x2 = 155;
            const y1 = beta0 + beta1 * x1;
            const y2 = beta0 + beta1 * x2;

            // Horizontal line (run)
            ctx.strokeStyle = '#ff9800';
            ctx.lineWidth = 2;
            ctx.setLineDash([6, 4]);
            ctx.beginPath();
            ctx.moveTo(toCanvasX(x1), toCanvasY(y1));
            ctx.lineTo(toCanvasX(x2), toCanvasY(y1));
            ctx.stroke();

            // Vertical line (rise)
            ctx.beginPath();
            ctx.moveTo(toCanvasX(x2), toCanvasY(y1));
            ctx.lineTo(toCanvasX(x2), toCanvasY(y2));
            ctx.stroke();
            ctx.setLineDash([]);

            // β₁ labels
            ctx.font = '13px sans-serif';
            ctx.fillStyle = '#e65100';
            ctx.textAlign = 'center';
            ctx.fillText('Δx = ' + (x2 - x1), toCanvasX((x1 + x2) / 2), toCanvasY(y1) + 20);
            ctx.save();
            ctx.translate(toCanvasX(x2) + 20, toCanvasY((y1 + y2) / 2));
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Δy = ' + Math.round(y2 - y1), 0, 0);
            ctx.restore();

            // β₁ value
            ctx.font = 'bold 15px sans-serif';
            ctx.fillStyle = '#e65100';
            ctx.textAlign = 'left';
            ctx.fillText('β₁ = ' + beta1.toFixed(1) + 'k/sq.m.', toCanvasX(x2) + 30, toCanvasY((y1 + y2) / 2));
        })();
        </script>

        <!-- Slide: Fitted Values and Residuals -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Linear Regression</h1>
            <p style="font-size: 1.1em; color: #555; margin-bottom: 12px;">The regression of variable Y on variable X is given by:</p>
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.6em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    y<sub>i</sub> = β<sub>0</sub> + β<sub>1</sub> · x<sub>i</sub> + ε<sub>i</sub>, &nbsp;&nbsp; <span style="font-size: 0.9em; font-style: italic;">i = 1, ..., N</span>
                </p>
            </div>
            <div style="display: flex; gap: 30px; margin-bottom: 15px;">
                <div style="flex: 1; background: #ffebee; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #e53935;">
                    <p style="font-size: 1.25em; color: #c62828; margin: 0 0 8px 0; font-weight: 600;">Fitted values</p>
                    <p style="font-size: 1.2em; color: #444; margin: 0; font-family: 'Times New Roman', serif;">ŷ<sub>i</sub> = β<sub>0</sub> + β<sub>1</sub> · x<sub>i</sub></p>
                </div>
                <div style="flex: 1; background: #fce4ec; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #d81b60;">
                    <p style="font-size: 1.25em; color: #ad1457; margin: 0 0 8px 0; font-weight: 600;">Residuals</p>
                    <p style="font-size: 1.2em; color: #444; margin: 0; font-family: 'Times New Roman', serif;">ε<sub>i</sub> = y<sub>i</sub> − ŷ<sub>i</sub></p>
                </div>
            </div>
            <div style="text-align: center;">
                <canvas id="residualsCanvas" width="850" height="380" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('residualsCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Use same data from previous slide or regenerate
            let data = window.regressionExampleData;
            let beta0 = window.regressionBeta0;
            let beta1 = window.regressionBeta1;

            if (!data) {
                // Regenerate if not available
                let seed = 456;
                function seededRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                function gaussianRandom() {
                    let u = 0, v = 0;
                    while (u === 0) u = seededRandom();
                    while (v === 0) v = seededRandom();
                    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }
                data = [];
                for (let i = 0; i < 50; i++) {
                    const sqm = 30 + seededRandom() * 140;
                    const price = 80 + sqm * 3.0 + gaussianRandom() * 45;
                    data.push({ sqm, price });
                }
                const n = data.length;
                const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
                const meanY = data.reduce((a, d) => a + d.price, 0) / n;
                let num = 0, den = 0;
                for (const d of data) {
                    num += (d.sqm - meanX) * (d.price - meanY);
                    den += (d.sqm - meanX) ** 2;
                }
                beta1 = num / den;
                beta0 = meanY - beta1 * meanX;
            }

            const xMin = 0, xMax = 180;
            const yMin = 0, yMax = 650;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            // Background
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let y = 100; y <= 600; y += 100) {
                ctx.beginPath();
                ctx.moveTo(margin.left, toCanvasY(y));
                ctx.lineTo(w - margin.right, toCanvasY(y));
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, h - margin.bottom);
            ctx.lineTo(w - margin.right, h - margin.bottom);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#333';
            ctx.font = '13px sans-serif';
            ctx.textAlign = 'right';
            for (let y = 0; y <= 600; y += 100) {
                ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
            }
            ctx.textAlign = 'center';
            for (let x = 0; x <= 180; x += 30) {
                ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 18);
            }

            // Axis titles
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#555';
            ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 8);
            ctx.save();
            ctx.translate(18, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Price ($k)', 0, 0);
            ctx.restore();

            // Draw residuals (vertical lines from observed to fitted) - red
            ctx.strokeStyle = '#e53935';
            ctx.lineWidth = 2;
            for (const d of data) {
                const fitted = beta0 + beta1 * d.sqm;
                ctx.beginPath();
                ctx.moveTo(toCanvasX(d.sqm), toCanvasY(d.price));
                ctx.lineTo(toCanvasX(d.sqm), toCanvasY(fitted));
                ctx.stroke();
            }

            // Regression line - grey
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(toCanvasX(xMin), toCanvasY(beta0 + beta1 * xMin));
            ctx.lineTo(toCanvasX(xMax), toCanvasY(beta0 + beta1 * xMax));
            ctx.stroke();

            // Observed points - grey
            ctx.fillStyle = '#999';
            for (const d of data) {
                ctx.beginPath();
                ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Fitted values (points on the line) - red
            ctx.fillStyle = '#e53935';
            for (const d of data) {
                const fitted = beta0 + beta1 * d.sqm;
                ctx.beginPath();
                ctx.arc(toCanvasX(d.sqm), toCanvasY(fitted), 5, 0, Math.PI * 2);
                ctx.fill();
            }
        })();
        </script>

        <!-- Slide: Model Fitting - Least Squares Method (animated) -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <style>
                @keyframes bounceHat {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-4px); }
                }
                .bouncy-hat {
                    display: inline-block;
                    color: #e53935;
                    font-weight: bold;
                    animation: bounceHat 0.6s ease-in-out infinite;
                }
            </style>
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Model Fitting - Least Squares Method</h1>
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.1em; color: #555; margin: 0 0 8px 0;">Fitted values:</p>
                <p style="font-size: 1.6em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    <span class="bouncy-hat">ŷ</span><sub>i</sub> = β<sub>0</sub> + β<sub>1</sub> · x<sub>i</sub>
                </p>
            </div>
            <div style="display: flex; gap: 30px; margin-bottom: 15px;">
                <div style="flex: 1; background: #ffebee; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #e53935;">
                    <p style="font-size: 1.15em; color: #444; margin: 0;">Fitted values <span class="bouncy-hat">ŷ</span><sub>i</sub> should be as close as possible to observed values y<sub>i</sub></p>
                </div>
            </div>
            <div style="text-align: center; position: relative; display: inline-block;">
                <canvas id="leastSquaresAnimatedCanvas" width="850" height="360" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                <button id="leastSquaresAnimToggle" style="position: absolute; bottom: 15px; right: 15px; padding: 8px 16px; font-size: 14px; background: #e53935; color: white; border: none; border-radius: 6px; cursor: pointer; opacity: 0.9;">⏸ Pause</button>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('leastSquaresAnimatedCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const toggleBtn = document.getElementById('leastSquaresAnimToggle');
            let isPlaying = true;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Use same data from previous slides
            let data = window.regressionExampleData;
            let trueBeta0 = window.regressionBeta0;
            let trueBeta1 = window.regressionBeta1;

            if (!data) {
                let seed = 456;
                function seededRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                function gaussianRandom() {
                    let u = 0, v = 0;
                    while (u === 0) u = seededRandom();
                    while (v === 0) v = seededRandom();
                    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }
                data = [];
                for (let i = 0; i < 50; i++) {
                    const sqm = 30 + seededRandom() * 140;
                    const price = 80 + sqm * 3.0 + gaussianRandom() * 45;
                    data.push({ sqm, price });
                }
                const n = data.length;
                const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
                const meanY = data.reduce((a, d) => a + d.price, 0) / n;
                let num = 0, den = 0;
                for (const d of data) {
                    num += (d.sqm - meanX) * (d.price - meanY);
                    den += (d.sqm - meanX) ** 2;
                }
                trueBeta1 = num / den;
                trueBeta0 = meanY - trueBeta1 * meanX;
            }

            const xMin = 0, xMax = 180;
            const yMin = 0, yMax = 650;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            let time = 0;
            let animationId = null;

            function draw() {
                // Animate beta0 and beta1 around true values
                const beta0 = trueBeta0 + Math.sin(time * 0.02) * 60 + Math.sin(time * 0.035) * 30;
                const beta1 = trueBeta1 + Math.sin(time * 0.015 + 1) * 0.8 + Math.cos(time * 0.025) * 0.4;

                // Background
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                for (let y = 0; y <= 600; y += 100) {
                    ctx.beginPath();
                    ctx.moveTo(margin.left, toCanvasY(y));
                    ctx.lineTo(w - margin.right, toCanvasY(y));
                    ctx.stroke();
                }
                for (let x = 0; x <= 180; x += 30) {
                    ctx.beginPath();
                    ctx.moveTo(toCanvasX(x), margin.top);
                    ctx.lineTo(toCanvasX(x), h - margin.bottom);
                    ctx.stroke();
                }

                // Axes
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, h - margin.bottom);
                ctx.lineTo(w - margin.right, h - margin.bottom);
                ctx.stroke();

                // Axis labels
                ctx.fillStyle = '#333';
                ctx.font = '13px sans-serif';
                ctx.textAlign = 'right';
                for (let y = 0; y <= 600; y += 100) {
                    ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
                }
                ctx.textAlign = 'center';
                for (let x = 0; x <= 180; x += 30) {
                    ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 18);
                }

                // Axis titles
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#555';
                ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 8);
                ctx.save();
                ctx.translate(18, margin.top + plotH / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Price ($k)', 0, 0);
                ctx.restore();

                // Residual lines
                ctx.strokeStyle = '#e5393588';
                ctx.lineWidth = 2;
                for (const d of data) {
                    const fitted = beta0 + beta1 * d.sqm;
                    ctx.beginPath();
                    ctx.moveTo(toCanvasX(d.sqm), toCanvasY(d.price));
                    ctx.lineTo(toCanvasX(d.sqm), toCanvasY(fitted));
                    ctx.stroke();
                }

                // Observed points
                ctx.fillStyle = '#999';
                for (const d of data) {
                    ctx.beginPath();
                    ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 5, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Regression line
                ctx.strokeStyle = '#e53935';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(toCanvasX(xMin), toCanvasY(beta0 + beta1 * xMin));
                ctx.lineTo(toCanvasX(xMax), toCanvasY(beta0 + beta1 * xMax));
                ctx.stroke();

                // Fitted points
                ctx.fillStyle = '#e53935';
                for (const d of data) {
                    const fitted = beta0 + beta1 * d.sqm;
                    ctx.beginPath();
                    ctx.arc(toCanvasX(d.sqm), toCanvasY(fitted), 4, 0, Math.PI * 2);
                    ctx.fill();
                }

                time++;
                if (isPlaying) {
                    animationId = requestAnimationFrame(draw);
                } else {
                    animationId = null;
                }
            }

            // Toggle button handler
            const bouncyHats = document.querySelectorAll('.bouncy-hat');
            toggleBtn.addEventListener('click', () => {
                isPlaying = !isPlaying;
                if (isPlaying) {
                    toggleBtn.textContent = '⏸ Pause';
                    toggleBtn.style.background = '#e53935';
                    bouncyHats.forEach(el => el.style.animationPlayState = 'running');
                    if (!animationId) draw();
                } else {
                    toggleBtn.textContent = '▶ Play';
                    toggleBtn.style.background = '#43a047';
                    bouncyHats.forEach(el => el.style.animationPlayState = 'paused');
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                }
            });

            // Start/stop animation based on slide visibility
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (!animationId && isPlaying) draw();
                    } else {
                        if (animationId) {
                            cancelAnimationFrame(animationId);
                            animationId = null;
                        }
                    }
                });
            }, { threshold: 0.1 });

            observer.observe(canvas);
            draw();
        })();
        </script>

        <!-- Slide: Model Fitting - Least Squares Method (SSR) -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Model Fitting - Least Squares Method</h1>
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.1em; color: #555; margin: 0 0 8px 0;">Sum of Squared Residuals:</p>
                <p style="font-size: 1.4em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    SSR = <span style="font-size: 1.1em;">Σ</span><sub style="font-size: 0.7em;">i=1..N</sub> ε<sub>i</sub><sup>2</sup>
                    = <span style="font-size: 1.1em;">Σ</span><sub style="font-size: 0.7em;">i=1..N</sub> (y<sub>i</sub> − ŷ<sub>i</sub>)<sup>2</sup>
                    = <span style="font-size: 1.1em;">Σ</span><sub style="font-size: 0.7em;">i=1..N</sub> (y<sub>i</sub> − β<sub>0</sub> − β<sub>1</sub>x<sub>i</sub>)<sup>2</sup>
                </p>
            </div>
            <div style="text-align: center;">
                <canvas id="ssrCanvas" width="850" height="420" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('ssrCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Use same data from previous slides
            let data = window.regressionExampleData;
            let beta0 = window.regressionBeta0;
            let beta1 = window.regressionBeta1;

            if (!data) {
                let seed = 456;
                function seededRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                function gaussianRandom() {
                    let u = 0, v = 0;
                    while (u === 0) u = seededRandom();
                    while (v === 0) v = seededRandom();
                    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }
                data = [];
                for (let i = 0; i < 50; i++) {
                    const sqm = 30 + seededRandom() * 140;
                    const price = 80 + sqm * 3.0 + gaussianRandom() * 45;
                    data.push({ sqm, price });
                }
                const n = data.length;
                const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
                const meanY = data.reduce((a, d) => a + d.price, 0) / n;
                let num = 0, den = 0;
                for (const d of data) {
                    num += (d.sqm - meanX) * (d.price - meanY);
                    den += (d.sqm - meanX) ** 2;
                }
                beta1 = num / den;
                beta0 = meanY - beta1 * meanX;
            }

            const xMin = 0, xMax = 180;
            const yMin = 0, yMax = 650;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            // Background
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let y = 0; y <= 600; y += 100) {
                ctx.beginPath();
                ctx.moveTo(margin.left, toCanvasY(y));
                ctx.lineTo(w - margin.right, toCanvasY(y));
                ctx.stroke();
            }
            for (let x = 0; x <= 180; x += 30) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(x), margin.top);
                ctx.lineTo(toCanvasX(x), h - margin.bottom);
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, h - margin.bottom);
            ctx.lineTo(w - margin.right, h - margin.bottom);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#333';
            ctx.font = '13px sans-serif';
            ctx.textAlign = 'right';
            for (let y = 0; y <= 600; y += 100) {
                ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
            }
            ctx.textAlign = 'center';
            for (let x = 0; x <= 180; x += 30) {
                ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 18);
            }

            // Axis titles
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#555';
            ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 8);
            ctx.save();
            ctx.translate(18, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Price ($k)', 0, 0);
            ctx.restore();

            // Draw squared residuals as squares
            const pixelsPerUnit = plotH / (yMax - yMin);

            for (const d of data) {
                const fitted = beta0 + beta1 * d.sqm;
                const residual = d.price - fitted;
                const residualPixels = Math.abs(residual) * pixelsPerUnit;

                // Draw square with side = residual length
                ctx.fillStyle = 'rgba(229, 57, 53, 0.25)';
                ctx.strokeStyle = 'rgba(229, 57, 53, 0.6)';
                ctx.lineWidth = 1;

                const xPos = toCanvasX(d.sqm);
                const yObserved = toCanvasY(d.price);
                const yFitted = toCanvasY(fitted);

                // Draw square extending to the right from the residual line
                if (residual > 0) {
                    // Point above line
                    ctx.fillRect(xPos, yObserved, residualPixels, yFitted - yObserved);
                    ctx.strokeRect(xPos, yObserved, residualPixels, yFitted - yObserved);
                } else {
                    // Point below line
                    ctx.fillRect(xPos, yFitted, residualPixels, yObserved - yFitted);
                    ctx.strokeRect(xPos, yFitted, residualPixels, yObserved - yFitted);
                }
            }

            // Observed points
            ctx.fillStyle = '#999';
            for (const d of data) {
                ctx.beginPath();
                ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Regression line
            ctx.strokeStyle = '#e53935';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(toCanvasX(xMin), toCanvasY(beta0 + beta1 * xMin));
            ctx.lineTo(toCanvasX(xMax), toCanvasY(beta0 + beta1 * xMax));
            ctx.stroke();

            // Calculate and display SSR
            let ssr = 0;
            for (const d of data) {
                const fitted = beta0 + beta1 * d.sqm;
                ssr += (d.price - fitted) ** 2;
            }

            ctx.font = 'bold 16px sans-serif';
            ctx.fillStyle = '#c62828';
            ctx.textAlign = 'right';
            ctx.fillText('SSR = ' + Math.round(ssr).toLocaleString(), w - margin.right - 10, margin.top + 25);
        })();
        </script>

        <!-- Slide: Model Fitting - Least Squares Method (Gradient Descent) -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Model Fitting - Least Squares Method</h1>
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.2em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    A usual way of computing β<sub>0</sub> and β<sub>1</sub> is based on minimising the SSR
                </p>
            </div>
            <div style="text-align: center; position: relative; display: inline-block;">
                <canvas id="gradientDescentCanvas" width="850" height="420" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
                <button id="gradientDescentReplay" style="position: absolute; bottom: 15px; right: 15px; padding: 8px 16px; font-size: 14px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; opacity: 0.9;">↻ Replay</button>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('gradientDescentCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;
            const replayBtn = document.getElementById('gradientDescentReplay');

            // Use same data from previous slides
            let data = window.regressionExampleData;
            let targetBeta0 = window.regressionBeta0;
            let targetBeta1 = window.regressionBeta1;

            if (!data) {
                let seed = 456;
                function seededRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                function gaussianRandom() {
                    let u = 0, v = 0;
                    while (u === 0) u = seededRandom();
                    while (v === 0) v = seededRandom();
                    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }
                data = [];
                for (let i = 0; i < 50; i++) {
                    const sqm = 30 + seededRandom() * 140;
                    const price = 80 + sqm * 3.0 + gaussianRandom() * 45;
                    data.push({ sqm, price });
                }
                const n = data.length;
                const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
                const meanY = data.reduce((a, d) => a + d.price, 0) / n;
                let num = 0, den = 0;
                for (const d of data) {
                    num += (d.sqm - meanX) * (d.price - meanY);
                    den += (d.sqm - meanX) ** 2;
                }
                targetBeta1 = num / den;
                targetBeta0 = meanY - targetBeta1 * meanX;
            }

            const xMin = 0, xMax = 180;
            const yMin = 0, yMax = 650;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            // Starting point: implausible but visible
            const startBeta0 = 400;  // High intercept
            const startBeta1 = 0.5;  // Low positive slope (too flat)

            let currentBeta0 = startBeta0;
            let currentBeta1 = startBeta1;
            let animationId = null;
            let iteration = 0;
            const maxIterations = 300;

            function calculateSSR(b0, b1) {
                let ssr = 0;
                for (const d of data) {
                    const fitted = b0 + b1 * d.sqm;
                    ssr += (d.price - fitted) ** 2;
                }
                return ssr;
            }

            // Easing function for smooth convergence (ease-out)
            function easeOutCubic(t) {
                return 1 - Math.pow(1 - t, 3);
            }

            function updateParameters() {
                const t = easeOutCubic(iteration / maxIterations);
                currentBeta0 = startBeta0 + (targetBeta0 - startBeta0) * t;
                currentBeta1 = startBeta1 + (targetBeta1 - startBeta1) * t;
            }

            function draw() {
                const pixelsPerUnit = plotH / (yMax - yMin);

                // Background
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                for (let y = 0; y <= 600; y += 100) {
                    ctx.beginPath();
                    ctx.moveTo(margin.left, toCanvasY(y));
                    ctx.lineTo(w - margin.right, toCanvasY(y));
                    ctx.stroke();
                }
                for (let x = 0; x <= 180; x += 30) {
                    ctx.beginPath();
                    ctx.moveTo(toCanvasX(x), margin.top);
                    ctx.lineTo(toCanvasX(x), h - margin.bottom);
                    ctx.stroke();
                }

                // Axes
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, h - margin.bottom);
                ctx.lineTo(w - margin.right, h - margin.bottom);
                ctx.stroke();

                // Axis labels
                ctx.fillStyle = '#333';
                ctx.font = '13px sans-serif';
                ctx.textAlign = 'right';
                for (let y = 0; y <= 600; y += 100) {
                    ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
                }
                ctx.textAlign = 'center';
                for (let x = 0; x <= 180; x += 30) {
                    ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 18);
                }

                // Axis titles
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#555';
                ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 8);
                ctx.save();
                ctx.translate(18, margin.top + plotH / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Price ($k)', 0, 0);
                ctx.restore();

                // Draw squared residuals as squares
                for (const d of data) {
                    const fitted = currentBeta0 + currentBeta1 * d.sqm;
                    const residual = d.price - fitted;
                    const residualPixels = Math.abs(residual) * pixelsPerUnit;

                    ctx.fillStyle = 'rgba(229, 57, 53, 0.25)';
                    ctx.strokeStyle = 'rgba(229, 57, 53, 0.6)';
                    ctx.lineWidth = 1;

                    const xPos = toCanvasX(d.sqm);
                    const yObserved = toCanvasY(d.price);
                    const yFitted = toCanvasY(fitted);

                    if (residual > 0) {
                        ctx.fillRect(xPos, yObserved, residualPixels, yFitted - yObserved);
                        ctx.strokeRect(xPos, yObserved, residualPixels, yFitted - yObserved);
                    } else {
                        ctx.fillRect(xPos, yFitted, residualPixels, yObserved - yFitted);
                        ctx.strokeRect(xPos, yFitted, residualPixels, yObserved - yFitted);
                    }
                }

                // Observed points
                ctx.fillStyle = '#999';
                for (const d of data) {
                    ctx.beginPath();
                    ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 5, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Regression line
                ctx.strokeStyle = '#e53935';
                ctx.lineWidth = 3;
                ctx.beginPath();
                const y0 = currentBeta0 + currentBeta1 * xMin;
                const y1 = currentBeta0 + currentBeta1 * xMax;
                ctx.moveTo(toCanvasX(xMin), toCanvasY(Math.max(yMin, Math.min(yMax, y0))));
                ctx.lineTo(toCanvasX(xMax), toCanvasY(Math.max(yMin, Math.min(yMax, y1))));
                ctx.stroke();

                // Calculate and display SSR
                const ssr = calculateSSR(currentBeta0, currentBeta1);

                ctx.font = 'bold 16px sans-serif';
                ctx.fillStyle = '#c62828';
                ctx.textAlign = 'right';
                ctx.fillText('SSR = ' + Math.round(ssr).toLocaleString(), w - margin.right - 10, margin.top + 25);

                // Display current parameters
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#1976d2';
                ctx.textAlign = 'left';
                ctx.fillText('β₀ = ' + currentBeta0.toFixed(1), margin.left + 10, margin.top + 20);
                ctx.fillText('β₁ = ' + currentBeta1.toFixed(2), margin.left + 10, margin.top + 40);

                // Progress indicator
                const progress = Math.min(iteration / maxIterations, 1);
                ctx.fillStyle = '#ddd';
                ctx.fillRect(margin.left, h - margin.bottom + 35, plotW, 6);
                ctx.fillStyle = '#43a047';
                ctx.fillRect(margin.left, h - margin.bottom + 35, plotW * progress, 6);

                // Continue animation
                if (iteration < maxIterations) {
                    iteration++;
                    updateParameters();
                    animationId = setTimeout(() => requestAnimationFrame(draw), 30);
                } else {
                    animationId = null;
                    replayBtn.style.background = '#43a047';
                }
            }

            function startAnimation() {
                if (animationId) {
                    clearTimeout(animationId);
                    cancelAnimationFrame(animationId);
                }
                currentBeta0 = startBeta0;
                currentBeta1 = startBeta1;
                iteration = 0;
                replayBtn.style.background = '#1976d2';
                draw();
            }

            replayBtn.addEventListener('click', startAnimation);

            // Start animation when slide becomes visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (!animationId && iteration === 0) {
                            startAnimation();
                        }
                    }
                });
            }, { threshold: 0.1 });

            observer.observe(canvas);

            // Initial draw (static, waiting for visibility)
            draw();
        })();
        </script>

        <!-- Slide: Is It A Good Model? (R²) -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Is It A Good Model?</h1>
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 12px; text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.1em; color: #555; margin: 0 0 8px 0;">The coefficient of determination R² indicates how well the model fits the data:</p>
                <p style="font-size: 1.5em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    R² = 1 − SSR / TSS
                </p>
            </div>
            <div style="display: flex; gap: 30px; margin-bottom: 10px;">
                <div style="flex: 1; background: #e3f2fd; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #1976d2;">
                    <p style="font-size: 1.15em; color: #444; margin: 0; font-family: 'Times New Roman', serif;">
                        TSS = <span style="font-size: 1.1em;">Σ</span><sub style="font-size: 0.7em;">i=1..N</sub> (y<sub>i</sub> − ȳ)<sup>2</sup>
                    </p>
                </div>
                <div style="flex: 1; background: #e8f5e9; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #43a047;">
                    <p style="font-size: 1.05em; color: #444; margin: 0;">
                        R² represents the proportion of the total sample variability explained by the regression model.
                    </p>
                </div>
            </div>
            <p style="font-size: 0.95em; color: #666; text-align: center; margin-bottom: 10px; font-style: italic;">
                Note: for simple linear regression, R² = ρ<sub>XY</sub>²
            </p>
            <div style="text-align: center;">
                <canvas id="rSquaredCanvas" width="850" height="340" style="border: 1px solid #ddd; border-radius: 8px; background: #fafafa;"></canvas>
            </div>
        </div>
        <script>
        (function() {
            const canvas = document.getElementById('rSquaredCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const margin = { top: 25, right: 40, bottom: 50, left: 70 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Use same data from previous slides
            let data = window.regressionExampleData;
            let beta0 = window.regressionBeta0;
            let beta1 = window.regressionBeta1;

            if (!data) {
                let seed = 456;
                function seededRandom() {
                    seed = (seed * 9301 + 49297) % 233280;
                    return seed / 233280;
                }
                function gaussianRandom() {
                    let u = 0, v = 0;
                    while (u === 0) u = seededRandom();
                    while (v === 0) v = seededRandom();
                    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }
                data = [];
                for (let i = 0; i < 50; i++) {
                    const sqm = 30 + seededRandom() * 140;
                    const price = 80 + sqm * 3.0 + gaussianRandom() * 45;
                    data.push({ sqm, price });
                }
                const n = data.length;
                const meanX = data.reduce((a, d) => a + d.sqm, 0) / n;
                const meanY = data.reduce((a, d) => a + d.price, 0) / n;
                let num = 0, den = 0;
                for (const d of data) {
                    num += (d.sqm - meanX) * (d.price - meanY);
                    den += (d.sqm - meanX) ** 2;
                }
                beta1 = num / den;
                beta0 = meanY - beta1 * meanX;
            }

            // Calculate mean of Y
            const meanY = data.reduce((a, d) => a + d.price, 0) / data.length;

            const xMin = 0, xMax = 180;
            const yMin = 0, yMax = 650;

            function toCanvasX(x) { return margin.left + (x - xMin) / (xMax - xMin) * plotW; }
            function toCanvasY(y) { return margin.top + (1 - (y - yMin) / (yMax - yMin)) * plotH; }

            const pixelsPerUnit = plotH / (yMax - yMin);

            // Background
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let y = 0; y <= 600; y += 100) {
                ctx.beginPath();
                ctx.moveTo(margin.left, toCanvasY(y));
                ctx.lineTo(w - margin.right, toCanvasY(y));
                ctx.stroke();
            }
            for (let x = 0; x <= 180; x += 30) {
                ctx.beginPath();
                ctx.moveTo(toCanvasX(x), margin.top);
                ctx.lineTo(toCanvasX(x), h - margin.bottom);
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, h - margin.bottom);
            ctx.lineTo(w - margin.right, h - margin.bottom);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#333';
            ctx.font = '13px sans-serif';
            ctx.textAlign = 'right';
            for (let y = 0; y <= 600; y += 100) {
                ctx.fillText('$' + y + 'k', margin.left - 8, toCanvasY(y) + 4);
            }
            ctx.textAlign = 'center';
            for (let x = 0; x <= 180; x += 30) {
                ctx.fillText(x + '', toCanvasX(x), h - margin.bottom + 18);
            }

            // Axis titles
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#555';
            ctx.fillText('Square Meters (sq.m.)', margin.left + plotW / 2, h - 8);
            ctx.save();
            ctx.translate(18, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Price ($k)', 0, 0);
            ctx.restore();

            // Draw mean line (ȳ) - blue dashed horizontal line
            ctx.strokeStyle = '#1976d2';
            ctx.lineWidth = 2;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(margin.left, toCanvasY(meanY));
            ctx.lineTo(w - margin.right, toCanvasY(meanY));
            ctx.stroke();
            ctx.setLineDash([]);

            // Label for mean line
            ctx.font = '13px sans-serif';
            ctx.fillStyle = '#1976d2';
            ctx.textAlign = 'left';
            ctx.fillText('ȳ = ' + meanY.toFixed(0) + 'k', w - margin.right + 5, toCanvasY(meanY) + 4);

            // Calculate SSR and TSS
            let ssr = 0;
            let tss = 0;
            for (const d of data) {
                const fitted = beta0 + beta1 * d.sqm;
                ssr += (d.price - fitted) ** 2;
                tss += (d.price - meanY) ** 2;
            }
            const rSquared = 1 - ssr / tss;

            // Draw TSS squares (blue, from points to mean line) - draw first so SSR overlaps
            for (const d of data) {
                const deviation = d.price - meanY;
                const deviationPixels = Math.abs(deviation) * pixelsPerUnit;

                ctx.fillStyle = 'rgba(25, 118, 210, 0.15)';
                ctx.strokeStyle = 'rgba(25, 118, 210, 0.4)';
                ctx.lineWidth = 1;

                const xPos = toCanvasX(d.sqm);
                const yObserved = toCanvasY(d.price);
                const yMean = toCanvasY(meanY);

                // Draw square extending to the left from the point
                if (deviation > 0) {
                    ctx.fillRect(xPos - deviationPixels, yObserved, deviationPixels, yMean - yObserved);
                    ctx.strokeRect(xPos - deviationPixels, yObserved, deviationPixels, yMean - yObserved);
                } else {
                    ctx.fillRect(xPos - deviationPixels, yMean, deviationPixels, yObserved - yMean);
                    ctx.strokeRect(xPos - deviationPixels, yMean, deviationPixels, yObserved - yMean);
                }
            }

            // Draw SSR squares (red, from points to regression line)
            for (const d of data) {
                const fitted = beta0 + beta1 * d.sqm;
                const residual = d.price - fitted;
                const residualPixels = Math.abs(residual) * pixelsPerUnit;

                ctx.fillStyle = 'rgba(229, 57, 53, 0.25)';
                ctx.strokeStyle = 'rgba(229, 57, 53, 0.6)';
                ctx.lineWidth = 1;

                const xPos = toCanvasX(d.sqm);
                const yObserved = toCanvasY(d.price);
                const yFitted = toCanvasY(fitted);

                if (residual > 0) {
                    ctx.fillRect(xPos, yObserved, residualPixels, yFitted - yObserved);
                    ctx.strokeRect(xPos, yObserved, residualPixels, yFitted - yObserved);
                } else {
                    ctx.fillRect(xPos, yFitted, residualPixels, yObserved - yFitted);
                    ctx.strokeRect(xPos, yFitted, residualPixels, yObserved - yFitted);
                }
            }

            // Observed points
            ctx.fillStyle = '#555';
            for (const d of data) {
                ctx.beginPath();
                ctx.arc(toCanvasX(d.sqm), toCanvasY(d.price), 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Regression line
            ctx.strokeStyle = '#e53935';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(toCanvasX(xMin), toCanvasY(beta0 + beta1 * xMin));
            ctx.lineTo(toCanvasX(xMax), toCanvasY(beta0 + beta1 * xMax));
            ctx.stroke();

            // Display statistics
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'left';

            // TSS (blue)
            ctx.fillStyle = '#1976d2';
            ctx.fillText('TSS = ' + Math.round(tss).toLocaleString(), margin.left + 10, margin.top + 20);

            // SSR (red)
            ctx.fillStyle = '#c62828';
            ctx.fillText('SSR = ' + Math.round(ssr).toLocaleString(), margin.left + 10, margin.top + 40);

            // R² (green)
            ctx.fillStyle = '#2e7d32';
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText('R² = ' + rSquared.toFixed(3), margin.left + 10, margin.top + 65);
        })();
        </script>

        <!-- Slide: How to Win at Statistics -->
        <div class="slide" style="padding: 25px 40px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h1 style="font-size: 2.2em; color: #fff; font-weight: 400; margin-bottom: 15px; text-align: center;">How to Win at Statistics</h1>
            <div style="display: flex; gap: 30px; align-items: flex-start;">
                <div style="flex: 1;">
                    <div id="equationBox" style="background: #0f0f23; border: 2px solid #00d4ff; border-radius: 12px; padding: 25px; font-family: 'SF Mono', Monaco, monospace; font-size: 18px; color: #00ff88; min-height: 120px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);">
                        <span id="equationText"></span><span id="cursor" style="animation: blink 1s infinite;">|</span>
                    </div>
                    <div style="margin-top: 20px;">
                        <canvas id="stonksChart" width="1350" height="480" style="background: #0f0f23; border-radius: 12px; border: 2px solid #00d4ff;"></canvas>
                    </div>
                </div>
                <div style="width: 280px; text-align: center;">
                    <img src="https://i.kym-cdn.com/entries/icons/original/000/029/959/Screen_Shot_2019-06-05_at_1.26.32_PM.jpg" alt="STONKS" style="width: 100%; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <div id="stonksR2Display" style="margin-top: 15px; font-size: 2.5em; font-weight: bold; color: #00ff88; text-shadow: 0 0 10px #00ff88;">
                        R² = 0.00
                    </div>
                    <button id="replayStatsBtn" style="margin-top: 15px; padding: 10px 25px; font-size: 14px; background: #00d4ff; color: #0f0f23; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">▶ Start</button>
                </div>
            </div>
            <style>
                @keyframes blink {
                    0%, 50% { opacity: 1; }
                    51%, 100% { opacity: 0; }
                }
            </style>
        </div>
        <script>
        (function() {
            const equationText = document.getElementById('equationText');
            const r2Display = document.getElementById('stonksR2Display');
            const canvas = document.getElementById('stonksChart');
            const replayBtn = document.getElementById('replayStatsBtn');
            if (!equationText || !canvas || !r2Display) return;

            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;

            const variables = [
                { text: "PRICE", r2: 0 },
                { text: " = ", r2: 0 },
                { text: "SQMETERS", r2: 0.32 },
                { text: " + ROOMS", r2: 0.38 },
                { text: " + NEIGHBORHOOD", r2: 0.43 },
                { text: " + SCHOOLZONE", r2: 0.47 },
                { text: " + YEARBUILT", r2: 0.50 },
                { text: " + PARKING", r2: 0.53 },
                { text: " + BALCONY", r2: 0.55 },
                { text: " + FLOORLEVEL", r2: 0.57 },
                { text: " + VIEWQUALITY", r2: 0.59 },
                { text: " + CRIMEINDEX", r2: 0.61 },
                { text: " + TRANSITDIST", r2: 0.63 },
                { text: " + GROCERYSTORE", r2: 0.65 },
                { text: " + AVGTEMP", r2: 0.67 },
                { text: " + HUMIDITY", r2: 0.69 },
                { text: " + SELLERSMOOD", r2: 0.71 },
                { text: " + PAINTCOLOR", r2: 0.73 },
                { text: " + CURBAPPEAL", r2: 0.74 },
                { text: " + MOONPHASE", r2: 0.76 },
                { text: " + ZODIACSIGN", r2: 0.77 },
                { text: " + MERCURYRETRO", r2: 0.79 },
                { text: " + BIRDCOUNT", r2: 0.80 },
                { text: " + NEIGHVIBES", r2: 0.82 },
                { text: " + CATCOUNT", r2: 0.83 },
                { text: " + DOGBARKS", r2: 0.85 },
                { text: " + SQUIRRELS", r2: 0.86 },
                { text: " + PIZZADIST", r2: 0.88 },
                { text: " + TACOTRUCKS", r2: 0.89 },
                { text: " + WIFI_NAMES", r2: 0.91 },
                { text: " + CHIHUAHUAS", r2: 0.92 },
                { text: " + GNOMES", r2: 0.94 },
                { text: " + FLAMINGOS", r2: 0.95 },
                { text: " + RANDOMNOISE", r2: 0.97 },
                { text: " + ROW_ID", r2: 0.98 },
                { text: " + 🚰🍳🪳", r2: 0.997 }
            ];

            let currentStep = 0;
            let currentChar = 0;
            let currentText = "";
            let r2Values = [0];
            let animationTimeout = null;

            function drawChart() {
                ctx.fillStyle = '#0f0f23';
                ctx.fillRect(0, 0, w, h);

                const margin = { top: 45, right: 30, bottom: 50, left: 70 };
                const plotW = w - margin.left - margin.right;
                const plotH = h - margin.top - margin.bottom;

                // Grid
                ctx.strokeStyle = '#1a3a4a';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 10; i++) {
                    const y = margin.top + plotH * (1 - i / 10);
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(w - margin.right, y);
                    ctx.stroke();
                }

                // Y-axis labels
                ctx.fillStyle = '#00d4ff';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'right';
                for (let i = 0; i <= 10; i++) {
                    const y = margin.top + plotH * (1 - i / 10);
                    ctx.fillText((i / 10).toFixed(1), margin.left - 10, y + 5);
                }

                // Title
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('R² vs Number of Predictors', w / 2, 28);

                // X-axis label
                ctx.fillStyle = '#00d4ff';
                ctx.font = '16px sans-serif';
                ctx.fillText('# Predictors', w / 2, h - 12);

                if (r2Values.length < 2) return;

                // Draw the line
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 4;
                ctx.beginPath();

                const xStep = plotW / (variables.length - 2);
                for (let i = 0; i < r2Values.length; i++) {
                    const x = margin.left + i * xStep;
                    const y = margin.top + plotH * (1 - r2Values[i]);
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                // Draw points
                ctx.fillStyle = '#00ff88';
                for (let i = 0; i < r2Values.length; i++) {
                    const x = margin.left + i * xStep;
                    const y = margin.top + plotH * (1 - r2Values[i]);
                    ctx.beginPath();
                    ctx.arc(x, y, 7, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Glow effect on last point
                if (r2Values.length > 1) {
                    const lastX = margin.left + (r2Values.length - 1) * xStep;
                    const lastY = margin.top + plotH * (1 - r2Values[r2Values.length - 1]);
                    ctx.fillStyle = '#00ff8844';
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 18, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function typeNextChar() {
                if (currentStep >= variables.length) {
                    return;
                }

                const currentVar = variables[currentStep];

                if (currentChar < currentVar.text.length) {
                    currentText += currentVar.text[currentChar];
                    equationText.innerHTML = currentText;
                    currentChar++;
                    animationTimeout = setTimeout(typeNextChar, 80);
                } else {
                    // Finished typing this variable
                    if (currentVar.r2 > 0) {
                        r2Values.push(currentVar.r2);
                        r2Display.textContent = 'R² = ' + currentVar.r2.toFixed(2);
                        drawChart();
                    }
                    currentStep++;
                    currentChar = 0;

                    // Pause between variables
                    const delay = currentStep >= variables.length - 3 ? 1200 : 600;
                    animationTimeout = setTimeout(typeNextChar, delay);
                }
            }

            function startAnimation() {
                currentStep = 0;
                currentChar = 0;
                currentText = "";
                r2Values = [0];
                equationText.innerHTML = "";
                r2Display.textContent = 'R² = 0.00';
                drawChart();
                animationTimeout = setTimeout(typeNextChar, 500);
            }

            replayBtn.addEventListener('click', () => {
                if (animationTimeout) clearTimeout(animationTimeout);
                startAnimation();
                replayBtn.textContent = '↻ Replay';
            });

            // Just draw initial state, don't auto-start
            drawChart();
        })();
        </script>

        <!-- Slide: Adjusted R² -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Is It A Good Model?</h1>
            <div style="background: #f8f9fa; padding: 18px 30px; border-radius: 12px; text-align: center; margin-bottom: 18px;">
                <p style="font-size: 1.05em; color: #555; margin: 0 0 10px 0;">The Adjusted R² takes into account the model's "degrees of freedom" (dF) and penalises large models:</p>
                <p style="font-size: 1.6em; color: #2c3e50; margin: 0; font-family: 'Times New Roman', serif;">
                    Adj. R² = 1 − <span style="display: inline-block; vertical-align: middle; text-align: center; margin: 0 5px;">
                        <span style="display: block; border-bottom: 2px solid #2c3e50; padding: 0 8px;">(1 − R²)(n − 1)</span>
                        <span style="display: block; padding: 0 8px;">n − p − 1</span>
                    </span>
                </p>
            </div>
            <div style="display: flex; gap: 30px; margin-bottom: 18px;">
                <div style="flex: 1; background: #e3f2fd; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #1976d2;">
                    <p style="font-size: 1.15em; color: #444; margin: 0;">
                        <strong style="color: #1976d2;">n</strong> = number of observations<br>
                        <strong style="color: #1976d2;">p</strong> = number of predictors (IVs)
                    </p>
                </div>
                <div style="flex: 1; background: #fff3e0; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #ff9800;">
                    <p style="font-size: 1.15em; color: #444; margin: 0;">
                        <strong style="color: #e65100;">dF</strong> = n − p − 1<br>
                        <span style="font-size: 0.95em; color: #666;">(degrees of freedom)</span>
                    </p>
                </div>
            </div>
            <div style="background: #e8f5e9; padding: 15px 25px; border-radius: 12px; border-left: 5px solid #43a047; margin-bottom: 15px;">
                <p style="font-size: 1.1em; color: #2e7d32; margin: 0; font-weight: 500;">
                    The adjusted R² takes into account the number of degrees of freedom and is preferable to R².
                </p>
            </div>
            <div style="background: #ffebee; padding: 15px 25px; border-radius: 12px; border-left: 5px solid #e53935;">
                <p style="font-size: 1.05em; color: #c62828; margin: 0;">
                    <strong>Warning:</strong> Neither R² nor R²<sub>adj.</sub> give direct indication of how well the model will perform in predicting a new observation.
                </p>
            </div>
        </div>

        <!-- Slide: Regression Example (Smart Plot) -->
        <div class="slide" style="padding: 30px 50px;">
            <h1 style="font-size: 2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">Regression Example</h1>
            <div class="smart-plot">
                <div class="sp-toolbar">
                    <button class="sp-btn" id="runBtn13" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor13"># Train/Test Split for Linear Regression
# Using Pima Indians Diabetes data (loaded previously)

# If pima not loaded, load it:
if (!exists("pima")) {
  pima <- read.csv(
    "https://raw.githubusercontent.com/jbrownlee/Datasets/master/pima-indians-diabetes.data.csv",
    header = FALSE,
    col.names = c("npreg", "glucose", "bp", "triceps", "insulin", "bmi", "diabetes", "age", "class")
  )
  pima$bp[pima$bp == 0] <- NA
  pima$bmi[pima$bmi == 0] <- NA
}

# Create 50% train/test split
split_calc <- floor(0.5 * nrow(pima))

set.seed(1337)

train_calc <- sample(seq_len(nrow(pima)), size = split_calc)

cat("Training indices (first 20):\n")
str(train_calc)

train_data <- pima[train_calc, ]
test_data <- pima[-train_calc, ]

cat("\nTraining set:", nrow(train_data), "observations")
cat("\nTest set:", nrow(test_data), "observations\n\n")

# Fit linear model: Blood Pressure ~ BMI
my.lm <- lm(bp ~ bmi, data = train_data, na.action = na.exclude)

# Show model summary
summary(my.lm)</textarea>
                    <div class="sp-output" id="output13"></div>
                </div>
                <div class="sp-status" id="status13">Waiting for WebR...</div>
            </div>
        </div>

        <!-- Slide: Annotated Summary Output -->
        <div class="slide" style="padding: 25px 40px; background: #fff;">
            <h1 style="font-size: 2em; color: #1a1a2e; font-weight: 400; margin-bottom: 12px;">Reading Regression Output</h1>
            <div class="annotated-output-container" style="position: relative; display: flex; gap: 25px;">
                <div class="annotated-output" id="annotatedOutput" style="flex: 1; position: relative;">
                    <pre id="summaryText" style="font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 14px; line-height: 1.7; background: #1e1e1e; color: #d4d4d4; padding: 25px; border-radius: 8px; margin: 0; white-space: pre; overflow-x: auto;">Call:
lm(formula = bp ~ bmi, data = train_data, na.action = na.exclude)

Residuals:
    Min      1Q  Median      3Q     Max
-52.160  -7.404   0.179   7.261  53.629

Coefficients:
            Estimate Std. Error t value Pr(>|t|)
(Intercept) 58.89552    2.72033   21.65  < 2e-16 ***
bmi          0.42300    0.08088    5.23 2.85e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 11.48 on 369 degrees of freedom
  (13 observations deleted due to missingness)
Multiple R-squared:  0.06901,	Adjusted R-squared:  0.06648
F-statistic: 27.35 on 1 and 369 DF,  p-value: 2.85e-07</pre>
                    <svg id="annotationSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible;"></svg>
                </div>
                <div class="annotation-legend" style="width: 380px; font-size: 14px;">
                    <div id="annotationCards" style="display: flex; flex-direction: column; gap: 12px;"></div>
                </div>
            </div>
        </div>
        <script>
        (function() {
            const annotations = [
                {
                    pattern: "Std. Error",
                    label: "Standard Error",
                    explanation: "Uncertainty in the coefficient estimate. The lower the better - indicates more precise estimates.",
                    color: "#e67e22",
                    side: "right"
                },
                {
                    pattern: "t value",
                    label: "T-Statistic",
                    explanation: "Ratio of estimate to its standard error. The higher (in absolute value) the better - indicates stronger evidence.",
                    color: "#16a085",
                    side: "right"
                },
                {
                    pattern: "Pr(&gt;|t|)",
                    label: "P-value",
                    explanation: "Probability of seeing this result if the true coefficient were 0. Lower = more significant.",
                    color: "#e74c3c",
                    side: "right"
                },
                {
                    pattern: "***",
                    label: "Highly Significant",
                    explanation: "Three stars (***) means p < 0.001. This predictor is very likely to have a real effect.",
                    color: "#27ae60",
                    side: "right"
                },
                {
                    pattern: "Residual standard error",
                    label: "Residual Std. Error",
                    explanation: "Average prediction error. Percentage error: 11.48 × 100 / mean(train_data$bp) ≈ 16%",
                    color: "#3498db",
                    side: "right"
                },
                {
                    pattern: "Adjusted R-squared",
                    label: "Adjusted R²",
                    explanation: "What % of variance is explained by the model, adjusted for number of predictors. Here ~6.6%.",
                    color: "#9b59b6",
                    side: "right"
                },
                {
                    pattern: "Estimate",
                    label: "Coefficients",
                    explanation: "β values: Intercept (58.9) is BP when BMI=0. Slope (0.42) means +1 BMI → +0.42 BP.",
                    color: "#f39c12",
                    side: "right"
                }
            ];

            const pre = document.getElementById('summaryText');
            const svg = document.getElementById('annotationSvg');
            const cardsContainer = document.getElementById('annotationCards');

            if (!pre || !svg || !cardsContainer) return;

            function createHighlightedText() {
                let html = pre.textContent;
                html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                annotations.forEach((ann, idx) => {
                    const escapedPattern = ann.pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedPattern})`, 'g');
                    html = html.replace(regex, `<span class="highlight-${idx}" data-ann="${idx}" style="background: ${ann.color}33; border-bottom: 2px solid ${ann.color}; padding: 0 2px;">$1</span>`);
                });
                pre.innerHTML = html;
            }

            function createAnnotationCards() {
                annotations.forEach((ann, idx) => {
                    const card = document.createElement('div');
                    card.className = 'annotation-card';
                    card.dataset.ann = idx;
                    card.style.cssText = `background: white; border-left: 5px solid ${ann.color}; padding: 14px 18px; border-radius: 0 8px 8px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s;`;
                    card.innerHTML = `<div style="font-weight: 600; color: ${ann.color}; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-size: 14px;"><span style="width: 10px; height: 10px; background: ${ann.color}; border-radius: 50%; display: inline-block;"></span>${ann.label}</div><div style="color: #444; font-size: 13px; line-height: 1.5;">${ann.explanation}</div>`;
                    card.addEventListener('mouseenter', () => { card.style.transform = 'translateX(-5px)'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; highlightPattern(idx, true); });
                    card.addEventListener('mouseleave', () => { card.style.transform = 'translateX(0)'; card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)'; highlightPattern(idx, false); });
                    cardsContainer.appendChild(card);
                });
            }

            function highlightPattern(idx, active) {
                const spans = pre.querySelectorAll(`.highlight-${idx}`);
                const ann = annotations[idx];
                spans.forEach(span => {
                    span.style.background = active ? ann.color + '66' : ann.color + '33';
                    span.style.borderBottomWidth = active ? '3px' : '2px';
                });
                if (active && spans.length > 0) { drawConnector(spans[0], idx); } else { clearConnectors(); }
            }

            function drawConnector(span, idx) {
                clearConnectors();
                const ann = annotations[idx];
                const card = cardsContainer.querySelector(`[data-ann="${idx}"]`);
                if (!span || !card) return;
                const spanRect = span.getBoundingClientRect();
                const cardRect = card.getBoundingClientRect();
                const containerRect = pre.parentElement.getBoundingClientRect();
                const x1 = spanRect.right - containerRect.left + 5;
                const y1 = spanRect.top - containerRect.top + spanRect.height / 2;
                const x2 = cardRect.left - containerRect.left - 10;
                const y2 = cardRect.top - containerRect.top + cardRect.height / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = (x1 + x2) / 2;
                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                path.setAttribute('stroke', ann.color);
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke-dasharray', '5,3');
                path.classList.add('connector');
                const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                arrow.setAttribute('points', `${x2},${y2} ${x2+8},${y2-4} ${x2+8},${y2+4}`);
                arrow.setAttribute('fill', ann.color);
                arrow.classList.add('connector');
                svg.appendChild(path);
                svg.appendChild(arrow);
            }

            function clearConnectors() { svg.querySelectorAll('.connector').forEach(el => el.remove()); }

            createHighlightedText();
            createAnnotationCards();

            pre.querySelectorAll('[data-ann]').forEach(span => {
                span.style.cursor = 'pointer';
                span.addEventListener('mouseenter', () => {
                    const idx = parseInt(span.dataset.ann);
                    highlightPattern(idx, true);
                    const card = cardsContainer.querySelector(`[data-ann="${idx}"]`);
                    if (card) { card.style.transform = 'translateX(-5px)'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; }
                });
                span.addEventListener('mouseleave', () => {
                    const idx = parseInt(span.dataset.ann);
                    highlightPattern(idx, false);
                    const card = cardsContainer.querySelector(`[data-ann="${idx}"]`);
                    if (card) { card.style.transform = 'translateX(0)'; card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)'; }
                });
            });
        })();
        </script>

        <!-- Slide: Confidence and Prediction Bands -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 18px;">Is It A Good Model?</h1>
            <div style="background: #e3f2fd; padding: 22px 30px; border-radius: 12px; border-left: 5px solid #1976d2; margin-bottom: 18px;">
                <p style="font-size: 1.2em; color: #1565c0; margin: 0 0 5px 0; font-weight: 600;">Confidence Bands</p>
                <p style="font-size: 1.1em; color: #444; margin: 0;">Reflect uncertainty about the regression line (how well the line is determined).</p>
            </div>
            <div style="background: #fff3e0; padding: 22px 30px; border-radius: 12px; border-left: 5px solid #ff9800; margin-bottom: 18px;">
                <p style="font-size: 1.2em; color: #e65100; margin: 0 0 5px 0; font-weight: 600;">Prediction Bands</p>
                <p style="font-size: 1.1em; color: #444; margin: 0;">Include uncertainty about future observations.</p>
            </div>
            <div style="background: #ffebee; padding: 20px 30px; border-radius: 12px; border-left: 5px solid #e53935;">
                <p style="font-size: 1.05em; color: #c62828; margin: 0;">
                    <strong>Attention:</strong> These limits rely strongly on the assumption of normally distributed errors with constant variance and should <em>not</em> be used if this assumption is violated for the data being analyzed.
                </p>
            </div>
        </div>

        <!-- Slide: Confidence and Prediction Bands + Heavy Metal -->
        <div class="slide" style="padding: 25px 50px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 18px;">Is It A Good Model?</h1>
            <div style="background: #e3f2fd; padding: 22px 30px; border-radius: 12px; border-left: 5px solid #1976d2; margin-bottom: 15px;">
                <p style="font-size: 1.2em; color: #1565c0; margin: 0 0 5px 0; font-weight: 600;">Confidence Bands</p>
                <p style="font-size: 1.1em; color: #444; margin: 0;">Reflect uncertainty about the regression line (how well the line is determined).</p>
            </div>
            <div style="background: #fff3e0; padding: 22px 30px; border-radius: 12px; border-left: 5px solid #ff9800; margin-bottom: 15px;">
                <p style="font-size: 1.2em; color: #e65100; margin: 0 0 5px 0; font-weight: 600;">Prediction Bands</p>
                <p style="font-size: 1.1em; color: #444; margin: 0;">Include uncertainty about future observations.</p>
            </div>
            <div style="background: #f3e5f5; padding: 22px 30px; border-radius: 12px; border-left: 5px solid #7b1fa2; margin-bottom: 15px;">
                <p style="font-size: 1.2em; color: #7b1fa2; margin: 0 0 5px 0; font-weight: 600;">Heavy Metal Bands</p>
                <p style="font-size: 1.1em; color: #444; margin: 0;">Bring happiness?</p>
            </div>
            <div style="background: #f5f5f5; padding: 18px 25px; border-radius: 12px; border-left: 5px solid #616161; margin-bottom: 15px;">
                <p style="font-size: 1em; color: #333; margin: 0 0 10px 0; font-style: italic; line-height: 1.5;">
                    "At the country-level, the number of heavy metal bands per capita is positively associated with economic output per capita (.71); level of creativity (.71) and entrepreneurship (.66); share of adults that hold college degrees (.68); as well as overall levels of human development (.79), well-being, and satisfaction with life (.60)."
                </p>
                <p style="font-size: 0.9em; color: #666; margin: 0;">
                    — Florida, R. (2014, May 26). How heavy metal tracks the wealth of nations. <em>Bloomberg</em>. https://www.bloomberg.com/news/articles/2014-05-26/how-heavy-metal-tracks-the-wealth-of-nations
                </p>
            </div>
            <div style="background: #ffebee; padding: 20px 30px; border-radius: 12px; border-left: 5px solid #e53935;">
                <p style="font-size: 1.05em; color: #c62828; margin: 0;">
                    <strong>Attention:</strong> These limits rely strongly on the assumption of normally distributed errors with constant variance and should <em>not</em> be used if this assumption is violated for the data being analyzed.
                </p>
            </div>
            <p style="text-align: center; font-size: 2em; margin-top: 15px;">🤘</p>
        </div>

        <!-- Slide: Regression Example - Predictions (Smart Plot) -->
        <div class="slide" style="padding: 30px 50px;">
            <h1 style="font-size: 2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">Regression Example</h1>
            <div class="smart-plot">
                <div class="sp-toolbar">
                    <button class="sp-btn" id="runBtn14" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor14"># Check if previous slide was run
if (!exists("my.lm") || !exists("train_data") || !exists("test_data")) {
  stop("Please run the previous slide first to create the model and data splits!")
}

# Predictions with confidence and prediction intervals
predict(my.lm, interval = "confidence")
predict(my.lm, interval = "prediction")

# Predict on test data
pc <- predict(my.lm, int = "c",
              newdata = test_data[which(!is.na(test_data$bp) & !is.na(test_data$bmi)), ])
pp <- predict(my.lm, int = "p",
              newdata = test_data[which(!is.na(test_data$bp) & !is.na(test_data$bmi)), ])

require(graphics)

evalData <- test_data[which(!is.na(test_data$bp) & !is.na(test_data$bmi)), ]

# Plot test data with confidence and prediction intervals
plot(evalData$bmi, evalData$bp,
     ylim = range(evalData$bp, pp, na.rm = TRUE),
     xlab = "BMI", ylab = "Blood Pressure",
     main = "Test Data with Confidence & Prediction Intervals",
     pch = 19, col = "#3498db88")

# Sort for proper line plotting
ord <- order(evalData$bmi)
pred.Size <- evalData$bmi[ord]

matlines(pred.Size, pc[ord, ], lty = c(1, 2, 2), lwd = 1.5, col = c("red", "red", "red"))
matlines(pred.Size, pp[ord, ], lty = c(1, 3, 3), lwd = 1.5, col = c("blue", "blue", "blue"))

legend("topleft",
       legend = c("Fitted", "Confidence Int.", "Prediction Int."),
       lty = c(1, 2, 3), col = c("red", "red", "blue"), lwd = 1.5)</textarea>
                    <div class="sp-output" id="output14"></div>
                </div>
                <div class="sp-status" id="status14">Waiting for WebR...</div>
            </div>
        </div>

        <!-- Slide: Regression Summary (Smart Plot) -->
        <div class="slide" style="padding: 30px 50px;">
            <h1 style="font-size: 2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">Regression Summary</h1>
            <div class="smart-plot">
                <div class="sp-toolbar">
                    <button class="sp-btn" id="runBtn15" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor15"># Check if previous slides were run
if (!exists("my.lm")) {
  stop("Please run the regression slides first!")
}

# Display model summary
summary(my.lm)</textarea>
                    <div class="sp-output" id="output15"></div>
                </div>
                <div class="sp-status" id="status15">Waiting for WebR...</div>
            </div>
        </div>

        <!-- Slide: Accuracy of Predictions -->
        <div class="slide" style="padding: 30px 60px; background: #fff;">
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 15px;">Accuracy of Predictions</h1>
            <p style="font-size: 1.2em; color: #444; margin-bottom: 20px;">When we build a model and have a "ground truth" we can measure the quality of our predictions.</p>
            <div style="display: flex; justify-content: center; align-items: center;">
                <img src="https://devopedia.org/images/article/208/9787.1566189818.png" alt="Confusion Matrix" style="max-width: 70%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            </div>
            <p style="font-size: 0.85em; color: #666; margin-top: 15px; text-align: center;">
                Source: Idris, Awab. 2018. "Confusion Matrix." <em>Medium</em>, July 11. Via <a href="https://devopedia.org/confusion-matrix" style="color: #1976d2;">Devopedia</a>.
            </p>
        </div>

        <!-- Slide: Confusion Matrix Metrics -->
        <div class="slide" id="confusionMetricsSlide" style="padding: 10px 20px; background: #fff;">
            <h1 style="font-size: 2em; color: #1a1a2e; font-weight: 400; margin-bottom: 5px;">Confusion Matrix Metrics</h1>
            <style>
                #confusionMetricsSlide .cm-box { transition: all 0.2s ease; cursor: pointer; }
                #confusionMetricsSlide .cm-box.highlight { filter: brightness(1.2); stroke-width: 5px !important; }
                #confusionMetricsSlide .cm-box.dim { opacity: 0.25; }
                #confusionMetricsSlide .formula-box { transition: all 0.2s ease; cursor: pointer; display: inline-block; }
                #confusionMetricsSlide .formula-box.highlight { transform: scale(1.4); box-shadow: 0 0 12px rgba(0,0,0,0.4); }
                #confusionMetricsSlide .formula-box.dim { opacity: 0.25; }
            </style>
            <div style="display: flex; justify-content: center; align-items: flex-start; gap: 40px;">
                <!-- Left side: Visual diagram -->
                <svg width="580" height="580" viewBox="0 0 580 580" id="cmDiagram">
                    <!-- Top bar: Actual Positive / Actual Negative -->
                    <rect class="cm-box" data-type="ap" x="60" y="15" width="220" height="85" fill="#bbdefb" stroke="#1976d2" stroke-width="3" rx="8"/>
                    <text x="170" y="50" text-anchor="middle" font-size="20" fill="#333" pointer-events="none">Actual</text>
                    <text x="170" y="80" text-anchor="middle" font-size="20" font-weight="600" fill="#1565c0" pointer-events="none">Positive</text>

                    <rect class="cm-box" data-type="an" x="280" y="15" width="220" height="85" fill="#ffe0b2" stroke="#ff9800" stroke-width="3" rx="8"/>
                    <text x="390" y="50" text-anchor="middle" font-size="20" fill="#333" pointer-events="none">Actual</text>
                    <text x="390" y="80" text-anchor="middle" font-size="20" font-weight="600" fill="#e65100" pointer-events="none">Negative</text>

                    <!-- Arrow -->
                    <defs>
                        <marker id="arrowhead2" markerWidth="12" markerHeight="9" refX="11" refY="4.5" orient="auto">
                            <polygon points="0 0, 12 4.5, 0 9" fill="#666"/>
                        </marker>
                    </defs>
                    <path d="M 280 120 L 280 160" stroke="#666" stroke-width="3" fill="none" marker-end="url(#arrowhead2)"/>
                    <text x="280" y="145" text-anchor="middle" font-size="16" fill="#666">Prediction or</text>
                    <text x="280" y="165" text-anchor="middle" font-size="16" fill="#666">Classification</text>

                    <!-- Main confusion matrix visualization -->
                    <!-- FN region (pink, outer) -->
                    <rect class="cm-box" data-type="fn" x="60" y="185" width="220" height="280" fill="#ffcdd2" stroke="#e57373" stroke-width="3" rx="8"/>
                    <text x="105" y="220" font-size="18" fill="#c62828" pointer-events="none">Predicted Wrongly</text>
                    <text x="105" y="245" font-size="18" fill="#c62828" pointer-events="none">As Negative (FN)</text>

                    <!-- TN region (light green, outer right) -->
                    <rect class="cm-box" data-type="tn" x="280" y="185" width="220" height="150" fill="#c8e6c9" stroke="#81c784" stroke-width="3" rx="8"/>
                    <text x="390" y="230" text-anchor="middle" font-size="18" fill="#2e7d32" pointer-events="none">Predicted Correctly</text>
                    <text x="390" y="258" text-anchor="middle" font-size="18" fill="#2e7d32" pointer-events="none">As Negative (TN)</text>

                    <!-- TP region (green, inner) -->
                    <rect class="cm-box" data-type="tp" x="90" y="280" width="190" height="165" fill="#a5d6a7" stroke="#66bb6a" stroke-width="4" rx="8"/>
                    <text x="185" y="350" text-anchor="middle" font-size="19" fill="#1b5e20" pointer-events="none">Predicted Correctly</text>
                    <text x="185" y="378" text-anchor="middle" font-size="19" fill="#1b5e20" pointer-events="none">As Positive (TP)</text>

                    <!-- FP region (orange/yellow) -->
                    <rect class="cm-box" data-type="fp" x="280" y="335" width="220" height="130" fill="#fff3e0" stroke="#ffb74d" stroke-width="3" rx="8"/>
                    <text x="390" y="385" text-anchor="middle" font-size="18" fill="#e65100" pointer-events="none">Predicted Wrongly</text>
                    <text x="390" y="413" text-anchor="middle" font-size="18" fill="#e65100" pointer-events="none">As Positive (FP)</text>

                    <!-- Annotations -->
                    <text x="60" y="505" font-size="16" fill="#c62828">Minimize this to</text>
                    <text x="60" y="530" font-size="16" font-weight="600" fill="#c62828">improve Recall</text>

                    <text x="330" y="505" font-size="16" fill="#e65100">Minimize this to</text>
                    <text x="330" y="530" font-size="16" font-weight="600" fill="#e65100">improve Precision</text>
                    <text x="330" y="555" font-size="16" font-weight="600" fill="#e65100">and Specificity</text>
                </svg>

                <!-- Right side: Formulas -->
                <div style="display: flex; flex-direction: column; gap: 18px; padding-top: 15px;" id="cmFormulas">
                    <!-- TPR -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="tp,fn">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>TPR</strong> (Recall) =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;"><span class="formula-box" data-type="tp" style="width: 30px; height: 30px; background: #a5d6a7; border: 3px solid #66bb6a; border-radius: 5px;"></span></div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="tp" style="width: 30px; height: 30px; background: #a5d6a7; border: 3px solid #66bb6a; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="fn" style="width: 30px; height: 30px; background: #ffcdd2; border: 3px solid #e57373; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= TP / (TP + FN)</span>
                    </div>

                    <!-- TNR -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="tn,fp">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>TNR</strong> (Specificity) =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;"><span class="formula-box" data-type="tn" style="width: 30px; height: 30px; background: #c8e6c9; border: 3px solid #81c784; border-radius: 5px;"></span></div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="tn" style="width: 30px; height: 30px; background: #c8e6c9; border: 3px solid #81c784; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="fp" style="width: 30px; height: 30px; background: #fff3e0; border: 3px solid #ffb74d; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= TN / (TN + FP)</span>
                    </div>

                    <!-- FNR -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="fn,tp">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>FNR</strong> =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;"><span class="formula-box" data-type="fn" style="width: 30px; height: 30px; background: #ffcdd2; border: 3px solid #e57373; border-radius: 5px;"></span></div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="tp" style="width: 30px; height: 30px; background: #a5d6a7; border: 3px solid #66bb6a; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="fn" style="width: 30px; height: 30px; background: #ffcdd2; border: 3px solid #e57373; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= FN / (TP + FN)</span>
                    </div>

                    <!-- FPR -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="fp,tn">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>FPR</strong> =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;"><span class="formula-box" data-type="fp" style="width: 30px; height: 30px; background: #fff3e0; border: 3px solid #ffb74d; border-radius: 5px;"></span></div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="tn" style="width: 30px; height: 30px; background: #c8e6c9; border: 3px solid #81c784; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="fp" style="width: 30px; height: 30px; background: #fff3e0; border: 3px solid #ffb74d; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= FP / (TN + FP)</span>
                    </div>

                    <!-- Precision -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="tp,fp">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>Precision</strong> =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;"><span class="formula-box" data-type="tp" style="width: 30px; height: 30px; background: #a5d6a7; border: 3px solid #66bb6a; border-radius: 5px;"></span></div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="tp" style="width: 30px; height: 30px; background: #a5d6a7; border: 3px solid #66bb6a; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="fp" style="width: 30px; height: 30px; background: #fff3e0; border: 3px solid #ffb74d; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= TP / (TP + FP)</span>
                    </div>

                    <!-- Accuracy -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="tp,tn,ap,an">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>Accuracy</strong> =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;">
                                <span class="formula-box" data-type="tp" style="width: 30px; height: 30px; background: #a5d6a7; border: 3px solid #66bb6a; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="tn" style="width: 30px; height: 30px; background: #c8e6c9; border: 3px solid #81c784; border-radius: 5px;"></span>
                            </div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="ap" style="width: 30px; height: 30px; background: #bbdefb; border: 3px solid #64b5f6; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="an" style="width: 30px; height: 30px; background: #ffe0b2; border: 3px solid #ffb74d; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= (TP + TN) / Total</span>
                    </div>

                    <!-- Prevalence -->
                    <div style="display: flex; align-items: center; gap: 12px;" class="formula-row" data-uses="ap,an">
                        <span style="font-size: 1.2em; width: 140px; color: #333;"><strong>Prevalence</strong> =</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="display: flex; gap: 5px;"><span class="formula-box" data-type="ap" style="width: 30px; height: 30px; background: #bbdefb; border: 3px solid #64b5f6; border-radius: 5px;"></span></div>
                            <div style="border-top: 3px solid #333; padding-top: 4px; display: flex; gap: 5px; align-items: center;">
                                <span class="formula-box" data-type="ap" style="width: 30px; height: 30px; background: #bbdefb; border: 3px solid #64b5f6; border-radius: 5px;"></span>
                                <span style="font-size: 18px;">+</span>
                                <span class="formula-box" data-type="an" style="width: 30px; height: 30px; background: #ffe0b2; border: 3px solid #ffb74d; border-radius: 5px;"></span>
                            </div>
                        </div>
                        <span style="font-size: 1.1em; color: #555;">= (TP + FN) / Total</span>
                    </div>
                </div>
            </div>
        </div>
        <script>
        (function() {
            const slide = document.getElementById('confusionMetricsSlide');
            const svgBoxes = slide.querySelectorAll('.cm-box');
            const formulaBoxes = slide.querySelectorAll('.formula-box');
            const allBoxes = [...svgBoxes, ...formulaBoxes];

            function highlightType(type, active) {
                allBoxes.forEach(box => {
                    if (box.dataset.type === type) {
                        box.classList.toggle('highlight', active);
                    } else if (active) {
                        box.classList.add('dim');
                    } else {
                        box.classList.remove('dim');
                    }
                });
            }

            function clearAll() {
                allBoxes.forEach(box => {
                    box.classList.remove('highlight', 'dim');
                });
            }

            svgBoxes.forEach(box => {
                box.addEventListener('mouseenter', () => highlightType(box.dataset.type, true));
                box.addEventListener('mouseleave', clearAll);
            });

            formulaBoxes.forEach(box => {
                box.addEventListener('mouseenter', () => highlightType(box.dataset.type, true));
                box.addEventListener('mouseleave', clearAll);
            });
        })();
        </script>

        <!-- Slide: Chihuahua Detector Confusion Matrix -->
        <div class="slide" id="chihuahuaSlide" style="padding: 15px 30px; background: #fff;">
            <style>
                #chihuahuaSlide .chihuahua-container { cursor: pointer; }
                #chihuahuaSlide .chihuahua-container:hover .tail { animation: wagTail 0.2s ease-in-out infinite alternate; }
                #chihuahuaSlide .chihuahua-container:hover .front-leg { animation: moveFrontLeg 0.3s ease-in-out infinite alternate; }
                #chihuahuaSlide .chihuahua-container:hover .back-leg { animation: moveBackLeg 0.3s ease-in-out infinite alternate-reverse; }
                #chihuahuaSlide .chihuahua-container:hover .ear-left { animation: wiggleEar 0.4s ease-in-out infinite alternate; }
                #chihuahuaSlide .chihuahua-container:hover .ear-right { animation: wiggleEar 0.4s ease-in-out infinite alternate-reverse; }
                @keyframes wagTail {
                    0% { transform: rotate(-20deg); }
                    100% { transform: rotate(30deg); }
                }
                @keyframes moveFrontLeg {
                    0% { transform: rotate(-15deg); }
                    100% { transform: rotate(15deg); }
                }
                @keyframes moveBackLeg {
                    0% { transform: rotate(-10deg); }
                    100% { transform: rotate(10deg); }
                }
                @keyframes wiggleEar {
                    0% { transform: rotate(-5deg); }
                    100% { transform: rotate(5deg); }
                }
            </style>
            <h1 style="font-size: 2.2em; color: #1a1a2e; font-weight: 400; margin-bottom: 5px;">Chihuahua Detector</h1>
            <p style="font-size: 1.1em; color: #666; margin-bottom: 10px;">Testing our model on 100 images (10 chihuahuas, 90 muffins)</p>
            <div style="display: flex; justify-content: center; align-items: flex-start; gap: 30px;">
                <!-- Animated Chihuahua -->
                <div class="chihuahua-container" style="padding-top: 30px;">
                    <svg width="140" height="180" viewBox="0 0 140 180">
                        <!-- Body -->
                        <ellipse cx="70" cy="110" rx="35" ry="28" fill="#d4a574"/>
                        <!-- Back leg -->
                        <g class="back-leg" style="transform-origin: 45px 125px;">
                            <rect x="40" y="125" width="12" height="35" rx="5" fill="#c4956a"/>
                            <ellipse cx="46" cy="162" rx="8" ry="5" fill="#b8896a"/>
                        </g>
                        <!-- Back leg 2 -->
                        <g class="back-leg" style="transform-origin: 85px 125px;">
                            <rect x="80" y="125" width="12" height="35" rx="5" fill="#c4956a"/>
                            <ellipse cx="86" cy="162" rx="8" ry="5" fill="#b8896a"/>
                        </g>
                        <!-- Front leg -->
                        <g class="front-leg" style="transform-origin: 50px 115px;">
                            <rect x="45" y="115" width="10" height="40" rx="4" fill="#d4a574"/>
                            <ellipse cx="50" cy="157" rx="7" ry="4" fill="#c4956a"/>
                        </g>
                        <!-- Front leg 2 -->
                        <g class="front-leg" style="transform-origin: 82px 115px;">
                            <rect x="77" y="115" width="10" height="40" rx="4" fill="#d4a574"/>
                            <ellipse cx="82" cy="157" rx="7" ry="4" fill="#c4956a"/>
                        </g>
                        <!-- Tail -->
                        <g class="tail" style="transform-origin: 30px 100px;">
                            <path d="M 30 100 Q 10 85 15 65" stroke="#d4a574" stroke-width="8" fill="none" stroke-linecap="round"/>
                        </g>
                        <!-- Head -->
                        <circle cx="70" cy="55" r="30" fill="#d4a574"/>
                        <!-- Ear left -->
                        <g class="ear-left" style="transform-origin: 48px 35px;">
                            <path d="M 48 35 L 35 10 L 55 25 Z" fill="#d4a574"/>
                            <path d="M 48 33 L 40 18 L 52 28 Z" fill="#e8b894"/>
                        </g>
                        <!-- Ear right -->
                        <g class="ear-right" style="transform-origin: 92px 35px;">
                            <path d="M 92 35 L 105 10 L 85 25 Z" fill="#d4a574"/>
                            <path d="M 92 33 L 100 18 L 88 28 Z" fill="#e8b894"/>
                        </g>
                        <!-- Snout -->
                        <ellipse cx="70" cy="65" rx="12" ry="10" fill="#e8c9a8"/>
                        <!-- Nose -->
                        <ellipse cx="70" cy="60" rx="5" ry="4" fill="#333"/>
                        <!-- Eyes -->
                        <circle cx="58" cy="50" r="8" fill="#fff"/>
                        <circle cx="82" cy="50" r="8" fill="#fff"/>
                        <circle cx="58" cy="50" r="5" fill="#333"/>
                        <circle cx="82" cy="50" r="5" fill="#333"/>
                        <circle cx="56" cy="48" r="2" fill="#fff"/>
                        <circle cx="80" cy="48" r="2" fill="#fff"/>
                        <!-- Mouth -->
                        <path d="M 65 70 Q 70 75 75 70" stroke="#333" stroke-width="2" fill="none"/>
                        <!-- Tongue (visible on hover via CSS would need JS, so always slight) -->
                    </svg>
                    <p style="text-align: center; font-size: 0.85em; color: #888; margin-top: 5px;">Hover me!</p>
                </div>

                <!-- Confusion Matrix -->
                <svg width="520" height="420" viewBox="0 0 520 420">
                    <!-- Title -->
                    <text x="310" y="30" text-anchor="middle" font-size="20" font-weight="600" fill="#333">Predicted</text>

                    <!-- Column headers -->
                    <text x="220" y="65" text-anchor="middle" font-size="18" fill="#333">Chihuahua</text>
                    <text x="390" y="65" text-anchor="middle" font-size="18" fill="#333">Muffin</text>

                    <!-- Row label (rotated) -->
                    <text x="30" y="210" text-anchor="middle" font-size="20" font-weight="600" fill="#333" transform="rotate(-90, 30, 210)">Actual</text>

                    <!-- Row headers -->
                    <text x="85" y="155" text-anchor="middle" font-size="18" fill="#333">Chihuahua</text>
                    <text x="85" y="285" text-anchor="middle" font-size="18" fill="#333">Muffin</text>

                    <!-- Matrix cells -->
                    <!-- True Positive (top-left) - green -->
                    <rect x="130" y="85" width="170" height="110" fill="#c8e6c9" stroke="#4caf50" stroke-width="3" rx="10"/>
                    <text x="215" y="125" text-anchor="middle" font-size="16" fill="#2e7d32">True Positive</text>
                    <text x="215" y="170" text-anchor="middle" font-size="42" font-weight="bold" fill="#1b5e20">9</text>

                    <!-- False Negative (top-right) - red -->
                    <rect x="300" y="85" width="170" height="110" fill="#ffcdd2" stroke="#e53935" stroke-width="3" rx="10"/>
                    <text x="385" y="125" text-anchor="middle" font-size="16" fill="#c62828">False Negative</text>
                    <text x="385" y="170" text-anchor="middle" font-size="42" font-weight="bold" fill="#b71c1c">1</text>

                    <!-- False Positive (bottom-left) - red -->
                    <rect x="130" y="195" width="170" height="110" fill="#ffcdd2" stroke="#e53935" stroke-width="3" rx="10"/>
                    <text x="215" y="235" text-anchor="middle" font-size="16" fill="#c62828">False Positive</text>
                    <text x="215" y="280" text-anchor="middle" font-size="42" font-weight="bold" fill="#b71c1c">27</text>

                    <!-- True Negative (bottom-right) - green -->
                    <rect x="300" y="195" width="170" height="110" fill="#c8e6c9" stroke="#4caf50" stroke-width="3" rx="10"/>
                    <text x="385" y="235" text-anchor="middle" font-size="16" fill="#2e7d32">True Negative</text>
                    <text x="385" y="280" text-anchor="middle" font-size="42" font-weight="bold" fill="#1b5e20">63</text>

                    <!-- Emoji annotations -->
                    <text x="215" y="188" text-anchor="middle" font-size="18">🐕✓</text>
                    <text x="385" y="188" text-anchor="middle" font-size="18">🐕→🧁</text>
                    <text x="215" y="298" text-anchor="middle" font-size="18">🧁→🐕</text>
                    <text x="385" y="298" text-anchor="middle" font-size="18">🧁✓</text>

                    <!-- Totals -->
                    <text x="215" y="330" text-anchor="middle" font-size="14" fill="#666">n=36</text>
                    <text x="385" y="330" text-anchor="middle" font-size="14" fill="#666">n=64</text>
                    <text x="490" y="155" text-anchor="middle" font-size="14" fill="#666">n=10</text>
                    <text x="490" y="265" text-anchor="middle" font-size="14" fill="#666">n=90</text>
                </svg>

                <!-- Metrics panel -->
                <div style="padding-top: 20px;">
                    <div style="background: #f5f5f5; padding: 20px 25px; border-radius: 10px; margin-bottom: 15px;">
                        <p style="font-size: 1.2em; margin: 0 0 12px 0; color: #333;"><strong>Metrics:</strong></p>
                        <p style="font-size: 1.1em; margin: 6px 0; color: #444;">
                            <strong>Accuracy:</strong> (9+63)/100 = <span style="color: #1976d2; font-weight: 600;">72%</span>
                        </p>
                        <p style="font-size: 1.1em; margin: 6px 0; color: #444;">
                            <strong>Precision:</strong> 9/(9+27) = <span style="color: #1976d2; font-weight: 600;">25%</span>
                        </p>
                        <p style="font-size: 1.1em; margin: 6px 0; color: #444;">
                            <strong>Recall:</strong> 9/(9+1) = <span style="color: #1976d2; font-weight: 600;">90%</span>
                        </p>
                        <p style="font-size: 1.1em; margin: 6px 0; color: #444;">
                            <strong>Specificity:</strong> 63/(63+27) = <span style="color: #1976d2; font-weight: 600;">70%</span>
                        </p>
                    </div>
                    <div style="background: #fff3e0; padding: 15px 20px; border-radius: 10px; border-left: 5px solid #ff9800;">
                        <p style="font-size: 1em; color: #e65100; margin: 0;">
                            <strong>Problem:</strong> High recall but low precision — the model is too eager to call everything a chihuahua!
                        </p>
                    </div>
                </div>
            </div>
            <p style="font-size: 0.85em; color: #888; margin-top: 8px; text-align: center;">
                Inspired by Karen Zack's viral "Chihuahua or Muffin" meme (2016). Data simulated for illustration.
            </p>
        </div>

        <!-- Slide 8: Causation -->
        <div class="slide">
            <h1>Prediction ≠ Causation</h1>
            <ul>
                <li><strong>Causal claims</strong> require no confounders</li>
                <li>Only valid under special settings (controlled experiments)</li>
                <li>Be careful when:
                    <ul>
                        <li>Predicting values in the future</li>
                        <li>Extrapolating beyond given data</li>
                        <li>Making claims for combinations not in data</li>
                    </ul>
                </li>
            </ul>
        </div>

        <!-- Slide: Nobel Laureates vs Chocolate Consumption -->
        <div class="slide" style="padding: 10px;">
            <div class="smart-plot" style="margin-top: 0; max-height: calc(100vh - 20px);">
                <div class="sp-header">
                    <span class="title">R Code (ggplot2) – Edit and run in your browser!</span>
                    <button class="sp-btn" id="runBtn" disabled>
                        <span class="icon">▶</span>
                        <span class="label">Run</span>
                    </button>
                </div>
                <div class="sp-content">
                    <textarea class="sp-editor" id="editor"># Data from kustats::ds16_Nobel_Laureates_and_Chocolate
# Source: Messerli (2012) NEJM; Triola (2018) Elementary Statistics

data <- data.frame(
  Country = c("Australia", "Austria", "Belgium", "Brazil", "Canada", "China",
              "Denmark", "Finland", "France", "Germany", "Greece", "Ireland",
              "Italy", "Japan", "Netherlands", "Norway", "Poland", "Portugal",
              "Spain", "Sweden", "Switzerland", "United Kingdom", "United States"),
  CHOCOLATE = c(4.8, 8.5, 5.7, 2.9, 3.9, 0.7, 8.5, 7.3, 6.3, 11.6, 2.5, 9.0,
                3.7, 2.0, 4.5, 9.4, 3.2, 2.0, 3.6, 6.4, 11.9, 9.7, 5.3),
  NOBEL = c(5.2, 24.7, 8.7, 0.1, 6.0, 0.1, 25.3, 7.6, 9.0, 12.8, 1.5, 12.7,
            3.3, 1.3, 8.0, 23.4, 3.1, 1.4, 1.8, 31.0, 31.5, 18.9, 10.5),
  Flag = c("🇦🇺", "🇦🇹", "🇧🇪", "🇧🇷", "🇨🇦", "🇨🇳", "🇩🇰", "🇫🇮", "🇫🇷", "🇩🇪",
           "🇬🇷", "🇮🇪", "🇮🇹", "🇯🇵", "🇳🇱", "🇳🇴", "🇵🇱", "🇵🇹", "🇪🇸", "🇸🇪",
           "🇨🇭", "🇬🇧", "🇺🇸")
)

library(ggplot2)

ggplot(data, aes(x = CHOCOLATE, y = NOBEL)) +
  geom_text(aes(label = Flag), size = 12, family = "Apple Color Emoji") +
  labs(
    title = "Nobel Laureates vs Chocolate Consumption",
    x = "Chocolate Consumption (kg/capita/year)",
    y = "Nobel Laureates per 10 Million Population",
    caption = "Messerli, F.H. (2012). Chocolate Consumption, Cognitive Function, and Nobel Laureates.\nNew England Journal of Medicine, 367(16), 1562-1564. DOI: 10.1056/NEJMon1211064"
  ) +
  theme_minimal(base_size = 24) +
  theme(
    plot.title = element_text(face = "bold", size = 28, hjust = 0.5),
    plot.caption = element_text(size = 14, hjust = 0.5, color = "gray30"),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 18),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  coord_cartesian(xlim = c(0, 14), ylim = c(-2, 35))</textarea>
                    <div class="sp-output" id="output"></div>
                </div>
                <div class="sp-status" id="status">Initializing WebR...</div>
            </div>
        </div>
    </div>

    <div class="nav">
        <button id="prevBtn" disabled>← Previous</button>
        <button id="nextBtn">Next →</button>
    </div>
    <div class="page-num" id="pageNum">1 / 8</div>

    <script type="module">
        // Slide navigation
        const slides = document.querySelectorAll('.slide');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageNum = document.getElementById('pageNum');
        let current = 0;

        function showSlide(n) {
            slides[current].classList.remove('active');
            // Wrap around: going back from first slide goes to last, going forward from last goes to first
            if (n < 0) {
                current = slides.length - 1;
            } else if (n >= slides.length) {
                current = 0;
            } else {
                current = n;
            }
            slides[current].classList.add('active');
            prevBtn.disabled = false;
            nextBtn.disabled = false;
            pageNum.textContent = `${current + 1} / ${slides.length}`;
        }

        prevBtn.addEventListener('click', () => showSlide(current - 1));
        nextBtn.addEventListener('click', () => showSlide(current + 1));
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') showSlide(current + 1);
            if (e.key === 'ArrowLeft') showSlide(current - 1);
        });

        // Correlation Animation - load data from JSON file
        (async function() {
            const canvas = document.getElementById('correlationCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size to fill window
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Load data from JSON file
            let CORRELATION_DATA;
            try {
                const response = await fetch('correlation_data.json');
                CORRELATION_DATA = await response.json();
            } catch (err) {
                console.error('Failed to load correlation_data.json:', err);
                ctx.fillText('Error loading data', 100, 100);
                return;
            }

            const CANVAS_W = 100, CANVAS_H = 60;  // Data coordinate system

            function calcCorrelation(points) {
                const n = points.length;
                const meanX = points.reduce((s, p) => s + p.x, 0) / n;
                const meanY = points.reduce((s, p) => s + p.y, 0) / n;
                let num = 0, denX = 0, denY = 0;
                for (const p of points) {
                    const dx = p.x - meanX;
                    const dy = p.y - meanY;
                    num += dx * dy;
                    denX += dx * dx;
                    denY += dy * dy;
                }
                return num / Math.sqrt(denX * denY);
            }

            // Convert loaded data to {x, y} format
            const shapes = [
                CORRELATION_DATA.shapes.text.points.map(p => ({x: p[0], y: p[1]})),
                CORRELATION_DATA.shapes.line.points.map(p => ({x: p[0], y: p[1]})),
                CORRELATION_DATA.shapes.face.points.map(p => ({x: p[0], y: p[1]}))
            ];
            const shapeNames = ['CORRELATION', 'X Pattern', '🫠'];

            let currentShapeIdx = 0;
            let previousPoints = shapes[0].map(p => ({...p}));
            let currentPoints = shapes[0].map(p => ({...p}));
            let lastShapeChange = Date.now();
            const shapeDuration = 4000;  // Time to display each shape (after morph completes)
            const morphDuration = 1500;  // Time to morph between shapes
            let isMorphing = false;

            function lerp(a, b, t) {
                return a + (b - a) * t;
            }

            function easeInOut(t) {
                return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
            }

            function animate() {
                const now = Date.now();
                const elapsed = now - lastShapeChange;

                // Check if time to start morphing to next shape
                if (elapsed > shapeDuration + morphDuration) {
                    // Save current positions as start of next morph
                    previousPoints = currentPoints.map(p => ({...p}));
                    currentShapeIdx = (currentShapeIdx + 1) % shapes.length;
                    lastShapeChange = now;
                    isMorphing = true;
                }

                // Calculate morph progress (0 to 1 during morph, then stays at 1)
                const morphT = Math.min(1, elapsed / morphDuration);
                const easedT = easeInOut(morphT);

                // Morph points from previous to target
                const targetPoints = shapes[currentShapeIdx];
                for (let i = 0; i < currentPoints.length; i++) {
                    currentPoints[i].x = lerp(previousPoints[i].x, targetPoints[i].x, easedT);
                    currentPoints[i].y = lerp(previousPoints[i].y, targetPoints[i].y, easedT);
                }

                // Draw
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Responsive margins based on canvas size
                const margin = Math.min(100, canvas.width * 0.08);
                const rightMargin = Math.min(60, canvas.width * 0.04);
                const topMargin = Math.min(60, canvas.height * 0.06);

                // Draw axes
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin, canvas.height - margin);
                ctx.lineTo(canvas.width - rightMargin, canvas.height - margin);
                ctx.moveTo(margin, canvas.height - margin);
                ctx.lineTo(margin, topMargin);
                ctx.stroke();

                // Draw points
                ctx.fillStyle = '#3498db';
                const plotWidth = canvas.width - margin - rightMargin;
                const plotHeight = canvas.height - margin - topMargin;
                const pointSize = Math.max(2, Math.min(4, canvas.width / 500));

                for (const p of currentPoints) {
                    const x = margin + (p.x / CANVAS_W) * plotWidth;
                    const y = (canvas.height - margin) - (p.y / CANVAS_H) * plotHeight;
                    ctx.beginPath();
                    ctx.arc(x, y, pointSize, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Calculate and display correlation overlaid on plot
                const r = calcCorrelation(currentPoints);
                const fontSize = Math.max(36, Math.min(72, canvas.width / 20));
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.font = `bold ${fontSize}px -apple-system, sans-serif`;
                ctx.textAlign = 'right';
                ctx.fillText(`ρ = ${r.toFixed(2)}`, canvas.width - rightMargin - 20, topMargin + fontSize);

                requestAnimationFrame(animate);
            }

            animate();
        })();

        // WebR Integration - shared across all smart plots
        import { WebR } from 'https://webr.r-wasm.org/latest/webr.mjs';

        const webR = new WebR();
        let shelter = null;

        // Smart plot configurations
        const smartPlots = [
            { runBtn: 'runBtn', editor: 'editor', output: 'output', status: 'status', isShowingPlot: false },
            { runBtn: 'runBtn2', editor: 'editor2', output: 'output2', status: 'status2', isShowingPlot: false },
            { runBtn: 'runBtn3', editor: 'editor3', output: 'output3', status: 'status3', isShowingPlot: false },
            { runBtn: 'runBtn4', editor: 'editor4', output: 'output4', status: 'status4', isShowingPlot: false },
            { runBtn: 'runBtn5', editor: 'editor5', output: 'output5', status: 'status5', isShowingPlot: false },
            { runBtn: 'runBtn6', editor: 'editor6', output: 'output6', status: 'status6', isShowingPlot: false },
            { runBtn: 'runBtn7', editor: 'editor7', output: 'output7', status: 'status7', isShowingPlot: false },
            { runBtn: 'runBtn8', editor: 'editor8', output: 'output8', status: 'status8', isShowingPlot: false },
            { runBtn: 'runBtn9', editor: 'editor9', output: 'output9', status: 'status9', isShowingPlot: false },
            { runBtn: 'runBtn10', editor: 'editor10', output: 'output10', status: 'status10', isShowingPlot: false },
            { runBtn: 'runBtn11', editor: 'editor11', output: 'output11', status: 'status11', isShowingPlot: false },
            { runBtn: 'runBtn12', editor: 'editor12', output: 'output12', status: 'status12', isShowingPlot: false },
            { runBtn: 'runBtn13', editor: 'editor13', output: 'output13', status: 'status13', isShowingPlot: false },
            { runBtn: 'runBtn14', editor: 'editor14', output: 'output14', status: 'status14', isShowingPlot: false },
            { runBtn: 'runBtn15', editor: 'editor15', output: 'output15', status: 'status15', isShowingPlot: false }
        ];

        async function initWebR() {
            // Update all status indicators
            smartPlots.forEach(sp => {
                const statusEl = document.getElementById(sp.status);
                if (statusEl) {
                    statusEl.innerHTML = '<span class="loader"></span>Loading WebR...';
                    statusEl.className = 'sp-status loading';
                }
            });

            try {
                console.log('Initializing WebR...');
                await webR.init();
                console.log('WebR initialized, creating shelter...');

                shelter = await new webR.Shelter();
                console.log('Shelter created, installing ggplot2...');

                smartPlots.forEach(sp => {
                    const statusEl = document.getElementById(sp.status);
                    if (statusEl) {
                        statusEl.innerHTML = '<span class="loader"></span>Installing ggplot2 (~30s first time)...';
                    }
                });

                await webR.installPackages(['ggplot2']);
                console.log('ggplot2 installed!');

                // Preload Type 1 vs Type 2 Fun dataset
                await shelter.captureR(`
                    ActivityType <- c("Cleaning the house", "Home renovation project", "Marathon running", "Moving apartments", "Overnight backpacking", "Cooking class", "Concert", "Waiting in line", "Road trip with music", "Picnic in the park", "Concert", "Video game session", "Training for certification exam", "Concert", "Cleaning the house", "Playing board games", "Training for certification exam", "Marathon running", "Beach day with friends", "Road trip with music", "Tough obstacle course", "Long commute", "Road trip with music", "Public speaking event", "Marathon running", "Cooking class", "Overnight backpacking", "Cleaning the house", "Playing board games", "Mountain summit hike", "Video game session", "Cold plunge / ice bath", "Assembling flat-pack furniture", "Beach day with friends", "Long commute", "Road trip with music", "Cold plunge / ice bath", "Home renovation project", "Karaoke night", "Karaoke night", "Marathon running", "Concert", "Movie marathon", "Waiting in line", "Road trip with music", "Concert", "Waiting in line", "Karaoke night", "Overnight backpacking", "Amusement park visit", "Cooking class", "Amusement park visit", "Cooking class", "Video game session", "Karaoke night", "Cold plunge / ice bath", "Road trip with music", "Home renovation project", "Amusement park visit", "Long commute", "Marathon running", "Waiting in line", "Cold plunge / ice bath", "Overnight backpacking", "Public speaking event", "Home renovation project", "Learning a new language", "Tough obstacle course", "Marathon running", "Long commute", "Public speaking event", "Cold plunge / ice bath", "Mountain summit hike", "Marathon running", "Waiting in line", "Cold plunge / ice bath", "Public speaking event", "Picnic in the park", "Assembling flat-pack furniture", "Learning a new language", "Overnight backpacking", "Waiting in line", "Beach day with friends", "Video game session", "Video game session", "Mountain summit hike", "Karaoke night", "Cooking class", "Video game session", "Waiting in line", "Cleaning the house", "Moving apartments", "Cleaning the house", "Cleaning the house", "Movie marathon", "Learning a new language", "Overnight backpacking", "Road trip with music", "Cleaning the house", "Training for certification exam")
                    FunDuring <- c(3.6, 4.6, 3.0, 3.0, 3.6, 6.6, 8.4, 4.7, 7.4, 9.4, 7.4, 7.4, 4.6, 7.5, 4.2, 7.0, 2.0, 2.2, 7.3, 8.9, 3.2, 4.2, 7.2, 4.0, 2.2, 8.2, 2.1, 3.7, 9.3, 3.8, 8.3, 3.0, 4.9, 7.4, 4.4, 8.1, 4.3, 2.7, 8.6, 7.7, 4.0, 7.4, 7.6, 4.3, 6.6, 8.8, 3.3, 9.4, 2.8, 7.1, 7.3, 6.7, 7.6, 8.0, 8.3, 3.0, 6.6, 3.5, 7.2, 3.1, 2.5, 3.8, 4.1, 3.1, 3.6, 4.7, 3.0, 3.0, 2.9, 2.6, 4.0, 4.0, 3.5, 3.2, 3.2, 3.1, 3.3, 9.2, 2.6, 4.1, 3.2, 3.9, 6.7, 8.3, 7.8, 5.0, 9.3, 7.5, 7.4, 2.6, 4.3, 4.1, 3.5, 4.6, 8.6, 3.1, 4.1, 7.8, 3.5, 4.9)
                    FunAfter <- c(5.1, 4.8, 6.5, 6.5, 5.6, 7.0, 8.2, 3.6, 6.8, 10.0, 6.9, 6.9, 6.2, 6.9, 3.7, 6.6, 8.6, 7.8, 7.8, 9.4, 8.0, 4.0, 6.9, 6.9, 7.5, 8.5, 7.8, 3.4, 10.0, 7.6, 9.2, 6.2, 4.3, 7.7, 3.0, 8.1, 4.8, 7.6, 8.3, 7.4, 6.8, 6.9, 8.8, 4.2, 6.0, 8.4, 4.3, 10.0, 6.8, 7.5, 7.6, 7.3, 7.3, 7.8, 7.9, 6.9, 7.8, 6.9, 7.5, 4.4, 8.8, 4.3, 7.0, 7.5, 7.1, 6.2, 6.6, 7.4, 7.4, 5.4, 5.8, 6.3, 6.7, 7.1, 3.0, 8.2, 6.4, 9.5, 3.1, 5.5, 8.1, 4.6, 6.4, 8.6, 7.2, 6.4, 9.8, 7.0, 7.3, 5.4, 4.4, 5.8, 4.1, 3.7, 9.3, 7.8, 6.3, 7.8, 3.6, 5.3)
                `);
                console.log('Type 1 vs Type 2 Fun data preloaded!');

                // Preload Fire Incidents dataset from CSV
                await shelter.captureR(`
                    fire_csv <- "structures_burned,firefighters,property_damage
1.9,16,659930.51
9.5,85,2805215.47
4.5,40,1423669.35
3.2,23,1137953.84
1.0,5,425734.71
1.0,10,378727.77
0.7,5,363856.1
6.5,61,2135502.12
3.3,31,1184497.79
4.2,31,1355431.54
0.6,5,143651.67
11.0,94,3325208.78
5.9,46,1938762.93
1.2,15,242278.51
1.1,5,385912.09
1.1,5,273349.46
1.6,12,480790.08
2.7,22,1011302.83
2.2,15,687648.22
1.5,15,466766.18
3.3,21,797755.37
1.0,6,397149.11
1.5,12,557786.59
1.9,17,885137.7
2.3,22,651874.48
5.1,35,1567014.96
1.2,5,387869.83
2.7,27,1036444.23
3.2,27,943459.92
0.6,5,234660.69
3.3,34,1082984.2
1.1,9,346256.5
0.7,11,143572.5
9.4,75,2855432.51
10.6,95,3344612.07
5.5,52,1483121.12
1.6,11,496904.53
0.8,11,137481.46
4.0,34,1366732.68
2.2,24,443603.72
0.9,5,183298.73
2.6,23,821774.29
0.6,10,416322.95
7.7,52,2300518.06
1.4,5,336232.07
3.8,19,1409803.78
1.6,11,268989.84
2.7,25,480878.91
2.9,30,928103.59
1.1,9,258641.61
11.0,95,3140341.5
5.0,32,1599274.31
8.9,62,2711155.08
7.3,57,2092325.0
3.2,27,777903.31
8.1,65,2575360.44
0.8,5,330920.09
1.2,8,331444.85
0.6,5,468649.32
1.7,16,343666.16
2.0,17,364088.49
1.4,6,331118.19
5.8,43,1731264.18
1.8,9,583605.22
1.5,11,410637.15
2.8,27,906974.68
1.0,5,98977.42
5.4,45,1824999.93
0.7,5,207405.61
13.5,100,4218326.08
4.9,38,1532944.2
1.2,5,417898.48
0.5,5,240448.77
5.6,38,1738063.38
4.2,43,1350794.73
4.4,35,1524469.5
4.9,35,1507171.25
0.7,6,325586.9
1.8,14,536043.05
0.9,5,476852.68
6.5,54,1838217.77
3.4,31,1298812.14
1.7,10,505613.23
0.7,5,50000.0
1.6,11,504455.18
1.7,5,401825.04
4.4,27,1453184.74
3.5,35,965506.83
7.0,64,2047099.21
2.4,18,441728.41
0.9,9,196789.21
4.2,35,910631.81
4.8,53,1199768.05
3.0,29,1005560.94
4.9,38,1594370.99
2.5,15,826551.89
2.7,13,670664.53
2.2,18,644876.07
0.6,5,172632.62
0.8,5,78995.99
0.6,5,404250.06
3.5,22,1192160.94
1.6,21,456512.41
2.6,25,793426.34
7.6,61,2324396.4
1.4,18,101804.71
2.1,17,588377.17
4.7,33,1315576.6
1.3,17,233581.64
0.7,8,179928.81
1.5,7,727579.25
1.0,7,404353.95
8.5,63,2453778.23
5.5,36,1721685.79
3.5,32,1263048.09
6.7,62,2135062.81
5.4,36,1624116.6
1.1,11,238805.41
7.2,54,2262465.56
2.8,20,906612.72
5.4,40,1766892.45
7.3,54,2283094.15
1.6,13,651890.55
0.8,5,174647.66
1.3,11,580427.18
2.2,17,680991.86
5.6,43,1994735.88
6.4,46,1820832.3
0.5,5,416673.34
2.6,24,823075.16
2.1,19,538533.29
1.3,5,303467.73
0.9,7,216860.26
1.7,17,584342.61
9.1,64,2805234.33
1.7,16,415290.42
2.7,18,804654.34
4.1,35,1564018.83
1.9,11,815908.52
11.2,80,3426466.87
10.3,74,3109509.4
1.4,11,429059.86
2.6,21,860921.05
1.6,8,318718.53
1.5,15,413118.23
0.6,5,50000.0
3.3,26,1056326.33
2.6,14,875747.06
0.7,5,125088.01
1.5,12,680061.34
7.7,57,2116110.01
1.3,8,176818.26
1.0,12,324545.55
2.5,17,912109.64
13.2,100,4222222.44
1.3,5,330597.69
3.8,33,1315441.63
4.8,45,1434722.59
1.3,5,368305.76
4.4,31,1455023.03
1.9,17,660518.95
3.5,26,813994.55
3.5,29,1274935.1
2.8,19,1047660.43
0.8,6,141331.84
5.9,46,1832650.84
1.7,19,572233.79
1.1,10,374889.96
0.6,6,104921.01
3.2,23,853657.06
3.9,28,1164833.45
0.6,5,340963.61
2.7,23,877407.55
1.3,8,325549.58
3.6,30,1198266.71
1.1,18,50000.0
4.0,36,1379106.13
2.0,14,329105.76
8.8,76,2579943.29
0.9,5,115199.49
1.8,5,331216.97
0.9,5,432523.87
8.3,56,2407416.18
6.8,52,2090475.92
1.4,11,411456.55
3.7,38,1192442.59
5.6,46,1691058.95
2.9,22,686670.29
2.8,26,978291.49
1.3,5,325125.85
0.8,7,50000.0
7.3,62,2133393.63
7.4,51,2451210.95
3.5,33,1179936.19
1.7,15,470344.04
1.8,12,484222.2
4.4,38,1266773.63
7.3,69,2508199.81
7.0,57,2170309.63
5.0,41,1576712.22
3.6,26,1229122.14
0.8,5,264920.93
1.0,12,269808.47
7.4,54,2179954.97
3.3,26,978504.36
0.5,5,152732.31
0.8,8,355441.64
3.8,31,1138038.03
0.5,9,264463.0
1.0,5,295676.75
2.9,21,877923.34
4.0,27,909853.66
3.7,27,1237346.49
1.3,11,430528.15
4.2,37,1420577.08
1.3,5,50000.0
1.7,17,817527.62
4.6,43,1364183.35
3.6,31,1260123.86
6.2,58,1696774.58
3.7,25,1206548.05
3.0,17,748027.54
0.8,5,144956.01
1.9,22,849679.38
1.4,14,398741.77
1.3,10,434345.11
11.3,92,3531588.63
2.0,10,673801.03
7.2,69,2176012.53
3.5,28,1102345.1
5.3,42,1935955.07
2.6,24,769948.97
3.1,27,954305.17
2.5,21,918062.25
1.2,5,511322.3
4.3,37,1481640.17
1.5,21,542429.16
0.6,11,50000.0
3.6,36,1328286.64
1.1,6,153488.4
9.0,66,2734370.15
9.7,77,2806664.79
7.9,63,2357538.14
1.9,20,615373.02
0.5,5,212223.17
8.4,74,2585259.22
2.2,16,895101.14
10.7,83,3278787.96
10.4,78,3095738.43
6.3,41,2020261.39
1.5,16,642319.03
2.0,16,403521.57
6.2,43,1953864.0
1.6,6,598207.52
1.1,6,272512.23
2.9,31,1088719.31
8.8,68,2603655.79
4.1,25,1240579.51
3.0,23,883740.33
0.8,5,244342.23
3.4,13,844636.38
14.3,100,4083505.14
1.0,6,525004.29
2.7,25,680401.59
6.8,63,1890038.92
4.6,42,1042022.31
4.1,31,1128822.72
4.1,27,1042595.33
1.8,27,797245.38
1.5,12,614278.44
5.5,43,1538414.5
5.5,43,1983060.75
6.6,53,2113419.87
7.8,61,2301429.66
2.6,18,419573.06
2.6,17,1120207.33
5.3,42,1382419.07
3.6,26,847937.36
4.1,29,1392881.15
5.3,42,1945720.39
7.1,55,2344232.05
1.7,21,605820.53
1.9,5,663056.26
0.8,11,366838.77
3.1,30,1040911.91
0.6,5,225122.41
2.4,17,729576.42
2.8,20,844676.16
1.5,5,340772.91
3.2,21,912168.02
0.6,5,50000.0
0.6,13,169506.21
5.7,50,1558127.57
1.8,21,386388.12
0.9,10,299284.26
2.7,16,1023588.57
4.9,36,1610430.64
1.2,12,133231.11
3.4,21,879253.44
0.8,9,371405.6
0.7,5,50385.48
2.8,20,798423.07
2.8,26,932627.21
3.5,30,917832.04
4.4,33,1331270.83
11.7,99,3301097.48
2.7,16,713456.86
1.7,16,548985.03
5.3,45,1338139.52
1.4,10,500337.53
2.2,19,667239.42
0.7,5,306408.14
0.6,9,206696.97
10.4,81,3313263.0
5.9,44,1795774.55
4.1,37,1157167.63
2.1,13,641618.31
1.1,5,402770.59
1.0,5,310437.68
1.4,13,415294.14
2.9,16,761812.83
4.3,42,1179029.22
3.7,19,911060.52
1.5,20,708007.55
9.8,79,2751713.66
4.5,35,1251179.88
2.9,20,769646.34
3.3,28,1135666.08
2.1,16,595391.63
1.4,16,593356.47
1.8,15,444989.12
4.8,38,1468212.79
0.5,5,50000.0
0.9,6,582814.72
0.6,6,50000.0
0.6,5,233896.41
6.3,43,1985849.26
4.1,36,1306686.42
2.4,20,700712.99
0.8,5,223188.12
2.5,20,765437.89
2.4,21,705255.0
1.1,5,465757.11
2.2,13,993587.67
2.0,17,523879.19
3.4,22,805579.74
3.5,30,1044060.78
0.6,5,578682.49
1.9,20,451894.42
3.4,29,1280680.02
2.6,22,1031150.63
6.3,55,1814176.27
3.7,38,1202824.75
1.0,13,554327.08
0.7,5,158995.03
3.6,22,1045017.68
0.6,5,86930.03
3.1,25,790999.13
9.0,74,2588138.28
3.1,20,737513.16
2.0,16,597283.14
3.6,24,962248.46
2.3,15,736728.26
2.9,15,626548.58
9.0,67,2753946.47
2.0,8,714164.12
10.2,77,2775122.33
7.6,65,2327927.05
1.2,5,530256.98
0.7,18,50000.0
0.8,9,496488.66
0.6,5,229403.75
0.8,5,133532.73
3.9,35,1175622.02
0.7,5,300213.7
1.7,13,507142.28
6.1,61,1907986.83
0.6,5,50000.0
5.6,50,1691481.58
1.5,8,235917.95
0.9,6,246491.2
4.1,41,1088253.72
3.5,24,931929.77
6.8,63,2224888.21
4.5,39,1509160.74
5.4,40,1705666.94
1.5,15,284353.56
1.1,13,278338.7
4.7,40,1581845.41
5.4,35,1651045.8
14.5,100,4689203.83
2.1,15,687869.09
1.9,14,597526.89
5.0,43,1451791.58
1.8,14,545091.44
8.5,61,2530253.66
6.4,52,2015571.54
2.2,20,797825.4
4.7,40,1282907.83
4.7,43,1214484.75
0.8,10,50000.0
7.5,62,2321799.81
2.6,20,617831.75
5.8,37,1403265.71
1.7,15,555448.67
7.3,59,2556861.39
2.0,17,592778.97
0.5,5,285580.74
7.6,55,2284390.97
0.8,11,221319.6
1.7,13,634049.74
9.5,79,2803733.96
9.5,76,2897263.43
3.1,24,965052.23
3.5,32,949093.5
2.3,15,834319.55
1.5,12,436076.54
1.7,11,395275.93
3.8,28,1235167.7
4.7,35,1271483.89
5.2,42,1565603.05
5.2,39,1551580.08
0.8,12,398957.59
2.5,15,835049.37
0.7,5,199599.49
2.9,20,990380.13
2.2,25,882830.88
7.1,57,2201628.34
1.8,19,540525.35
0.9,5,65279.94
1.0,9,129109.84
4.8,42,1394303.79
3.4,27,925188.28
0.8,11,217902.15
0.8,5,237567.46
4.1,40,1315941.54
0.7,17,207416.66
5.7,43,1775642.52
4.2,31,1262170.94
0.8,13,50000.0
0.8,14,88888.17
13.4,100,4012299.57
1.9,13,390499.61
1.9,13,656739.04
5.5,37,1887630.49
9.3,70,2980762.36
13.3,100,3959880.12
4.7,33,1633518.23
1.9,15,597119.02
0.8,7,177911.7
5.0,47,1409107.89
3.0,18,840253.91
2.2,22,588603.29
7.6,59,2306976.34
0.9,6,280178.28
2.5,23,761111.5
0.5,5,225817.46
2.4,21,897715.87
0.7,6,344588.51
0.9,9,50000.0
0.9,8,50000.0
3.6,41,1232959.53
4.6,33,1178506.14
3.1,22,904283.59
10.3,79,2921731.23
1.9,12,302519.85
1.5,8,534041.65
6.6,58,2090425.56
1.3,17,291297.3
10.4,80,2733926.75
0.5,5,79069.38
11.0,90,3361044.83
0.6,5,50000.0
7.2,60,2173453.09
2.8,23,822832.45
15.0,100,4586893.72
0.7,13,236932.29
2.9,32,730438.36
11.0,84,3464703.42
2.7,19,792620.1
3.5,29,1039269.78
4.1,34,1080920.92
2.3,21,629022.64
3.5,37,906186.35
3.1,24,914101.37
7.4,55,2489565.76
0.6,5,50000.0
1.5,8,204824.24
9.5,75,3074271.95
7.1,66,2107309.69
2.3,16,596996.82
3.4,28,1177125.43
1.5,11,351543.75
1.1,14,611465.2
2.4,31,812441.62
1.8,11,469171.47
3.1,22,1262215.57
0.7,11,131972.82
11.5,95,3559778.42
13.4,100,4050372.91"
                    fire_data <- read.csv(text = fire_csv)
                    structures_burned <- fire_data$structures_burned
                    firefighters <- fire_data$firefighters
                    property_damage <- fire_data$property_damage
                `);
                console.log('Fire Incidents data preloaded!');

                // Preload Marathon Opinion dataset from CSV (meters run during marathon)
                await shelter.captureR(`
                    marathon_csv <- "meters_run,opinion
6736.2,2.2
563.9,6.2
394.0,6.7
2801.2,4.8
7740.9,3.1
1290.5,6.7
37563.1,0.9
6278.5,3.4
1830.5,4.9
1070.1,5.4
796.0,6.1
8202.5,3.5
1417.0,6.2
143.4,7.0
1109.1,5.2
8658.3,2.8
301.4,7.8
288.8,7.0
2485.8,3.3
2489.9,4.7
4628.8,3.8
16981.7,2.4
7977.8,2.4
4018.8,5.2
7881.4,3.0
704.5,6.0
890.8,5.2
397.4,6.2
590.3,5.5
4534.0,3.6
174.5,7.2
1375.9,6.8
1352.5,4.0
1977.2,4.1
1311.9,5.1
660.3,6.7
1316.1,5.1
22150.3,2.4
30106.9,0.9
2077.1,4.9
4345.5,5.1
201.2,7.0
680.7,6.5
1227.5,5.6
18805.6,0.6
454.5,6.2
1853.9,5.7
38668.0,1.3
2310.9,3.8
4064.5,4.5
207.3,7.3
14769.3,2.7
3829.9,4.3
2697.4,3.7
794.0,6.5
628.6,5.6
1243.9,4.5
6146.0,2.9
19874.8,1.8
2187.7,4.8
5716.4,3.0
3453.3,4.7
4370.5,4.1
5905.2,3.1
16269.3,2.9
165.4,8.7
10112.7,2.8
436.2,6.6
323.5,5.8
3183.1,4.0
178.3,7.6
21096.7,2.2
4432.9,3.8
7927.9,3.4
110.2,9.0
3635.3,3.8
2895.4,4.1
261.4,6.4
252.3,7.4
6698.0,4.1
686.8,4.9
6555.5,2.9
2853.7,4.5
1049.8,6.2
26835.8,2.0
16203.3,2.5
867.5,5.7
130.1,8.5
631.1,7.0
1110.0,4.4
7090.9,3.8
41027.6,1.1
859.7,5.5
10043.5,1.2
3607.8,3.2
6544.8,4.6
249.3,6.9
1114.7,4.8
428.9,6.4
797.4,5.5
2223.8,4.8
5624.2,4.7
189.7,7.3
220.6,7.6
700.3,5.3
5454.8,4.7
16684.0,2.4
2834.3,3.7
17504.9,2.9
1024.0,6.5
678.7,6.3
851.2,4.7
281.3,8.5
15018.9,2.6
774.6,6.8
2819.1,4.1
3302.5,4.0
2339.7,4.7
101.6,9.0
39324.6,1.3
23809.9,1.0
350.8,7.2
586.0,7.5
2318.3,4.7
23321.3,2.0
38219.7,0.4
474.4,5.6
3031.0,3.9
13137.2,2.3
1084.7,5.7
8303.4,3.2
264.8,8.4
3775.6,4.1
18755.1,2.9
38194.5,1.2
161.6,8.9
1332.1,4.0
344.3,6.6
1524.2,5.9
2741.7,4.4
175.8,8.5
601.6,6.6
27236.5,2.3
3117.3,4.7
1587.9,5.6
9510.5,4.0
8863.0,3.7
134.1,8.8
7253.0,3.3
15967.3,1.9
272.7,6.8
11228.5,3.3
565.2,4.7
637.6,5.3
5578.1,2.9
196.1,7.5
5565.0,1.8
21421.8,2.9
6729.7,3.8
1432.1,6.7
1413.9,6.0
10199.5,3.6
3054.6,5.9
167.1,7.5
3385.8,3.2
13777.7,2.3
767.2,5.4
27235.2,1.5
9350.4,2.2
3214.2,4.7
9402.9,3.3
161.4,7.9
18035.2,2.4
14343.7,2.4
24470.9,2.3
217.6,7.6
163.9,7.7
230.9,8.1
1118.1,6.4
1299.9,6.3
2992.1,3.7
209.4,7.2
337.9,5.8
13513.8,2.4
1692.7,5.4
13214.4,2.5
104.6,9.0
2805.9,4.2
27961.8,0.9
3375.7,4.6
347.6,7.1
7661.3,3.6
988.4,5.9
5684.4,3.8
119.4,6.8
4670.9,3.3
121.5,7.9
9020.8,2.8
1743.9,4.7
208.8,7.9
2658.0,4.9
149.7,7.2
5191.0,4.2
41208.5,1.6
10468.1,3.2
3208.5,3.3
186.0,8.1
6874.6,3.4
5441.7,4.3
134.6,9.0
12022.4,3.8
2300.2,4.8
1312.2,5.4
11727.3,3.1
1203.6,4.7
1831.6,3.9
299.8,6.8
697.5,7.0
16586.1,2.1
309.5,8.2
1245.9,3.5
39488.8,0.1
418.0,6.7
25522.6,2.4
25765.2,1.7
173.7,7.8
1649.0,5.0
2081.8,3.6
666.0,7.0
133.1,7.7
431.0,7.5
178.2,7.7
422.2,7.5
13202.7,2.8
22364.1,1.8
129.9,8.3
620.4,5.2
37521.8,1.3
2608.2,5.7
4407.8,4.8
103.4,7.8
1875.1,5.3
39320.6,1.4
966.0,6.3
179.8,7.9
1631.7,4.9
33739.5,2.4
789.6,6.1
12513.6,3.5
12507.8,3.3
352.1,6.7
1458.7,5.1
7562.1,4.6
1196.0,5.6
317.3,6.6
34667.7,0.5
5109.6,4.4
18709.3,2.3
116.5,7.8
502.0,7.0
2080.0,4.9
150.3,6.8
40454.9,1.6
417.6,7.7
960.8,7.5
364.6,7.0
189.2,7.9
407.7,7.9
615.4,6.4
4630.0,4.0
547.4,6.0
893.5,4.9
103.7,9.0
912.2,4.9
2521.1,5.4
266.3,6.8
3701.8,4.3
588.3,6.1
4563.5,4.7
117.2,8.5
21387.7,3.3
110.2,7.6
215.4,7.9
10971.2,2.8
132.0,8.4
7354.6,4.4
35420.1,1.8
19426.5,1.3
7317.4,3.7
32835.1,1.2
1343.9,5.0
19567.5,2.8
860.0,5.5
27597.7,1.4
245.8,7.4
29364.4,2.3
15349.6,2.8
16638.5,2.1
211.5,7.4
3680.7,3.3
110.4,7.8
7821.6,2.7
104.8,8.3
167.0,9.0
390.8,6.4
19834.9,1.9
900.5,4.4
2615.4,5.0
3100.4,3.2
390.8,6.2
3177.1,5.0
5434.6,2.2
606.7,6.4
1256.0,6.0
1547.0,6.2
28032.6,1.0
3486.0,3.7
30861.0,2.8
2882.3,4.4
2061.1,4.3
102.2,8.0
1830.0,4.3
27215.2,1.4
331.7,7.8
137.0,8.7
1169.2,4.7
949.8,5.9
17793.1,1.9
117.5,8.9
26039.5,1.6
6131.2,3.8
23649.9,1.7
3934.8,2.5
13539.1,2.6
760.1,5.1
827.4,6.5
1055.7,5.2
9583.8,2.5
932.1,5.8
432.4,7.1
28948.4,1.5
24197.3,3.0
823.5,7.1
4635.4,5.0
523.5,6.3
347.6,5.9
763.8,6.9
722.3,5.8
20711.2,2.0
14413.3,2.9
7293.7,2.2
33001.3,2.6
1286.1,6.0
439.8,6.9
203.3,8.3
617.1,6.7
240.6,7.5
174.6,7.6
3827.0,3.6
903.8,6.0
3034.9,4.6
317.9,7.9
5984.9,3.7
367.9,6.3
536.9,5.4
8857.6,3.0
2947.5,4.4
756.9,6.0
2663.7,3.4
6635.8,4.2
24807.6,2.5
3346.0,3.7
408.2,7.4
9125.9,3.7
11011.5,2.8
335.8,6.4
14263.3,3.6
1661.8,5.3
11145.3,2.6
420.2,7.3
746.6,7.2
31893.6,1.1
5332.6,4.1
10690.7,4.2
6414.5,2.7
343.8,6.6
1720.6,4.6
13296.6,2.4
5917.6,3.4
103.7,8.7
169.6,7.3
813.6,5.5
30144.4,1.8
1947.6,5.0
512.0,7.1
883.5,6.1
357.3,7.5
1275.7,4.6
373.6,6.6
16608.1,3.6"
                    marathon_data <- read.csv(text = marathon_csv)
                    meters_run <- marathon_data$meters_run
                    opinion <- marathon_data$opinion
                `);
                console.log('Marathon Opinion data preloaded!');

                // Preload Beer Price vs Evaluation dataset
                await shelter.captureR(`
                    beer_csv <- "avg_price,overall
16.95,1.346
10.28,1.081
17.81,1.079
41.98,1.024
10.47,1.022
32.21,0.927
10.15,0.917
10.75,0.89
16.31,0.888
11.45,0.879
11.27,0.872
10.53,0.806
8.77,0.772
19.79,0.749
11.56,0.735
4.72,0.729
41.03,0.723
15.05,0.719
12.99,0.69
18.25,0.684
10.23,0.674
11.03,0.646
8.16,0.634
9.4,0.631
13.05,0.628
14.8,0.619
8.95,0.616
12.09,0.598
8.89,0.594
8.7,0.589
9.37,0.567
18.17,0.559
13.55,0.539
18.38,0.507
11.7,0.507
11.02,0.506
9.86,0.504
8.79,0.482
11.34,0.482
9.29,0.481
11.08,0.475
7.68,0.47
23.69,0.47
9.97,0.469
10.39,0.462
17.54,0.458
15.91,0.456
12.48,0.437
9.91,0.433
13.83,0.428
8.47,0.427
26.26,0.4
10.7,0.394
10.6,0.39
13.35,0.384
9.04,0.378
10.8,0.368
9.81,0.368
7.15,0.356
22.93,0.35
64.21,0.345
10.45,0.342
9.49,0.338
55.13,0.337
13.55,0.335
5.3,0.323
8.48,0.319
11.55,0.293
20.79,0.29
11.69,0.28
9.75,0.272
21.07,0.258
8.96,0.254
19.93,0.252
13.93,0.248
18.89,0.245
8.28,0.244
9.81,0.233
9.79,0.213
13.11,0.2
22.92,0.199
9.01,0.195
16.03,0.194
13.75,0.181
10.95,0.173
11.39,0.173
17.24,0.17
57.25,0.169
12.2,0.166
9.62,0.164
8.66,0.15
8.17,0.149
9.44,0.146
11.5,0.143
11.69,0.139
8.79,0.139
12.38,0.138
13.36,0.135
11.56,0.111
9.5,0.107
14.86,0.104
5.73,0.092
19.79,0.09
9.2,0.089
29.62,0.087
15.78,0.086
11.15,0.084
13.09,0.084
9.48,0.082
15.64,0.077
44.29,0.076
15.24,0.066
9.04,0.063
10.06,0.063
8.98,0.06
11.94,0.058
10.27,0.05
8.66,0.044
12.6,0.038
8.5,0.034
9.58,0.031
4.35,0.023
20.02,-0.014
19.46,-0.044
7.8,-0.046
7.79,-0.058
12.33,-0.059
55.92,-0.061
25.22,-0.063
12.12,-0.071
5.6,-0.076
8.85,-0.084
11.25,-0.089
3.67,-0.09
9.94,-0.097
10.14,-0.097
11.81,-0.099
9.19,-0.113
8.54,-0.113
10.18,-0.115
8.32,-0.122
18.43,-0.138
6.23,-0.141
21.48,-0.146
10.19,-0.152
5.24,-0.163
6.63,-0.175
8.78,-0.175
9.28,-0.182
14.29,-0.183
30.41,-0.188
13.59,-0.192
15.97,-0.193
13.73,-0.195
13.98,-0.201
9.4,-0.215
16.95,-0.215
17.53,-0.222
13.53,-0.236
20.82,-0.236
12.39,-0.243
8.97,-0.244
15.79,-0.244
8.7,-0.251
9.97,-0.252
13.02,-0.259
10.72,-0.26
16.29,-0.26
9.53,-0.265
8.42,-0.267
13.73,-0.268
16.38,-0.271
10.9,-0.272
10.39,-0.277
41.13,-0.288
14.75,-0.3
4.04,-0.315
10.75,-0.332
11.08,-0.338
11.32,-0.351
10.48,-0.354
7.08,-0.36
10.13,-0.364
11.17,-0.364
19.04,-0.419
10.24,-0.421
10.29,-0.43
7.88,-0.434
11.5,-0.447
10.55,-0.468
14.32,-0.472
15.69,-0.484
16.36,-0.488
9.38,-0.501
9.1,-0.539
12.95,-0.544
8.9,-0.57
36.5,-0.575
13.56,-0.579
12.37,-0.58
19.73,-0.596
12.53,-0.676
9,-0.678
7.16,-0.736
7.04,-0.744
14.09,-0.765
12.88,-0.801
7.2,-0.82
6.34,-0.847
2.47,-0.887
2.53,-0.934
15.48,-0.956
2.83,-0.995
12.57,-1.006
12.42,-1.02
2.1,-1.045
16.03,-1.069
12.45,-1.151
8.71,-1.166
16.85,-1.203
12,-1.245
18.77,-1.306
8.93,-1.376
16.41,-1.382
30.86,-1.414
6.68,-1.427
8.25,-1.529
1.87,-1.736"
                    beer_data <- read.csv(text = beer_csv)
                    avg_price <- beer_data$avg_price
                    overall <- beer_data$overall
                `);
                console.log('Beer data preloaded!');

                // Preload hotel data
                await shelter.evalR(`
                    hotel_csv <- "hotel_cost,fun_reported,humidity
258,5.3,70.8
157,5.6,44.0
459,7.3,38.1
202,6.2,32.8
152,3.6,37.8
339,10.0,58.9
409,6.9,84.7
201,5.1,63.5
405,6.3,99.0
280,5.7,33.0
393,7.7,62.4
355,10.0,46.4
201,4.3,82.1
57,6.6,29.9
290,5.7,80.8
310,6.6,58.0
492,7.4,78.7
176,5.8,50.5
468,7.3,90.8
141,4.4,79.7
151,3.1,37.5
408,10.0,42.9
393,8.8,55.3
452,7.2,80.1
243,7.1,43.3
314,6.0,72.9
119,5.3,80.8
88,2.8,34.8
409,7.6,53.6
323,5.5,97.3
431,7.0,68.4
313,5.5,81.3
283,6.4,53.3
496,6.2,30.6
158,3.2,58.3
356,6.5,63.1
73,4.0,94.1
385,6.9,63.3
107,4.4,66.5
112,4.3,26.6
307,6.9,89.0
113,5.0,65.9
66,4.2,36.3
280,2.0,35.2
203,1.0,46.3
346,8.2,52.0
454,6.2,75.2
113,4.5,64.8
473,7.7,71.1
130,6.1,41.5
361,7.5,32.0
347,2.7,53.3
434,4.7,28.8
123,9.9,57.9
217,2.3,44.6
169,8.1,49.7
455,4.7,26.2
122,3.8,92.4
92,7.2,29.3
100,4.0,67.4
212,3.3,35.5
473,5.2,29.2
113,3.3,57.5
227,4.9,27.6
331,5.2,61.6
68,1.0,40.1
179,5.1,37.7
466,6.6,27.3
310,9.3,36.6
212,6.0,56.2
267,4.4,90.9
366,5.9,31.5
349,4.8,31.9
178,5.0,96.4
429,6.2,98.0
57,6.9,52.0
342,4.2,27.6
224,7.3,43.0
274,6.0,99.4
138,6.4,35.9
122,3.3,36.4
341,5.2,98.0
432,5.6,59.5
278,6.5,68.5
454,6.2,43.2
445,7.7,71.1
104,4.5,78.5
300,6.3,28.4
407,7.0,78.4
384,6.4,84.9
124,5.2,70.3
307,3.9,33.0
103,3.6,66.8
220,5.3,66.1
159,1.3,40.4
451,6.6,37.5
301,5.9,97.8
459,7.3,77.9
160,3.4,50.5
107,6.6,35.0
162,5.5,85.1
342,4.2,55.1
92,3.3,36.8
396,6.3,78.0
479,10.0,50.0
196,7.2,29.9
54,5.5,57.3
126,2.5,56.8
458,7.4,67.7
309,6.2,94.5
117,4.1,74.8
417,6.0,99.2
134,4.5,99.5
132,5.0,91.3
190,4.1,92.0
327,6.8,35.1
180,3.4,64.5
374,6.0,61.5
106,4.2,96.2
101,1.8,31.0
325,7.0,74.3
124,4.2,78.4
349,5.4,79.7
89,5.4,87.9
386,6.6,67.3
401,8.4,31.5
166,9.0,58.8
301,5.1,33.7
65,4.3,94.9
213,5.9,92.9
415,6.4,56.4
316,8.4,35.2
484,7.3,25.9
157,2.9,46.0
153,4.4,78.5
396,10.0,46.3
294,4.0,49.6
494,2.4,30.5
159,5.3,30.5
235,3.8,93.5
286,5.7,93.7
107,4.8,74.8
471,8.3,39.4
215,5.6,53.5
94,4.9,27.7
332,6.3,67.1
454,2.3,56.3
195,5.7,65.4
379,7.3,73.9
147,2.7,42.6
295,5.9,66.9
455,7.2,79.0
262,4.9,65.5
88,1.2,52.1
339,5.4,70.1
488,8.8,52.0
307,6.1,94.0
216,6.5,25.7
248,5.7,65.1
134,4.3,65.2
343,7.2,54.0
196,5.1,98.2
461,4.7,28.9
230,5.8,69.7
86,4.1,98.8
316,7.3,59.0
61,3.8,47.3
127,6.1,99.9
449,7.4,44.1
118,4.8,61.6
325,5.7,73.1
439,7.7,94.6
294,6.5,95.8
227,4.1,63.0
386,8.2,53.1
223,5.1,86.7
235,5.9,60.6
67,6.5,33.8
161,4.1,75.1
115,9.9,50.6
128,4.5,83.8
370,8.7,34.8
219,7.0,29.2
272,5.8,27.2
285,6.2,73.2
420,6.1,89.9
312,6.7,86.9
378,6.3,49.8
414,9.0,53.3
229,5.8,70.9
495,8.5,76.1
486,8.5,62.3
361,8.5,34.5
351,6.4,82.2
472,5.0,45.7
207,3.7,48.2
258,5.3,65.6
440,7.0,36.1
468,9.2,42.3
385,6.3,92.6
134,5.7,43.4
484,7.6,77.5
335,3.2,54.1
292,6.7,81.4
445,4.0,58.2
79,3.6,95.1
323,5.7,45.9
176,4.9,69.9
276,5.0,39.9
186,5.3,85.6
157,3.8,94.6
329,5.8,68.3
244,4.9,87.4
110,4.0,82.4
64,7.7,58.7
317,6.4,83.3
414,7.6,61.2
462,4.7,51.6
270,7.3,46.0
182,8.7,43.9
91,3.1,31.4
206,6.8,81.3
211,4.5,85.3
154,4.9,95.9
100,4.3,76.6
318,6.4,68.5
494,7.2,76.7
96,4.9,61.8
418,5.8,35.7
163,4.3,80.5
485,9.0,40.0
203,5.7,34.1
166,4.2,100.0
362,5.8,88.5
417,7.9,65.2
451,7.6,74.1
314,7.0,72.4
291,5.0,32.4
229,5.0,79.4
433,9.4,36.0
408,6.7,97.1
418,6.7,92.5
285,6.3,26.3
472,6.6,80.6
210,5.2,84.5
383,3.1,55.5
468,7.0,83.6
424,7.3,75.7
276,7.8,46.8
207,5.1,74.0
306,6.6,96.8
405,6.2,87.6
445,8.1,69.6
306,7.5,32.0
178,6.0,66.0
445,3.5,47.2
260,5.9,43.2
352,4.7,27.0
364,4.6,53.1
276,6.4,73.8
375,5.8,36.4
278,5.3,69.1
426,5.3,31.4
377,6.7,35.9
128,2.8,52.5
52,3.5,26.6
420,10.0,42.4
340,6.5,56.1
132,4.9,64.3
159,4.9,86.9
241,5.2,84.2
165,5.3,90.2
408,8.8,55.2
330,4.1,26.8
290,5.4,74.6
357,5.7,84.8
334,9.0,29.1
375,5.7,89.9
96,5.1,28.1
119,6.1,60.8
335,7.4,56.8
183,5.2,26.1
204,4.1,92.2
335,8.4,58.9
223,3.7,47.3
119,4.6,61.1
363,5.0,51.4
80,4.6,75.9
451,6.8,39.6
288,9.5,48.9
340,9.4,41.0
454,7.2,42.3
193,4.7,42.8
297,4.4,38.6
392,6.3,88.2
366,7.8,25.2
194,9.5,35.6
476,7.4,75.1
102,4.2,84.7
92,4.3,25.2"
                    hotel_data <- read.csv(text = hotel_csv)
                    hotel_cost <- hotel_data$hotel_cost
                    fun_reported <- hotel_data$fun_reported
                    humidity <- hotel_data$humidity
                `);
                console.log('Hotel data preloaded!');

                // Enable all run buttons
                smartPlots.forEach(sp => {
                    const btn = document.getElementById(sp.runBtn);
                    const statusEl = document.getElementById(sp.status);
                    if (btn) btn.disabled = false;
                    if (statusEl) {
                        statusEl.textContent = '✓ Ready! Click Run to execute the R code.';
                        statusEl.className = 'sp-status success';
                    }
                });
            } catch (err) {
                console.error('WebR init failed:', err);
                smartPlots.forEach(sp => {
                    const statusEl = document.getElementById(sp.status);
                    if (statusEl) {
                        statusEl.textContent = '✗ Init failed: ' + (err.message || err);
                        statusEl.className = 'sp-status error';
                    }
                });
            }
        }

        // Set up click handlers for each smart plot
        smartPlots.forEach((sp, idx) => {
            const runBtn = document.getElementById(sp.runBtn);
            const editor = document.getElementById(sp.editor);
            const output = document.getElementById(sp.output);
            const status = document.getElementById(sp.status);

            if (!runBtn || !editor || !output || !status) return;

            runBtn.addEventListener('click', async () => {
                if (sp.isShowingPlot) {
                    editor.classList.remove('hidden');
                    output.classList.remove('active', 'text-output');
                    output.innerHTML = '';
                    runBtn.querySelector('.icon').textContent = '▶';
                    runBtn.querySelector('.label').textContent = 'Run';
                    sp.isShowingPlot = false;
                    return;
                }

                if (!shelter) {
                    status.textContent = '⏳ WebR still loading, please wait...';
                    status.className = 'sp-status loading';
                    return;
                }

                runBtn.disabled = true;
                status.innerHTML = '<span class="loader"></span>Executing R code...';
                status.className = 'sp-status loading';

                try {
                    const code = editor.value;

                    const result = await shelter.captureR(code, {
                        captureGraphics: { width: 1200, height: 750, bg: 'white' },
                        withAutoprint: true
                    });

                    // Collect text output - each chunk is typically a line
                    let outputLines = [];
                    if (result.output && result.output.length > 0) {
                        for (const out of result.output) {
                            if (out.type === 'stdout' || out.type === 'stderr') {
                                outputLines.push(out.data);
                            }
                        }
                    }
                    // Join with newlines since WebR chunks don't include them
                    let textOutput = outputLines.join('\n');
                    // Normalize any existing line endings
                    textOutput = textOutput.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                    if (result.images && result.images.length > 0) {
                        output.innerHTML = '';
                        output.classList.remove('text-output');
                        const img = result.images[result.images.length - 1];
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                        output.appendChild(canvas);

                        editor.classList.add('hidden');
                        output.classList.add('active');
                        runBtn.querySelector('.icon').textContent = '✎';
                        runBtn.querySelector('.label').textContent = 'Edit';
                        sp.isShowingPlot = true;
                        status.textContent = '✓ Plot rendered! Click Edit to modify code.';
                        status.className = 'sp-status success';
                    } else if (textOutput.trim()) {
                        // Show text output if no plot
                        const pre = document.createElement('pre');
                        pre.className = 'r-text-output';
                        pre.appendChild(document.createTextNode(textOutput));
                        output.innerHTML = '';
                        output.appendChild(pre);

                        editor.classList.add('hidden');
                        output.classList.add('active', 'text-output');
                        runBtn.querySelector('.icon').textContent = '✎';
                        runBtn.querySelector('.label').textContent = 'Edit';
                        sp.isShowingPlot = true;
                        status.textContent = '✓ Code executed! Click Edit to modify code.';
                        status.className = 'sp-status success';
                    } else {
                        status.textContent = 'Code ran but produced no output.';
                        status.className = 'sp-status';
                    }
                } catch (err) {
                    console.error(err);
                    status.textContent = '✗ Error: ' + (err.message || err).toString().substring(0, 80);
                    status.className = 'sp-status error';
                }
                runBtn.disabled = false;
            });
        });

        initWebR().catch(err => {
            smartPlots.forEach(sp => {
                const statusEl = document.getElementById(sp.status);
                if (statusEl) {
                    statusEl.textContent = '✗ WebR failed: ' + err.message;
                    statusEl.className = 'sp-status error';
                }
            });
        });
    </script>
</body>
</html>
